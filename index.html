<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hospital de Emerg√™ncia ‚Äî Treino Interativo</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: dark; }
    html, body { height: auto; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Visual */
    .glass { background: rgba(15, 23, 42, 0.55); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.18); }
    .card  { background: rgba(2, 6, 23, 0.62); border: 1px solid rgba(148, 163, 184, 0.16); }
    .btn-big { padding: 16px 18px; border-radius: 16px; font-weight: 800; letter-spacing: 0.2px; }
    .btn-ghost { background: rgba(30, 41, 59, 0.55); border: 1px solid rgba(148, 163, 184, 0.18); }
    .btn-ghost:hover { background: rgba(51, 65, 85, 0.6); }
    .btn-primary { background: linear-gradient(135deg, rgba(34, 211, 238, 0.92), rgba(99, 102, 241, 0.92)); }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-danger { background: linear-gradient(135deg, rgba(248, 113, 113, 0.95), rgba(244, 63, 94, 0.95)); }
    .btn-warning { background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95)); }
    .btn-ok { background: linear-gradient(135deg, rgba(74, 222, 128, 0.95), rgba(16, 185, 129, 0.95)); }
    .ring-soft { box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.18), 0 0 0 8px rgba(99, 102, 241, 0.10); }
    .mono { font-feature-settings: "tnum" 1, "lnum" 1; font-variant-numeric: tabular-nums; }

    /* Single scroll: remove internal scroll areas */
    .no-internal-scroll { overflow: visible !important; }
    main { overflow: visible !important; }

    /* Toast / Mascote */
    #toastArea { position: fixed; inset: auto 0 22px 0; display: flex; justify-content: center; pointer-events: none; z-index: 60; }
    .toast { pointer-events: none; max-width: 920px; width: calc(100% - 24px); border-radius: 18px; padding: 14px 16px; }

    .pop-center {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      z-index: 70; pointer-events: none;
    }
    .pop-card {
      transform: translateY(10px) scale(0.98);
      opacity: 0;
      transition: transform .22s ease, opacity .22s ease;
      border-radius: 26px;
      padding: 18px 22px;
      background: rgba(2, 6, 23, 0.78);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
    }
    .pop-center.show { display: flex; }
    .pop-center.show .pop-card { transform: translateY(0) scale(1); opacity: 1; }

    /* Modal */
    #modal { display:none; }
    #modal.show { display:block; }

    /* Focus outlines */
    button:focus { outline: none; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-slate-900"></div>
    <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full blur-3xl opacity-30 bg-cyan-400"></div>
    <div class="absolute top-40 -right-24 h-80 w-80 rounded-full blur-3xl opacity-25 bg-indigo-500"></div>
    <div class="absolute bottom-0 left-1/3 h-72 w-72 rounded-full blur-3xl opacity-20 bg-emerald-500"></div>
  </div>

  <!-- Mobile top bar -->
  <header class="lg:hidden sticky top-0 z-40 glass">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <button id="btnToggleSidebar" class="btn-big btn-ghost ring-soft flex items-center gap-3" type="button">
        <span class="text-xl">üß≠</span>
        <span class="text-base font-extrabold">Menu</span>
      </button>

      <div class="flex items-center gap-3">
        <div class="px-3 py-2 rounded-2xl card mono">
          <div class="text-xs text-slate-300">Score</div>
          <div class="text-lg font-extrabold" id="scoreHeader">0</div>
        </div>
        <button id="btnQuickReset" class="btn-big btn-danger flex items-center gap-2" type="button">
          ‚ôªÔ∏è <span>Reset</span>
        </button>
      </div>
    </div>
  </header>

  <div class="flex no-internal-scroll">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-[320px] shrink-0 hidden lg:flex flex-col gap-3 p-4 glass border-r border-slate-700/30 sticky top-0 h-screen">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-2xl font-extrabold tracking-tight">üè• Emerg√™ncia ‚Äî Treino</div>
          <div class="text-slate-300 text-sm leading-snug mt-1">
            Simula√ß√µes e pr√°tica para equipe multiprofissional.
          </div>
        </div>
        <button id="btnResetAll" class="btn-big btn-danger flex items-center gap-2" type="button" title="Apagar progresso">
          üßπ <span>Limpar</span>
        </button>
      </div>

      <div class="card rounded-3xl p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm text-slate-300">Aluno</div>
            <div class="text-lg font-extrabold" id="userNameLabel">Aluno</div>
          </div>
          <button id="btnChangeName" class="btn-big btn-ghost" type="button">‚úèÔ∏è Nome</button>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-4">
          <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3 mono">
            <div class="text-xs text-slate-300">Score</div>
            <div class="text-2xl font-extrabold" id="scoreSidebar">0</div>
          </div>
          <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3 mono">
            <div class="text-xs text-slate-300">Acerto</div>
            <div class="text-2xl font-extrabold" id="accuracySidebar">0%</div>
          </div>
        </div>

        <div class="mt-3 text-xs text-slate-300 leading-relaxed">
          Use o bot√£o <b>Ajuda</b> dentro de cada m√≥dulo se precisar (sem entregar resposta).
        </div>
      </div>

      <nav class="card rounded-3xl p-3">
        <div class="text-xs text-slate-300 px-2 pb-2">M√≥dulos</div>
        <div class="grid gap-2">
          <button class="navBtn btn-big btn-primary flex items-center justify-between" data-view="dashboard" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üßë‚Äç‚öïÔ∏è</span> Painel</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="triage" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üö¶</span> Triagem (ABCDE)</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="cases" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üìã</span> Casos Cl√≠nicos</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="quiz" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üß†</span> Quiz</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="checklists" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">‚úÖ</span> Checklists (V/F)</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="ppe" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üß§</span> EPIs por procedimento</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="path" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üß©</span> Patologias & Interven√ß√µes</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="review" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üìö</span> Revis√£o</span><span>‚Üí</span>
          </button>
        </div>
      </nav>

      <div class="card rounded-3xl p-3">
        <div class="grid grid-cols-2 gap-2">
          <button id="btnSound" class="btn-big btn-ghost flex items-center justify-center gap-2" type="button">
            üîä <span>Som</span>
          </button>
          <button id="btnFocus" class="btn-big btn-ghost flex items-center justify-center gap-2" type="button">
            ‚ú® <span>Foco</span>
          </button>
        </div>
      </div>

      <div class="text-xs text-slate-400 leading-relaxed px-1">
        Progresso fica salvo neste navegador.
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-4 lg:p-8 no-internal-scroll">
      <div class="hidden lg:block mb-6">
        <div class="glass rounded-3xl p-5">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-sm text-slate-300">Hospital de Emerg√™ncia ‚Äî Plataforma Interativa</div>
              <div class="text-3xl font-extrabold tracking-tight leading-tight" id="pageTitle">Painel</div>
              <div class="text-slate-300 text-sm mt-2 max-w-3xl" id="pageSubtitle">
                Treine prioridades, decis√µes e rotinas com feedback imediato.
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="card rounded-3xl p-4 mono min-w-[150px]">
                <div class="text-xs text-slate-300">Score</div>
                <div class="text-3xl font-extrabold" id="scoreTop">0</div>
              </div>
              <div class="card rounded-3xl p-4 mono min-w-[150px]">
                <div class="text-xs text-slate-300">Acerto</div>
                <div class="text-3xl font-extrabold" id="accuracyTop">0%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <section id="viewContainer" class="space-y-6"></section>

      <footer class="mt-10 text-xs text-slate-400 leading-relaxed">
        <div class="card rounded-3xl p-4">
          <div class="font-extrabold text-slate-200">üß∑ Aviso</div>
          <div class="mt-2">
            Material educacional para simula√ß√£o. Condutas reais dependem de protocolo institucional e avalia√ß√£o do paciente.
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Toasts -->
  <div id="toastArea" aria-live="polite" aria-atomic="true"></div>

  <!-- Mascote central -->
  <div id="popCenter" class="pop-center" aria-hidden="true">
    <div class="pop-card">
      <div class="flex items-center gap-4">
        <div class="text-6xl" id="popIcon">üßë‚Äçüöí</div>
        <div>
          <div class="text-2xl font-extrabold" id="popTitle">Boa!</div>
          <div class="text-slate-300" id="popText">Voc√™ ganhou pontos.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-50" aria-hidden="true">
    <div class="absolute inset-0 bg-black/60" id="modalBackdrop"></div>
    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="card rounded-3xl w-full max-w-2xl p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold" id="modalTitle">T√≠tulo</div>
            <div class="text-slate-300 mt-1" id="modalSubtitle">Texto</div>
          </div>
          <button id="modalClose" class="btn-big btn-ghost" type="button">‚úñÔ∏è Fechar</button>
        </div>
        <div class="mt-4" id="modalBody"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const LS_KEY = "hospital_emergencia_v2";

  const stateDefault = {
    userName: "Aluno",
    score: 0,
    correct: 0,
    wrong: 0,
    sound: true,
    focusMode: false,
    seenQuestionIds: [],
    seenCaseIds: [],
    seenChecklistIds: [],
    reviewLog: [],
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(stateDefault);
      const parsed = JSON.parse(raw);
      return { ...structuredClone(stateDefault), ...parsed };
    } catch(e){
      return structuredClone(stateDefault);
    }
  }

  let appState = loadState();

  const el = (id) => document.getElementById(id);

  // Simple sound
  const audioCtx = { ctx: null };
  function beep(freq=660, ms=90){
    if(!appState.sound) return;
    try{
      if(!audioCtx.ctx) audioCtx.ctx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioCtx.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = freq;
      g.gain.value = 0.06;
      o.start();
      setTimeout(()=>o.stop(), ms);
    } catch(e){}
  }

  function escapeHtml(str){
    return (""+str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toast(type, title, message){
    const area = el("toastArea");
    const box = document.createElement("div");
    box.className = "toast glass";
    const icon = type === "ok" ? "‚úÖ" : type === "warn" ? "‚ö†Ô∏è" : type === "bad" ? "‚ùå" : "‚ÑπÔ∏è";
    box.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="text-2xl">${icon}</div>
        <div class="flex-1">
          <div class="font-extrabold">${escapeHtml(title)}</div>
          <div class="text-slate-200/90 text-sm mt-1 leading-relaxed">${escapeHtml(message)}</div>
        </div>
      </div>
    `;
    area.appendChild(box);
    setTimeout(()=>{ box.style.opacity="0"; box.style.transform="translateY(6px)"; box.style.transition="all .18s ease"; }, 2600);
    setTimeout(()=>box.remove(), 3000);
  }

  function popCenter(title, text, ms=5000){
    const pc = el("popCenter");
    el("popIcon").textContent = "üßë‚Äçüöí";
    el("popTitle").textContent = title;
    el("popText").textContent = text;
    pc.classList.add("show");
    pc.setAttribute("aria-hidden","false");
    setTimeout(()=>{
      pc.classList.remove("show");
      pc.setAttribute("aria-hidden","true");
    }, ms);
  }

  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(appState));
    renderScoreWidgets();
  }

  function accuracy(){
    const total = appState.correct + appState.wrong;
    if(total === 0) return 0;
    return Math.round((appState.correct / total) * 100);
  }

  function addReview(entry){
    appState.reviewLog.unshift({ t: new Date().toISOString(), ...entry });
    if(appState.reviewLog.length > 250) appState.reviewLog.pop();
    saveState();
  }

  function addScore(delta, why){
    appState.score = Math.max(0, appState.score + delta);
    addReview({ type:"score", delta, why });
    saveState();
  }

  function resetProgress(){
    const keepName = appState.userName || "Aluno";
    appState = structuredClone(stateDefault);
    appState.userName = keepName;
    saveState();
    toast("warn","Progresso apagado","Score e hist√≥rico foram reiniciados neste navegador.");
    go("dashboard");
  }

  function renderScoreWidgets(){
    const s = appState.score;
    const acc = accuracy();
    ["scoreHeader","scoreSidebar","scoreTop"].forEach(id => { if(el(id)) el(id).textContent = s; });
    ["accuracySidebar","accuracyTop"].forEach(id => { if(el(id)) el(id).textContent = `${acc}%`; });
    if(el("userNameLabel")) el("userNameLabel").textContent = appState.userName || "Aluno";
  }

  // --------- DATA: Specialties / Topics ----------
  const SPECIALTIES = [
    { key:"MIX",  label:"üåê Mesclado (tudo)" },
    { key:"ENF",  label:"ü©∫ Enfermagem" },
    { key:"FISIO", label:"ü´Å Fisioterapia" },
    { key:"TEC",  label:"üßæ T√©cnico de Enfermagem" },
    { key:"MULTI", label:"ü§ù Multiprofissional" },
  ];

  // Question structure:
  // {id, topic, specialty: ["ENF","FISIO","TEC","MULTI"], level(1-3), q, options[], answerIndex, rationale, source}
  const QUESTION_BANK = [
    // ABCDE / Emerg√™ncia
    {id:"q_abcd_01", topic:"ABCDE", specialty:["MULTI","ENF","TEC"], level:1,
      q:"No ABCDE, a prioridade inicial (A) √©:",
      options:["Avaliar perfus√£o", "Garantir via a√©rea e prote√ß√£o cervical quando indicado", "Avaliar Glasgow", "Checar temperatura"],
      answerIndex:1,
      rationale:"A = Airway. Sinais de via a√©rea amea√ßada exigem a√ß√£o imediata antes de qualquer etapa subsequente.",
      source:"Base conceitual: atendimento prim√°rio/ABCDE (emerg√™ncia e trauma)."
    },
    {id:"q_abcd_02", topic:"ABCDE", specialty:["MULTI","ENF","TEC"], level:1,
      q:"Sinal cl√°ssico de risco de obstru√ß√£o alta de via a√©rea:",
      options:["Estridor", "Diurese aumentada", "Edema em MMII", "Sopro card√≠aco"],
      answerIndex:0,
      rationale:"Estridor sugere obstru√ß√£o de via a√©rea superior e risco de deteriora√ß√£o r√°pida.",
      source:"Base: avalia√ß√£o de via a√©rea em emerg√™ncia."
    },
    {id:"q_abcd_03", topic:"ABCDE", specialty:["MULTI","ENF","FISIO"], level:2,
      q:"Paciente com SpO‚ÇÇ 84% em ar ambiente e esfor√ßo respirat√≥rio. Melhor a√ß√£o imediata:",
      options:["Solicitar TC e aguardar", "Iniciar oxig√™nio e avaliar ventila√ß√£o/padr√£o respirat√≥rio", "Aguardar antibi√≥tico", "Apenas analgesia e observar"],
      answerIndex:1,
      rationale:"No 'B' (Breathing), suporte de oxigena√ß√£o/ventila√ß√£o e avalia√ß√£o r√°pida (FR, padr√£o, ausculta) t√™m prioridade.",
      source:"Base: abordagem ABCDE e manejo inicial de insufici√™ncia respirat√≥ria."
    },

    // Sepse
    {id:"q_sepse_01", topic:"Sepse", specialty:["MULTI","ENF","TEC","FISIO"], level:1,
      q:"Em suspeita de sepse, uma a√ß√£o cr√≠tica nas primeiras horas √©:",
      options:["Aguardar resultado de cultura por 24h", "Iniciar antibi√≥tico oportuno e medidas do bundle conforme protocolo", "Evitar acesso venoso", "Suspender monitoriza√ß√£o"],
      answerIndex:1,
      rationale:"Sepse √© tempo-dependente: antibi√≥tico oportuno, avalia√ß√£o de perfus√£o e interven√ß√µes iniciais aumentam chance de desfecho favor√°vel.",
      source:"Diretrizes: Surviving Sepsis Campaign (conceitos de bundle)."
    },
    {id:"q_sepse_02", topic:"Sepse", specialty:["MULTI","ENF"], level:2,
      q:"Ap√≥s reposi√ß√£o inicial conforme protocolo, o paciente mant√©m hipotens√£o. Pr√≥ximo passo prov√°vel:",
      options:["Considerar vasopressor para alvo de PAM e perfus√£o", "Diur√©tico de al√ßa imediato", "Alta imediata", "Suspender avalia√ß√£o"],
      answerIndex:0,
      rationale:"Quando hipotens√£o persiste ap√≥s volume inicial, vasopressor pode ser necess√°rio para manter perfus√£o adequada (de acordo com protocolo institucional).",
      source:"Diretrizes: Surviving Sepsis (choque s√©ptico, suporte hemodin√¢mico)."
    },
    {id:"q_sepse_03", topic:"Sepse", specialty:["MULTI","ENF"], level:3,
      q:"Marcador associado √† hipoperfus√£o e maior gravidade na sepse:",
      options:["Lactato elevado", "S√≥dio normal", "Temperatura 36,5¬∞C", "Hemat√≥crito est√°vel"],
      answerIndex:0,
      rationale:"Lactato elevado √© marcador de hipoperfus√£o e se correlaciona com gravidade; deve ser reavaliado conforme protocolo.",
      source:"Diretrizes: Surviving Sepsis (lactato/perfus√£o)."
    },

    // ACLS
    {id:"q_acls_01", topic:"RCP/ACLS", specialty:["ENF","TEC","MULTI"], level:1,
      q:"Em PCR presenciada, prioridade imediata √©:",
      options:["Intubar antes de compress√µes", "RCP de alta qualidade e desfibrilar precocemente quando indicado", "Epinefrina antes de RCP", "Exame neurol√≥gico completo"],
      answerIndex:1,
      rationale:"RCP de alta qualidade e desfibrila√ß√£o precoce em ritmos choc√°veis s√£o determinantes de sobrevida.",
      source:"Diretrizes: AHA (ACLS/RCP) ‚Äî conceitos."
    },
    {id:"q_acls_02", topic:"RCP/ACLS", specialty:["ENF","TEC","MULTI"], level:2,
      q:"Ritmo FV/TV sem pulso: conduta inicial:",
      options:["Desfibrilar e retomar RCP imediatamente", "Atropina", "Cardiovers√£o sincronizada", "Aguardar monitoriza√ß√£o"],
      answerIndex:0,
      rationale:"FV/TV sem pulso √© ritmo choc√°vel: desfibrilar e reiniciar compress√µes sem atrasos prolongados.",
      source:"Diretrizes: AHA (ACLS) ‚Äî ritmos choc√°veis."
    },
    {id:"q_acls_03", topic:"RCP/ACLS", specialty:["ENF","MULTI"], level:3,
      q:"Ap√≥s ROSC, um objetivo priorit√°rio nas primeiras horas √©:",
      options:["Otimizar oxigena√ß√£o/ventila√ß√£o e perfus√£o e investigar causa", "Suspender monitoriza√ß√£o", "Evitar glicemia capilar", "Manter hipotens√£o deliberada"],
      answerIndex:0,
      rationale:"Cuidados p√≥s-PCR incluem otimiza√ß√£o de ventila√ß√£o/oxigena√ß√£o, estabilidade hemodin√¢mica e investiga√ß√£o de causa revers√≠vel.",
      source:"Diretrizes: AHA (p√≥s-parada) ‚Äî conceitos."
    },

    // VM / Resp
    {id:"q_vm_01", topic:"Ventila√ß√£o Mec√¢nica", specialty:["FISIO","ENF","MULTI"], level:1,
      q:"Conceito de ventila√ß√£o protetora (quando aplic√°vel) costuma incluir:",
      options:["VC alto (10‚Äì12 mL/kg)", "VC mais baixo (‚âà6 mL/kg de peso predito) e controle de press√µes", "PEEP zero sempre", "FR sempre < 10"],
      answerIndex:1,
      rationale:"Ventila√ß√£o protetora busca reduzir volutrauma/barotrauma, usando ajustes compat√≠veis com a condi√ß√£o cl√≠nica e metas de ventila√ß√£o.",
      source:"Base: estrat√©gias de ventila√ß√£o protetora em terapia intensiva."
    },
    {id:"q_vm_02", topic:"Ventila√ß√£o Mec√¢nica", specialty:["FISIO","MULTI"], level:2,
      q:"Sinal sugestivo de auto-PEEP em paciente obstrutivo na VM:",
      options:["Expira√ß√£o incompleta/tempo expirat√≥rio curto", "Pico baixo", "ETCO‚ÇÇ sempre normal", "Alarme de O‚ÇÇ alto"],
      answerIndex:0,
      rationale:"Auto-PEEP ocorre por aprisionamento a√©reo (expira√ß√£o incompleta), comum em DPOC/asma com FR alta e TE insuficiente.",
      source:"Base: mec√¢nica ventilat√≥ria em obstru√ß√£o."
    },
    {id:"q_vm_03", topic:"Ventila√ß√£o Mec√¢nica", specialty:["FISIO","MULTI"], level:3,
      q:"Paciente com broncoespasmo grave e auto-PEEP na VM: medida inicial coerente √©:",
      options:["Aumentar FR e reduzir tempo expirat√≥rio", "Reduzir FR e aumentar tempo expirat√≥rio, tratando broncoespasmo", "Suspender broncodilatadores", "Zerar seda√ß√£o sem avaliar"],
      answerIndex:1,
      rationale:"Para reduzir air trapping: aumentar TE (reduzir FR/ajustar Ti) e tratar broncoespasmo, monitorando hemodin√¢mica.",
      source:"Base: VM em obstru√ß√£o (asma/DPOC) e preven√ß√£o de hiperinsufla√ß√£o din√¢mica."
    },

    // Trauma / ATLS
    {id:"q_trauma_01", topic:"Trauma", specialty:["ENF","TEC","MULTI"], level:1,
      q:"No trauma, a prote√ß√£o cervical √© indicada quando:",
      options:["Somente em idosos", "Mecanismo sugestivo/altera√ß√£o neurol√≥gica at√© exclus√£o de les√£o", "Apenas se houver fratura exposta", "Somente se houver dor abdominal"],
      answerIndex:1,
      rationale:"No atendimento inicial do trauma, presume-se risco de les√£o cervical com mecanismo compat√≠vel at√© avalia√ß√£o adequada.",
      source:"Diretrizes: ATLS (conceitos de avalia√ß√£o prim√°ria)."
    },
    {id:"q_trauma_02", topic:"Trauma", specialty:["ENF","TEC","MULTI"], level:2,
      q:"Achados compat√≠veis com choque hemorr√°gico no trauma:",
      options:["Pele quente e corada", "Taquicardia, hipotens√£o e extremidades frias", "Bradicardia com hipertens√£o", "Sonol√™ncia com glicemia alta"],
      answerIndex:1,
      rationale:"Taquicardia + hipotens√£o + m√° perfus√£o perif√©rica sugerem choque, frequentemente hemorr√°gico no trauma.",
      source:"ATLS (choque no trauma) ‚Äî sinais cl√≠nicos."
    },

    // Seguran√ßa do Paciente / Medica√ß√£o
    {id:"q_med_01", topic:"Seguran√ßa/Medica√ß√£o", specialty:["ENF","TEC","MULTI"], level:1,
      q:"Medida que reduz erro de medica√ß√£o em ambiente hospitalar:",
      options:["Administrar sem identifica√ß√£o do paciente para ganhar tempo", "Checar identifica√ß√£o ativa e ‚Äòdireitos‚Äô da medica√ß√£o", "Evitar registro para agilizar", "Trocar frascos sem rotulagem"],
      answerIndex:1,
      rationale:"Pr√°ticas de seguran√ßa incluem identifica√ß√£o ativa e checagens padronizadas (paciente, medicamento, dose, via, hor√°rio, registro).",
      source:"Seguran√ßa do paciente (boas pr√°ticas/checagens)."
    },
    {id:"q_med_02", topic:"Seguran√ßa/Medica√ß√£o", specialty:["ENF","TEC"], level:2,
      q:"Antes de administrar medica√ß√£o de alto risco, √© recomendado:",
      options:["Dupla checagem quando prevista em protocolo e rotulagem clara", "Misturar diferentes drogas no mesmo frasco sem conferir compatibilidade", "Ignorar alergias se n√£o houver rea√ß√£o pr√©via", "Aplicar sem monitoriza√ß√£o"],
      answerIndex:0,
      rationale:"Drogas de alto risco exigem barreiras de seguran√ßa: rotulagem, dupla checagem, compatibilidade e monitoriza√ß√£o conforme protocolo.",
      source:"Boas pr√°ticas de seguran√ßa e gest√£o de risco."
    },

    // Oxigenoterapia / DPOC
    {id:"q_resp_01", topic:"Respirat√≥rio", specialty:["FISIO","ENF","MULTI"], level:1,
      q:"Objetivo da oxigenoterapia na emerg√™ncia √©:",
      options:["Manter sempre SpO‚ÇÇ 100%", "Garantir oxigena√ß√£o adequada com alvo seguro conforme contexto cl√≠nico", "Substituir ventila√ß√£o sempre", "Aumentar trabalho respirat√≥rio"],
      answerIndex:1,
      rationale:"Meta de oxigena√ß√£o deve ser segura e individualizada (ex.: cuidado com hiper√≥xia/retentor de CO‚ÇÇ quando aplic√°vel).",
      source:"Boas pr√°ticas de oxigenoterapia e insufici√™ncia respirat√≥ria."
    },
    {id:"q_resp_02", topic:"Respirat√≥rio", specialty:["FISIO","MULTI"], level:2,
      q:"Sinal cl√≠nico de fal√™ncia ventilat√≥ria iminente:",
      options:["FR 14 e fala frases completas", "Uso intenso de musculatura acess√≥ria + rebaixamento progressivo", "Tosse leve", "Temperatura 37,1¬∞C"],
      answerIndex:1,
      rationale:"Esfor√ßo acentuado com altera√ß√£o do n√≠vel de consci√™ncia sugere fadiga e risco de fal√™ncia ventilat√≥ria.",
      source:"Avalia√ß√£o cl√≠nica de insufici√™ncia respirat√≥ria."
    },

    // AVC / Dor tor√°cica (rotina)
    {id:"q_avc_01", topic:"Neurol√≥gico (AVC)", specialty:["ENF","TEC","MULTI"], level:1,
      q:"Sinal de alerta para AVC agudo que exige fluxo r√°pido:",
      options:["Dor lombar cr√¥nica", "Assimetria facial e d√©ficit s√∫bito de for√ßa/fala", "Prurido leve", "Edema de tornozelo"],
      answerIndex:1,
      rationale:"D√©ficit neurol√≥gico s√∫bito √© emerg√™ncia tempo-dependente; acionar protocolo (janela terap√™utica).",
      source:"Protocolos de AVC (reconhecimento r√°pido)."
    },
    {id:"q_dor_01", topic:"Cardiovascular", specialty:["ENF","TEC","MULTI"], level:1,
      q:"Em dor tor√°cica suspeita, a√ß√£o inicial adequada √©:",
      options:["Ignorar sinais vitais", "Monitoriza√ß√£o e avalia√ß√£o inicial estruturada (dor, vitais, ECG conforme fluxo)", "Alta imediata", "Aguardar melhora espont√¢nea sem avalia√ß√£o"],
      answerIndex:1,
      rationale:"Dor tor√°cica exige triagem estruturada e monitoriza√ß√£o; ECG precoce √© pr√°tica comum em protocolos.",
      source:"Fluxos de s√≠ndrome coronariana aguda (conceitos)."
    },
  ];

  // --------- CASES ----------
  // Case with single-choice decision list (shows correct/incorrect + rationale/source)
  const CASE_BANK = [
    {
      id:"c_sepse_pnm",
      title:"üöë Caso: Sepse prov√°vel (pneumonia)",
      specialty:["MULTI","ENF","FISIO","TEC"],
      intro:"Paciente 67a: febre, tosse produtiva, confus√£o, pele fria.",
      vitals:{ FR:"30", "SpO‚ÇÇ":"88% AA", FC:"118", PA:"86/54", T:"38,9" },
      question:"Qual √© a prioridade imediata mais coerente no in√≠cio do atendimento?",
      options:[
        { text:"Iniciar oxig√™nio e avalia√ß√£o ventilat√≥ria (B) + monitoriza√ß√£o", ok:true },
        { text:"Aguardar RX antes de qualquer interven√ß√£o", ok:false },
        { text:"Focar apenas em exame neurol√≥gico completo antes de estabilizar", ok:false },
        { text:"Oferecer √°gua e observar evolu√ß√£o", ok:false },
      ],
      rationale:"Em ABCDE, hipoxemia/taquipneia exigem interven√ß√£o no B imediatamente, enquanto o bundle de sepse √© acionado em paralelo conforme protocolo.",
      source:"ABCDE + Surviving Sepsis (bundle tempo-dependente).",
      points:10
    },
    {
      id:"c_pcr_fv",
      title:"‚ö° Caso: PCR com FV no monitor",
      specialty:["ENF","TEC","MULTI"],
      intro:"Paciente colapsa. Inconsciente, sem respira√ß√£o efetiva. Monitor: FV.",
      vitals:{ Ritmo:"FV", Pulso:"Ausente" },
      question:"Qual a√ß√£o imediata aumenta mais a chance de sobrevida?",
      options:[
        { text:"Desfibrilar e retomar RCP imediatamente", ok:true },
        { text:"Esperar m√©dico e manter paciente em repouso", ok:false },
        { text:"Checar pupilas por 2 minutos antes de compress√µes", ok:false },
        { text:"Atropina como primeira medida", ok:false },
      ],
      rationale:"RCP de alta qualidade e desfibrila√ß√£o precoce s√£o essenciais em ritmos choc√°veis; pausas devem ser m√≠nimas.",
      source:"AHA/ACLS (conceitos de FV/TV sem pulso).",
      points:10
    },
    {
      id:"c_trauma_choque",
      title:"ü©∏ Caso: Trauma com choque prov√°vel",
      specialty:["ENF","TEC","MULTI"],
      intro:"Motociclista 24a. Palidez, sudorese, extremidades frias, dor abdominal.",
      vitals:{ FC:"132", PA:"90/60", FR:"26" },
      question:"Qual foco inicial √© mais adequado?",
      options:[
        { text:"Reconhecer choque e atuar em C (circula√ß√£o/hemorragia) com reavalia√ß√£o", ok:true },
        { text:"Solicitar tomografia e aguardar", ok:false },
        { text:"Exposi√ß√£o completa antes de qualquer a√ß√£o", ok:false },
        { text:"Nebuliza√ß√£o e fisioterapia respirat√≥ria como prioridade", ok:false },
      ],
      rationale:"No trauma, choque hemorr√°gico √© prioridade. Avalia√ß√£o prim√°ria (ABCDE) com foco em perfus√£o e controle de sangramento conforme fluxo.",
      source:"ATLS (avalia√ß√£o prim√°ria e choque no trauma).",
      points:10
    },
    {
      id:"c_vm_autopeep",
      title:"ü´Å Caso: VM com auto-PEEP (obstrutivo)",
      specialty:["FISIO","MULTI","ENF"],
      intro:"Paciente DPOC intubado. Pico alto e expira√ß√£o curta; suspeita de air trapping.",
      vitals:{ SpO‚ÇÇ:"92%", EtCO‚ÇÇ:"alto", FC:"110" },
      question:"Qual ajuste inicial √© mais coerente (educacional)?",
      options:[
        { text:"Reduzir FR e aumentar tempo expirat√≥rio, tratando broncoespasmo", ok:true },
        { text:"Aumentar FR para ‚Äòventilar mais‚Äô e reduzir TE", ok:false },
        { text:"Desligar alarmes e manter igual", ok:false },
        { text:"Suspender broncodilatadores", ok:false },
      ],
      rationale:"Em obstru√ß√£o, expira√ß√£o insuficiente gera hiperinsufla√ß√£o din√¢mica. Aumentar TE e tratar broncoespasmo s√£o medidas base.",
      source:"Conceitos de VM em asma/DPOC e auto-PEEP.",
      points:10
    },
  ];

  // --------- CHECKLISTS (True/False) ----------
  // Student checks items that are TRUE (or FALSE) based on prompt; then evaluates.
  const CHECKLIST_BANK = [
    {
      id:"cl_med_safe",
      title:"‚úÖ Checklist: Seguran√ßa na administra√ß√£o de medica√ß√£o",
      specialty:["ENF","TEC","MULTI"],
      intro:"Marque as afirma√ß√µes VERDADEIRAS (boas pr√°ticas).",
      items:[
        { text:"Confirmar identifica√ß√£o ativa do paciente antes de administrar.", truth:true, why:"Identifica√ß√£o ativa √© barreira contra erro de paciente." },
        { text:"Administrar sem checar alergias se j√° usou antes.", truth:false, why:"Alergia deve ser checada e registrada conforme rotina." },
        { text:"Rotular seringas/solu√ß√µes quando preparadas fora da embalagem original.", truth:true, why:"Rotulagem reduz troca e erro de droga/dose." },
        { text:"Dupla checagem para medica√ß√µes de alto risco quando previsto em protocolo.", truth:true, why:"Barreira de seguran√ßa para alto risco." },
        { text:"Evitar registro para agilizar o fluxo.", truth:false, why:"Registro √© parte da seguran√ßa e rastreabilidade." },
      ],
      source:"Boas pr√°ticas de seguran√ßa do paciente / medica√ß√£o segura.",
      points:12
    },
    {
      id:"cl_asp_trq",
      title:"‚úÖ Checklist: Aspira√ß√£o em via a√©rea artificial (rotina segura)",
      specialty:["FISIO","ENF","TEC","MULTI"],
      intro:"Marque as afirma√ß√µes VERDADEIRAS (seguran√ßa e t√©cnica).",
      items:[
        { text:"Avaliar indica√ß√£o (secre√ß√£o, sinais cl√≠nicos) antes de aspirar.", truth:true, why:"Aspira√ß√£o sem indica√ß√£o aumenta risco e desconforto." },
        { text:"Manter t√©cnica ass√©ptica/limpa conforme protocolo e EPI adequado.", truth:true, why:"Reduz risco de contamina√ß√£o e infec√ß√£o." },
        { text:"Prolongar aspira√ß√£o continuamente por tempo indefinido.", truth:false, why:"Aspira√ß√£o prolongada aumenta dessatura√ß√£o e les√£o." },
        { text:"Monitorar SpO‚ÇÇ/FC e interromper se houver instabilidade.", truth:true, why:"Seguran√ßa: monitoriza√ß√£o e reavalia√ß√£o." },
        { text:"Ignorar tosse e sinais de desconforto do paciente.", truth:false, why:"Sinais cl√≠nicos orientam seguran√ßa e necessidade de pausa." },
      ],
      source:"Rotinas de aspira√ß√£o/seguran√ßa respirat√≥ria (conceitos).",
      points:12
    },
    {
      id:"cl_epi_isol",
      title:"‚úÖ Checklist: Isolamento e EPI (precau√ß√µes)",
      specialty:["ENF","TEC","MULTI","FISIO"],
      intro:"Marque as afirma√ß√µes VERDADEIRAS (precau√ß√µes e EPI).",
      items:[
        { text:"Higieniza√ß√£o de m√£os antes e ap√≥s contato com o paciente.", truth:true, why:"Medida mais efetiva contra transmiss√£o." },
        { text:"Usar EPI compat√≠vel com risco de got√≠culas/aeross√≥is conforme procedimento.", truth:true, why:"EPI depende do risco/gera√ß√£o de aerossol." },
        { text:"Reutilizar luvas entre pacientes se n√£o estiverem sujas.", truth:false, why:"Troca entre pacientes √© obrigat√≥ria." },
        { text:"Prote√ß√£o ocular/face shield quando risco de respingos.", truth:true, why:"Protege mucosas." },
        { text:"Descartar EPI de forma segura e correta.", truth:true, why:"Reduz contamina√ß√£o cruzada." },
      ],
      source:"Boas pr√°ticas de controle de infec√ß√£o e precau√ß√µes.",
      points:12
    },
  ];

  // --------- PPE by procedure ----------
  const PPE_MENU = [
    {
      title:"ü©∏ Pun√ß√£o venosa / Coleta de sangue",
      items:["Luvas", "Higieniza√ß√£o de m√£os", "√ìculos/face shield se risco de respingo", "Avental se risco de contato com fluidos"]
    },
    {
      title:"ü´Å Aspira√ß√£o de vias a√©reas / Procedimento com secre√ß√£o",
      items:["Luvas", "M√°scara (avaliar risco de aerossol conforme protocolo)", "Prote√ß√£o ocular/face shield", "Avental"]
    },
    {
      title:"üß™ Manipula√ß√£o de fluidos corporais / Curativos com exsudato",
      items:["Luvas", "Avental", "Prote√ß√£o ocular se respingo", "M√°scara se risco de got√≠culas"]
    },
    {
      title:"‚ö° RCP / Atendimento emergencial com exposi√ß√£o a fluidos",
      items:["Luvas", "Prote√ß√£o ocular/face shield", "M√°scara conforme risco", "Avental se exposi√ß√£o prov√°vel"]
    },
    {
      title:"üß´ Precau√ß√µes de contato (ex.: diarreia infecciosa)",
      items:["Luvas", "Avental", "Higiene de m√£os rigorosa", "Limpeza de superf√≠cies conforme protocolo"]
    },
  ];

  // --------- Pathologies & Interventions (Searchable) ----------
  const PATH_DB = [
    { name:"Sepse/Choque s√©ptico", tags:["infec√ß√£o","hipotens√£o","lactato"], initial:[
      "Reconhecer sinais de hipoperfus√£o e iniciar monitoriza√ß√£o.",
      "Coletar exames conforme protocolo e iniciar antibi√≥tico oportuno.",
      "Reposi√ß√£o vol√™mica e vasopressor quando indicado (protocolo).",
      "Reavalia√ß√£o seriada (perfus√£o, PAM, diurese, lactato)."
    ], source:"Surviving Sepsis (conceitos)."},
    { name:"Asma/DPOC exacerbado", tags:["broncoespasmo","hipercapnia","fadiga"], initial:[
      "Avaliar esfor√ßo respirat√≥rio, ausculta, SpO‚ÇÇ e sinais de fadiga.",
      "Oxigenoterapia com alvo seguro conforme contexto.",
      "Broncodilatadores/corticoide conforme prescri√ß√£o e protocolo.",
      "Se ventila√ß√£o invasiva: prevenir auto-PEEP aumentando tempo expirat√≥rio."
    ], source:"GOLD/boas pr√°ticas respirat√≥rias (conceitos)."},
    { name:"PCR (FV/TV sem pulso)", tags:["acls","choque"], initial:[
      "RCP de alta qualidade, minimizar pausas.",
      "Desfibrilar precocemente quando indicado.",
      "Organizar equipe e ciclos conforme protocolo.",
      "P√≥s-ROSC: otimizar ventila√ß√£o/perfus√£o e investigar causa."
    ], source:"AHA/ACLS (conceitos)."},
    { name:"AVC agudo (suspeita)", tags:["fala","for√ßa","face"], initial:[
      "Reconhecimento r√°pido e acionar protocolo tempo-dependente.",
      "Checar glicemia, sinais vitais e avalia√ß√£o neurol√≥gica breve.",
      "Via a√©rea/oxigena√ß√£o se necess√°rio.",
      "Transporte e exames conforme fluxo institucional."
    ], source:"Protocolos de AVC (conceitos)."},
    { name:"Trauma com choque prov√°vel", tags:["hemorragia","hipotens√£o"], initial:[
      "ABCDE com prote√ß√£o cervical quando indicado.",
      "Reconhecer choque e atuar em circula√ß√£o/controle de sangramento conforme fluxo.",
      "Aquecer paciente e reavaliar continuamente.",
      "Acionar equipe (cirurgia/trauma) conforme gravidade."
    ], source:"ATLS (conceitos)."},
  ];

  // --------- Helpers: pick rotating by filter ----------
  function matchesSpecialty(itemSpecs, selected){
    if(selected === "MIX") return true;
    return itemSpecs.includes(selected) || itemSpecs.includes("MULTI");
  }

  function pickRotatingQuestion({topic=null, level=null, specialty="MIX"}){
    let pool = QUESTION_BANK.slice().filter(q => matchesSpecialty(q.specialty, specialty));
    if(topic) pool = pool.filter(q => q.topic === topic);
    if(level) pool = pool.filter(q => q.level === level);

    const seen = new Set(appState.seenQuestionIds || []);
    let unseen = pool.filter(q => !seen.has(q.id));
    if(unseen.length === 0) unseen = pool;

    const q = unseen[Math.floor(Math.random() * unseen.length)];
    if(q && !seen.has(q.id)){
      appState.seenQuestionIds.push(q.id);
      if(appState.seenQuestionIds.length > 800) appState.seenQuestionIds.shift();
      saveState();
    }
    return q;
  }

  function pickRotatingCase(specialty="MIX"){
    let pool = CASE_BANK.slice().filter(c => matchesSpecialty(c.specialty, specialty));
    const seen = new Set(appState.seenCaseIds || []);
    let unseen = pool.filter(c => !seen.has(c.id));
    if(unseen.length === 0) unseen = pool;
    const c = unseen[Math.floor(Math.random() * unseen.length)];
    if(c && !seen.has(c.id)){
      appState.seenCaseIds.push(c.id);
      if(appState.seenCaseIds.length > 400) appState.seenCaseIds.shift();
      saveState();
    }
    return c;
  }

  function pickRotatingChecklist(specialty="MIX"){
    let pool = CHECKLIST_BANK.slice().filter(cl => matchesSpecialty(cl.specialty, specialty));
    const seen = new Set(appState.seenChecklistIds || []);
    let unseen = pool.filter(cl => !seen.has(cl.id));
    if(unseen.length === 0) unseen = pool;
    const cl = unseen[Math.floor(Math.random() * unseen.length)];
    if(cl && !seen.has(cl.id)){
      appState.seenChecklistIds.push(cl.id);
      if(appState.seenChecklistIds.length > 400) appState.seenChecklistIds.shift();
      saveState();
    }
    return cl;
  }

  // --------- UI: modal ----------
  function openModal(title, subtitle, bodyHtml){
    el("modalTitle").textContent = title;
    el("modalSubtitle").textContent = subtitle || "";
    el("modalBody").innerHTML = bodyHtml || "";
    el("modal").classList.add("show");
    el("modal").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    el("modal").classList.remove("show");
    el("modal").setAttribute("aria-hidden","true");
  }
  el("modalClose").addEventListener("click", closeModal);
  el("modalBackdrop").addEventListener("click", closeModal);

  // --------- Routing ----------
  const VIEW_META = {
    dashboard: { title:"Painel", subtitle:"Escolha um m√≥dulo e treine com feedback imediato." },
    triage: { title:"Triagem (ABCDE)", subtitle:"Decida prioridades e receba corre√ß√£o." },
    cases: { title:"Casos Cl√≠nicos", subtitle:"Casos rotativos com resposta e justificativa." },
    quiz: { title:"Quiz", subtitle:"Responda e avance automaticamente em 5 segundos." },
    checklists: { title:"Checklists (V/F)", subtitle:"Marque itens corretos e finalize para ver a pontua√ß√£o." },
    ppe: { title:"EPIs por procedimento", subtitle:"Guia pr√°tico de EPIs por risco/procedimento (educacional)." },
    path: { title:"Patologias & Interven√ß√µes", subtitle:"Consulte condutas iniciais e interven√ß√µes por condi√ß√£o (educacional)." },
    review: { title:"Revis√£o", subtitle:"Veja seu hist√≥rico e onde precisa refor√ßar." },
  };

  function setHeader(view){
    const m = VIEW_META[view] || VIEW_META.dashboard;
    if(el("pageTitle")) el("pageTitle").textContent = m.title;
    if(el("pageSubtitle")) el("pageSubtitle").textContent = m.subtitle;
    document.title = `Emerg√™ncia ‚Äî ${m.title}`;
  }

  function sectionCard(title, subtitle, innerHtml){
    const wrap = document.createElement("div");
    wrap.className = "card rounded-3xl p-5";
    wrap.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-2xl font-extrabold">${escapeHtml(title)}</div>
          ${subtitle ? `<div class="text-slate-300 mt-1">${escapeHtml(subtitle)}</div>` : ""}
        </div>
      </div>
      <div class="mt-4">${innerHtml}</div>
    `;
    return wrap;
  }

  const viewContainer = el("viewContainer");
  function go(view){
    setHeader(view);
    renderView(view);
    document.querySelectorAll(".navBtn").forEach(b=>{
      if(b.dataset.view === view){
        b.classList.remove("btn-ghost");
        b.classList.add("btn-primary");
      } else {
        b.classList.remove("btn-primary");
        b.classList.add("btn-ghost");
      }
    });
    if(window.innerWidth < 1024){
      el("sidebar").classList.add("hidden");
    }
  }

  function renderView(view){
    viewContainer.innerHTML = "";
    if(view === "dashboard") return renderDashboard();
    if(view === "triage") return renderTriage();
    if(view === "cases") return renderCases();
    if(view === "quiz") return renderQuiz();
    if(view === "checklists") return renderChecklists();
    if(view === "ppe") return renderPPE();
    if(view === "path") return renderPath();
    if(view === "review") return renderReview();
    return renderDashboard();
  }

  // --------- Common: Specialty filter UI ----------
  function specialtySelect(id){
    return `
      <select id="${id}" class="rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold">
        ${SPECIALTIES.map(s => `<option value="${s.key}">${escapeHtml(s.label)}</option>`).join("")}
      </select>
    `;
  }

  // --------- Dashboard ----------
  function renderDashboard(){
    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-xl font-extrabold">üöÄ Come√ßar agora</div>
          <div class="text-slate-300 mt-2">Escolha um m√≥dulo e treine (sem cadastro).</div>

          <div class="grid sm:grid-cols-2 gap-3 mt-4">
            <button class="btn-big btn-primary w-full" data-go="triage">üö¶ Triagem ABCDE</button>
            <button class="btn-big btn-primary w-full" data-go="cases">üìã Casos Cl√≠nicos</button>
            <button class="btn-big btn-ghost w-full" data-go="quiz">üß† Quiz (auto)</button>
            <button class="btn-big btn-ghost w-full" data-go="checklists">‚úÖ Checklists (V/F)</button>
            <button class="btn-big btn-ghost w-full" data-go="ppe">üß§ EPIs</button>
            <button class="btn-big btn-ghost w-full" data-go="path">üß© Patologias</button>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-xl font-extrabold">üìå Regras do treino</div>
          <div class="mt-3 grid gap-3 text-slate-300 text-sm">
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">‚úÖ Sele√ß√£o</div>
              <div class="mt-1">Ao clicar, a op√ß√£o fica <b>verde</b> (selecionada) e aparece <b>Correto/Errado</b>.</div>
            </div>
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">‚è±Ô∏è Quiz autom√°tico</div>
              <div class="mt-1">Ap√≥s responder, a pr√≥xima quest√£o aparece em <b>5 segundos</b>.</div>
            </div>
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">üìö Embasamento</div>
              <div class="mt-1">Cada item tem justificativa baseada em diretrizes e boas pr√°ticas (conceitos).</div>
            </div>
          </div>
          <div class="mt-4">
            <button class="btn-big btn-warning w-full" data-go="review">üìö Ver Revis√£o</button>
          </div>
        </div>
      </div>
    `;
    const card = sectionCard("üßë‚Äç‚öïÔ∏è Painel", "Escolha o m√≥dulo para treinar.", html);
    viewContainer.appendChild(card);
    card.querySelectorAll("[data-go]").forEach(btn => btn.addEventListener("click", ()=>go(btn.dataset.go)));
  }

  // --------- Triagem (ABCDE) ----------
  function renderTriage(){
    const scenarios = [
      {
        title:"Adulto com ru√≠do inspirat√≥rio agudo",
        text:"Fala entrecortada e estridor. Hist√≥ria de alergia recente.",
        vitals:{ "FR":"34", "SpO‚ÇÇ":"90% AA", "FC":"124", "PA":"118/72" },
        correctIndex:0,
        options:[
          "A ‚Äî Priorizar via a√©rea (A) e preparo de suporte conforme protocolo",
          "C ‚Äî Iniciar volume e aguardar",
          "D ‚Äî Exame neurol√≥gico completo antes de A/B",
          "E ‚Äî Expor e procurar les√µes antes de A"
        ],
        rationale:"Estridor + fala comprometida sugerem via a√©rea amea√ßada (A) e risco de deteriora√ß√£o r√°pida.",
        source:"ABCDE (avalia√ß√£o prim√°ria)."
      },
      {
        title:"Idoso confuso e hipotenso com febre",
        text:"Pele fria, taquipneia e dessatura√ß√£o em ar ambiente.",
        vitals:{ "FR":"30", "SpO‚ÇÇ":"88% AA", "FC":"118", "PA":"86/54" },
        correctIndex:0,
        options:[
          "B ‚Äî Oxig√™nio e avalia√ß√£o ventilat√≥ria imediata",
          "E ‚Äî Aguardar exames para agir",
          "D ‚Äî Avaliar neuro completo antes de estabilizar",
          "A ‚Äî Intubar sem avalia√ß√£o e sem sinais claros de via a√©rea amea√ßada"
        ],
        rationale:"Hipoxemia/taquipneia exigem interven√ß√£o no B imediatamente, enquanto medidas de sepse s√£o iniciadas em paralelo.",
        source:"ABCDE + conceitos de bundle em sepse."
      },
    ];

    let idx = Math.floor(Math.random()*scenarios.length);

    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">üö¶ Triagem ABCDE</div>
              <div class="text-slate-300 mt-2">Escolha a prioridade imediata.</div>
            </div>
            <button id="btnTriageHelp" class="btn-big btn-ghost">‚ùì Ajuda</button>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="text-sm text-slate-400">Cen√°rio</div>
            <div class="text-xl font-extrabold mt-1" id="triTitle"></div>
            <div class="text-slate-300 mt-2" id="triText"></div>
            <div class="grid sm:grid-cols-2 gap-3 mt-3 text-sm" id="triVitals"></div>
          </div>

          <div class="mt-4 grid gap-3" id="triOptions"></div>

          <div class="mt-4 hidden rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="triFeedback"></div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnTriNext" class="btn-big btn-primary">üîÑ Pr√≥ximo cen√°rio</button>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üßæ Lembrete ABCDE</div>
          <div class="text-slate-300 mt-2">Use como guia mental (sem entregar resposta).</div>

          <div class="mt-4 grid gap-3 text-slate-300 text-sm">
            ${miniNote("A ‚Äî Via a√©rea","Fala? ru√≠do? estridor? prote√ß√£o cervical quando indicado.")}
            ${miniNote("B ‚Äî Respira√ß√£o","FR/padr√£o/SpO‚ÇÇ/ausculta e suporte de oxigena√ß√£o/ventila√ß√£o.")}
            ${miniNote("C ‚Äî Circula√ß√£o","PA/FC/perfus√£o/hemorragia e reavalia√ß√£o seriada.")}
            ${miniNote("D ‚Äî Neurol√≥gico","Glasgow, pupilas, glicemia e reavalia√ß√£o ap√≥s estabiliza√ß√£o." )}
            ${miniNote("E ‚Äî Exposi√ß√£o","Temperatura, les√µes ocultas e preven√ß√£o de hipotermia." )}
          </div>
        </div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("üö¶ Triagem", "Prioridades com corre√ß√£o imediata.", html));

    const triTitle = document.getElementById("triTitle");
    const triText  = document.getElementById("triText");
    const triVitals = document.getElementById("triVitals");
    const triOptions = document.getElementById("triOptions");
    const triFeedback = document.getElementById("triFeedback");

    function renderScenario(){
      const s = scenarios[idx];
      triTitle.textContent = s.title;
      triText.textContent  = s.text;
      triVitals.innerHTML = Object.entries(s.vitals).map(([k,v])=>`
        <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3">
          <div class="text-xs text-slate-400">${escapeHtml(k)}</div>
          <div class="font-extrabold mono">${escapeHtml(v)}</div>
        </div>
      `).join("");

      triOptions.innerHTML = "";
      triFeedback.classList.add("hidden");
      triFeedback.innerHTML = "";

      let locked = false;

      s.options.forEach((label, i)=>{
        const b = document.createElement("button");
        b.className = "btn-big btn-ghost w-full text-left";
        b.type="button";
        b.textContent = label;
        b.addEventListener("click", ()=>{
          if(locked) return;
          locked = true;

          // selected green (always)
          b.classList.remove("btn-ghost");
          b.classList.add("btn-ok");

          const ok = i === s.correctIndex;
          if(ok){
            appState.correct += 1;
            addScore(6, "Triagem correta");
            beep(880, 90);
            popCenter("Correto!", "+6 pontos (Triagem).", 5000);
            addReview({type:"triage", ok:true, scenario:s.title, choice:label});
          } else {
            appState.wrong += 1;
            beep(220, 120);
            addReview({type:"triage", ok:false, scenario:s.title, choice:label});
          }

          triFeedback.classList.remove("hidden");
          triFeedback.innerHTML = `
            <div class="text-lg font-extrabold">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
            <div class="text-slate-300 mt-2">${escapeHtml(s.rationale)}</div>
            <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(s.source)}</div>
          `;

          saveState();
        });
        triOptions.appendChild(b);
      });
    }

    document.getElementById("btnTriNext").addEventListener("click", ()=>{
      idx = (idx + 1) % scenarios.length;
      renderScenario();
    });

    document.getElementById("btnTriageHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî Triagem", "Dica curta (sem entregar resposta)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Pense em <b>amea√ßa imediata √† vida</b>. Se houver risco de via a√©rea/ventila√ß√£o/perfus√£o, isso vem primeiro.
        </div>
      `);
    });

    renderScenario();
  }

  // --------- Cases (single-choice with immediate correct/incorrect) ----------
  function renderCases(){
    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üìã Casos Cl√≠nicos</div>
            <div class="text-slate-300 mt-2">Selecione especialidade para filtrar os casos.</div>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            ${specialtySelect("caseSpec")}
            <button id="btnCaseHelp" class="btn-big btn-ghost">‚ùì Ajuda</button>
            <button id="btnCaseNext" class="btn-big btn-primary">üîÑ Pr√≥ximo caso</button>
          </div>
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5" id="caseBox"></div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üìã Casos Cl√≠nicos", "Corre√ß√£o imediata + justificativa.", html));

    const caseBox = document.getElementById("caseBox");
    const selSpec = document.getElementById("caseSpec");

    function renderOne(){
      const spec = selSpec.value || "MIX";
      const c = pickRotatingCase(spec);
      if(!c){
        caseBox.innerHTML = `<div class="text-slate-300">Sem casos para este filtro.</div>`;
        return;
      }

      const vitalsHtml = Object.entries(c.vitals || {}).map(([k,v])=>`
        <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3">
          <div class="text-xs text-slate-400">${escapeHtml(k)}</div>
          <div class="font-extrabold mono">${escapeHtml(v)}</div>
        </div>
      `).join("");

      caseBox.innerHTML = `
        <div class="text-sm text-slate-400">Caso</div>
        <div class="text-2xl font-extrabold mt-1">${escapeHtml(c.title)}</div>
        <div class="text-slate-300 mt-2">${escapeHtml(c.intro)}</div>

        <div class="grid sm:grid-cols-3 gap-3 mt-4 text-sm">${vitalsHtml}</div>

        <div class="mt-4 rounded-3xl bg-slate-900/50 border border-slate-700/30 p-4">
          <div class="font-extrabold text-lg">Pergunta</div>
          <div class="text-slate-200 mt-1 text-lg font-extrabold">${escapeHtml(c.question)}</div>
        </div>

        <div class="mt-4 grid gap-3" id="caseOptions"></div>

        <div class="mt-4 hidden rounded-3xl bg-slate-900/50 border border-slate-700/30 p-4" id="caseFeedback"></div>
      `;

      const optWrap = document.getElementById("caseOptions");
      const fb = document.getElementById("caseFeedback");

      let locked = false;
      c.options.forEach((o, i)=>{
        const b = document.createElement("button");
        b.className = "btn-big btn-ghost w-full text-left";
        b.type="button";
        b.innerHTML = `<span class="font-extrabold">${String.fromCharCode(65+i)}.</span> ${escapeHtml(o.text)}`;
        b.addEventListener("click", ()=>{
          if(locked) return;
          locked = true;

          // selection always green
          b.classList.remove("btn-ghost");
          b.classList.add("btn-ok");

          const ok = !!o.ok;
          if(ok){
            appState.correct += 1;
            addScore(c.points || 10, `Caso correto (${c.title})`);
            beep(880, 90);
            popCenter("Correto!", `+${c.points||10} pontos (Caso).`, 5000);
          } else {
            appState.wrong += 1;
            beep(220, 120);
          }

          addReview({type:"case", ok, caseId:c.id, title:c.title, selected:o.text});

          fb.classList.remove("hidden");
          fb.innerHTML = `
            <div class="text-lg font-extrabold">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
            <div class="text-slate-300 mt-2">${escapeHtml(c.rationale)}</div>
            <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(c.source)}</div>
          `;

          saveState();
        });

        optWrap.appendChild(b);
      });
    }

    document.getElementById("btnCaseNext").addEventListener("click", renderOne);
    selSpec.addEventListener("change", renderOne);

    document.getElementById("btnCaseHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî Casos", "Dica curta (sem resposta)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Use a l√≥gica <b>ABCDE</b>: priorize risco imediato (via a√©rea/ventila√ß√£o/perfus√£o) e pense em <b>tempo-depend√™ncia</b> (sepse, PCR, AVC, trauma).
        </div>
      `);
    });

    renderOne();
  }

  // --------- QUIZ (auto next in 5 seconds) ----------
  function renderQuiz(){
    const topics = [...new Set(QUESTION_BANK.map(q=>q.topic))].sort((a,b)=>a.localeCompare(b));

    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üß† Quiz</div>
            <div class="text-slate-300 mt-2">Depois de responder, a pr√≥xima aparece automaticamente em <b>5s</b>.</div>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            ${specialtySelect("quizSpec")}
            <select id="quizTopic" class="rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold">
              <option value="">üåê Todos temas</option>
              ${topics.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("")}
            </select>
            <select id="quizLevel" class="rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold">
              <option value="">üéöÔ∏è Todos n√≠veis</option>
              <option value="1">N√≠vel 1</option>
              <option value="2">N√≠vel 2</option>
              <option value="3">N√≠vel 3</option>
            </select>

            <button id="btnQuizHelp" class="btn-big btn-ghost">‚ùì Ajuda</button>
            <button id="btnQuizNext" class="btn-big btn-primary">‚û°Ô∏è Pr√≥xima</button>
          </div>
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5" id="quizBox">
          <div class="text-sm text-slate-400" id="quizMeta">‚Äî</div>
          <div class="text-2xl font-extrabold mt-2" id="quizQuestion">‚Äî</div>
          <div class="grid gap-3 mt-4" id="quizOptions"></div>

          <div class="mt-4 hidden rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4" id="quizFeedback"></div>

          <div class="mt-4 text-sm text-slate-300">
            <b>Auto-pr√≥xima:</b> <span id="autoNextLabel">‚Äî</span>
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üß† Quiz", "Sele√ß√£o verde + corre√ß√£o + auto-pr√≥xima.", html));

    const selSpec  = document.getElementById("quizSpec");
    const selTopic = document.getElementById("quizTopic");
    const selLevel = document.getElementById("quizLevel");

    const qMeta = document.getElementById("quizMeta");
    const qText = document.getElementById("quizQuestion");
    const qOpts = document.getElementById("quizOptions");
    const fb    = document.getElementById("quizFeedback");
    const autoNextLabel = document.getElementById("autoNextLabel");

    let currentQ = null;
    let answered = false;
    let timer = null;
    let countdown = null;
    let secondsLeft = 0;

    function ptsFor(level){
      if(level === 3) return 9;
      if(level === 2) return 7;
      return 5;
    }

    function clearTimers(){
      if(timer) clearTimeout(timer);
      if(countdown) clearInterval(countdown);
      timer = null; countdown = null;
      autoNextLabel.textContent = "‚Äî";
    }

    function loadQ(){
      clearTimers();

      const spec  = selSpec.value || "MIX";
      const topic = selTopic.value || null;
      const level = selLevel.value ? Number(selLevel.value) : null;

      currentQ = pickRotatingQuestion({topic, level, specialty: spec});
      answered = false;
      fb.classList.add("hidden");
      fb.innerHTML = "";
      qOpts.innerHTML = "";

      if(!currentQ){
        qMeta.textContent = "Sem quest√µes para este filtro.";
        qText.textContent = "Ajuste tema/n√≠vel/especialidade.";
        return;
      }

      qMeta.textContent = `Especialidade: ${SPECIALTIES.find(s=>s.key===spec)?.label || "Mesclado"} ‚Ä¢ Tema: ${currentQ.topic} ‚Ä¢ N√≠vel ${currentQ.level}`;
      qText.textContent = currentQ.q;

      currentQ.options.forEach((opt, idx)=>{
        const b = document.createElement("button");
        b.className = "btn-big btn-ghost w-full text-left";
        b.type="button";
        b.innerHTML = `<span class="font-extrabold">${String.fromCharCode(65+idx)}.</span> ${escapeHtml(opt)}`;

        b.addEventListener("click", ()=>{
          if(answered) return;
          answered = true;

          // selected always green
          b.classList.remove("btn-ghost");
          b.classList.add("btn-ok");

          const ok = idx === currentQ.answerIndex;
          if(ok){
            const pts = ptsFor(currentQ.level);
            appState.correct += 1;
            addScore(pts, `Quiz correto (${currentQ.topic}, N${currentQ.level})`);
            beep(880, 90);
            popCenter("Correto!", `+${pts} pontos (Quiz).`, 5000);
          } else {
            appState.wrong += 1;
            beep(220, 120);
          }

          addReview({
            type:"quiz",
            ok,
            qid: currentQ.id,
            topic: currentQ.topic,
            level: currentQ.level,
            chosen: idx,
            answer: currentQ.answerIndex
          });

          fb.classList.remove("hidden");
          fb.innerHTML = `
            <div class="text-lg font-extrabold">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
            <div class="text-slate-300 mt-2">${escapeHtml(currentQ.rationale)}</div>
            <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(currentQ.source)}</div>
          `;

          // Auto-next in 5 seconds
          secondsLeft = 5;
          autoNextLabel.textContent = `Pr√≥xima em ${secondsLeft}s‚Ä¶`;
          countdown = setInterval(()=>{
            secondsLeft -= 1;
            if(secondsLeft <= 0){
              clearTimers();
              return;
            }
            autoNextLabel.textContent = `Pr√≥xima em ${secondsLeft}s‚Ä¶`;
          }, 1000);

          timer = setTimeout(()=>{
            clearTimers();
            loadQ();
          }, 5000);

          // lock other buttons (optional)
          qOpts.querySelectorAll("button").forEach(btn => btn.disabled = true);
          b.disabled = false; // keep selected visible
          saveState();
        });

        qOpts.appendChild(b);
      });
    }

    document.getElementById("btnQuizNext").addEventListener("click", loadQ);
    selSpec.addEventListener("change", loadQ);
    selTopic.addEventListener("change", loadQ);
    selLevel.addEventListener("change", loadQ);

    document.getElementById("btnQuizHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî Quiz", "Dica curta (sem entregar resposta)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Antes de responder, identifique: <b>prioridade</b> (ABCDE), <b>tempo-depend√™ncia</b> (PCR/sepse/AVC/trauma) e <b>seguran√ßa</b> (checagens/EPI/monitoriza√ß√£o).
        </div>
      `);
    });

    loadQ();
  }

  // --------- CHECKLISTS (V/F) ----------
  function renderChecklists(){
    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">‚úÖ Checklists (V/F)</div>
            <div class="text-slate-300 mt-2">Marque itens verdadeiros e finalize para corrigir.</div>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            ${specialtySelect("clSpec")}
            <button id="btnClHelp" class="btn-big btn-ghost">‚ùì Ajuda</button>
            <button id="btnClNext" class="btn-big btn-primary">üîÑ Pr√≥ximo checklist</button>
          </div>
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5" id="clBox"></div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("‚úÖ Checklists", "Selecione V/F (verdadeiro) e avalie.", html));

    const clBox = document.getElementById("clBox");
    const selSpec = document.getElementById("clSpec");

    function renderOne(){
      const spec = selSpec.value || "MIX";
      const cl = pickRotatingChecklist(spec);
      if(!cl){
        clBox.innerHTML = `<div class="text-slate-300">Sem checklists para este filtro.</div>`;
        return;
      }

      clBox.innerHTML = `
        <div class="text-sm text-slate-400">Checklist</div>
        <div class="text-2xl font-extrabold mt-1">${escapeHtml(cl.title)}</div>
        <div class="text-slate-300 mt-2">${escapeHtml(cl.intro)}</div>

        <div class="mt-4 grid gap-2" id="clItems">
          ${cl.items.map((it, i)=>`
            <label class="flex items-start gap-3 rounded-3xl bg-slate-900/55 border border-slate-700/30 p-4 cursor-pointer">
              <input type="checkbox" class="mt-1 h-6 w-6 accent-emerald-400" id="cl_it_${i}">
              <span class="font-extrabold">${escapeHtml(it.text)}</span>
            </label>
          `).join("")}
        </div>

        <div class="mt-4 flex flex-wrap gap-3">
          <button id="btnClFinish" class="btn-big btn-ok">‚úÖ Finalizar e corrigir</button>
          <button id="btnClClear" class="btn-big btn-ghost">‚ôªÔ∏è Limpar sele√ß√£o</button>
        </div>

        <div class="mt-4 hidden rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4" id="clFeedback"></div>
      `;

      const fb = document.getElementById("clFeedback");

      document.getElementById("btnClClear").addEventListener("click", ()=>{
        cl.items.forEach((_, i)=> document.getElementById(`cl_it_${i}`).checked = false);
        fb.classList.add("hidden");
        fb.innerHTML = "";
      });

      document.getElementById("btnClFinish").addEventListener("click", ()=>{
        let correctCount = 0;
        const lines = [];

        cl.items.forEach((it, i)=>{
          const checked = document.getElementById(`cl_it_${i}`).checked;
          const ok = (checked === it.truth); // if true item and checked OR false item and unchecked
          if(ok) correctCount++;

          lines.push(`
            <div class="rounded-2xl bg-slate-950/40 border border-slate-700/30 p-3">
              <div class="font-extrabold">${ok ? "‚úÖ" : "‚ùå"} ${escapeHtml(it.text)}</div>
              <div class="text-slate-300 text-sm mt-1">${escapeHtml(it.why)}</div>
              <div class="text-slate-400 text-xs mt-1"><b>Gabarito:</b> ${it.truth ? "Verdadeiro" : "Falso"}</div>
            </div>
          `);
        });

        const pct = Math.round((correctCount / cl.items.length) * 100);
        fb.classList.remove("hidden");
        fb.innerHTML = `
          <div class="text-lg font-extrabold">Resultado: ${pct}%</div>
          <div class="text-slate-300 mt-2">Acertos: ${correctCount}/${cl.items.length}</div>
          <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(cl.source)}</div>
          <div class="mt-4 grid gap-2">${lines.join("")}</div>
        `;

        const gained = pct >= 80 ? (cl.points||12) : pct >= 60 ? 6 : 2;
        if(pct >= 80){
          appState.correct += 1;
          addScore(gained, `Checklist alto desempenho (${cl.title})`);
          beep(880, 90);
          popCenter("√ìtimo!", `+${gained} pontos (Checklist).`, 5000);
        } else if(pct >= 60){
          addScore(gained, `Checklist desempenho parcial (${cl.title})`);
          beep(520, 80);
          toast("warn","Ajuste fino", "Revise os itens errados e repita outro checklist.");
        } else {
          addScore(gained, `Checklist baixo desempenho (${cl.title})`);
          beep(220, 120);
          toast("bad","Refor√ßo necess√°rio", "Revise justificativas e tente novamente.");
        }

        addReview({type:"checklist", id:cl.id, title:cl.title, pct, correct:correctCount});
        saveState();
      });
    }

    document.getElementById("btnClNext").addEventListener("click", renderOne);
    selSpec.addEventListener("change", renderOne);

    document.getElementById("btnClHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî Checklists", "Dica curta (sem resposta)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Marque apenas o que √© <b>boa pr√°tica</b> e <b>seguro</b>. Se aumentar risco de evento adverso, geralmente √© falso.
        </div>
      `);
    });

    renderOne();
  }

  // --------- PPE view ----------
  function renderPPE(){
    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üß§ EPIs por tipo de procedimento</div>
            <div class="text-slate-300 mt-2">Guia educacional por risco/procedimento (ajuste ao protocolo local).</div>
          </div>
          <button id="btnPPEHelp" class="btn-big btn-ghost">‚ùì Ajuda</button>
        </div>

        <div class="mt-4 grid lg:grid-cols-2 gap-4">
          ${PPE_MENU.map(p=>`
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
              <div class="text-xl font-extrabold">${escapeHtml(p.title)}</div>
              <ul class="mt-3 text-slate-300 text-sm list-disc pl-5 space-y-1">
                ${p.items.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>
          `).join("")}
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4 text-slate-300 text-sm">
          <b>Nota:</b> EPIs podem variar conforme precau√ß√£o (contato/got√≠culas/aeross√≥is) e procedimento gerador de aerossol.
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üß§ EPIs", "Sele√ß√£o r√°pida por procedimento.", html));

    document.getElementById("btnPPEHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî EPI", "Dica curta (sem protocolo espec√≠fico)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Pense em <b>risco de contato com fluidos</b> (luvas/avental) e <b>risco de respingo/aerossol</b> (prote√ß√£o ocular/m√°scara apropriada).
        </div>
      `);
    });
  }

  // --------- Pathologies view ----------
  function renderPath(){
    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üß© Patologias & Interven√ß√µes</div>
            <div class="text-slate-300 mt-2">Busque uma condi√ß√£o e veja interven√ß√µes iniciais (educacional).</div>
          </div>
          <div class="flex gap-2 items-center">
            <input id="pathSearch" class="w-[280px] rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold"
              placeholder="Buscar: sepse, trauma, DPOC..." />
            <button id="btnPathHelp" class="btn-big btn-ghost">‚ùì Ajuda</button>
          </div>
        </div>

        <div class="mt-4 grid lg:grid-cols-2 gap-4" id="pathList"></div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üß© Patologias", "Consulta r√°pida para estudo.", html));

    const list = document.getElementById("pathList");
    const search = document.getElementById("pathSearch");

    function renderList(){
      const q = (search.value || "").trim().toLowerCase();
      const items = PATH_DB.filter(p=>{
        if(!q) return true;
        return p.name.toLowerCase().includes(q) || (p.tags||[]).some(t=>t.toLowerCase().includes(q));
      });

      list.innerHTML = items.map(p=>`
        <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
          <div class="text-xl font-extrabold">${escapeHtml(p.name)}</div>
          <div class="mt-3 text-slate-300 text-sm">
            <div class="font-extrabold mb-1">Interven√ß√µes iniciais (educacional)</div>
            <ul class="list-disc pl-5 space-y-1">
              ${p.initial.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
            </ul>
          </div>
          <div class="text-slate-400 text-xs mt-3"><b>Base:</b> ${escapeHtml(p.source)}</div>
        </div>
      `).join("");

      if(items.length === 0){
        list.innerHTML = `<div class="text-slate-300">Nenhum resultado para essa busca.</div>`;
      }
    }

    search.addEventListener("input", renderList);
    document.getElementById("btnPathHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî Patologias", "Dica curta", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Use como <b>check mental</b> para estudo. Na pr√°tica real, siga o <b>protocolo institucional</b> e a avalia√ß√£o cl√≠nica.
        </div>
      `);
    });

    renderList();
  }

  // --------- Review ----------
  function renderReview(){
    const logs = appState.reviewLog || [];
    const top = logs.slice(0, 40);

    const html = `
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">üìö Revis√£o</div>
              <div class="text-slate-300 mt-2">Seu hist√≥rico recente.</div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="btnClearReview" class="btn-big btn-danger">üßπ Limpar</button>
            </div>
          </div>

          <div class="mt-4 grid gap-3" id="reviewList"></div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üéØ Plano r√°pido</div>
          <div class="text-slate-300 mt-2">Gerado a partir de erros recentes.</div>
          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="studyPlan"></div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üìö Revis√£o", "Hist√≥rico e refor√ßo de temas.", html));

    const list = document.getElementById("reviewList");
    if(top.length === 0){
      list.innerHTML = `<div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4 text-slate-300">Sem hist√≥rico ainda.</div>`;
    } else {
      list.innerHTML = top.map(item => reviewCard(item)).join("");
    }

    // plan
    const wrongs = logs.filter(x=>x.type==="quiz" && x.ok===false);
    const counts = {};
    wrongs.forEach(w => counts[w.topic] = (counts[w.topic]||0)+1);
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const plan = document.getElementById("studyPlan");

    if(sorted.length === 0){
      plan.innerHTML = `
        <div class="font-extrabold">‚úÖ Sem erros recentes em quiz</div>
        <div class="text-slate-300 mt-2">Suba n√≠vel e varie tema/especialidade.</div>
      `;
    } else {
      const [t, n] = sorted[0];
      plan.innerHTML = `
        <div class="font-extrabold">Tema mais fraco: ${escapeHtml(t)}</div>
        <div class="text-slate-300 mt-2">Erros recentes: <b>${n}</b></div>
        <div class="text-slate-300 text-sm mt-3">
          Fa√ßa <b>5 quest√µes</b> desse tema e <b>1 caso</b> relacionado, focando em: prioridade, tempo-depend√™ncia e seguran√ßa.
        </div>
      `;
    }

    document.getElementById("btnClearReview").addEventListener("click", ()=>{
      appState.reviewLog = [];
      saveState();
      toast("warn","Revis√£o apagada","Hist√≥rico removido (score mantido).");
      go("review");
    });
  }

  function reviewCard(item){
    const d = new Date(item.t);
    const stamp = isNaN(d.getTime()) ? "" : d.toLocaleString("pt-BR");
    let icon="‚ÑπÔ∏è", title="Registro", body="";

    if(item.type === "quiz"){
      icon = item.ok ? "‚úÖ" : "‚ùå";
      title = `Quiz ‚Ä¢ ${item.topic} ‚Ä¢ N${item.level}`;
      body = item.ok ? "Acerto." : "Erro (revise a justificativa no m√≥dulo Quiz).";
    } else if(item.type === "case"){
      icon = item.ok ? "üìã" : "üìã";
      title = `Caso ‚Ä¢ ${item.title}`;
      body = `${item.ok ? "Correto." : "Incorreto."} Sele√ß√£o: ${item.selected || "-"}`;
    } else if(item.type === "triage"){
      icon = item.ok ? "üö¶" : "üö¶";
      title = `Triagem ‚Ä¢ ${item.scenario}`;
      body = `${item.ok ? "Correto." : "Incorreto."} Sele√ß√£o: ${item.choice || "-"}`;
    } else if(item.type === "checklist"){
      icon = "‚úÖ";
      title = `Checklist ‚Ä¢ ${item.title}`;
      body = `Resultado: ${item.pct}% (${item.correct} acertos)`;
    } else if(item.type === "score"){
      icon = item.delta > 0 ? "‚ú®" : "‚Äî";
      title = `Score ${item.delta>0?"+":""}${item.delta}`;
      body = item.why || "";
    }

    return `
      <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
        <div class="flex items-start gap-3">
          <div class="text-2xl">${icon}</div>
          <div class="flex-1">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="font-extrabold">${escapeHtml(title)}</div>
              <div class="text-xs text-slate-400">${escapeHtml(stamp)}</div>
            </div>
            <div class="text-slate-300 text-sm mt-1">${escapeHtml(body)}</div>
          </div>
        </div>
      </div>
    `;
  }

  // --------- Small UI helpers ----------
  function miniNote(title, text){
    return `
      <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
        <div class="font-extrabold">${escapeHtml(title)}</div>
        <div class="text-slate-300 text-sm mt-1">${escapeHtml(text)}</div>
      </div>
    `;
  }

  // --------- Top actions / sidebar controls ----------
  el("btnToggleSidebar")?.addEventListener("click", ()=> el("sidebar").classList.toggle("hidden"));
  el("btnResetAll")?.addEventListener("click", resetProgress);
  el("btnQuickReset")?.addEventListener("click", resetProgress);

  el("btnChangeName")?.addEventListener("click", ()=>{
    openModal("‚úèÔ∏è Nome do aluno","Digite como aparecer√° no painel.", `
      <div class="space-y-3">
        <input id="nameInput" class="w-full rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold" value="${escapeHtml(appState.userName||"Aluno")}"/>
        <button id="btnSaveName" class="btn-big btn-ok w-full">üíæ Salvar</button>
      </div>
    `);
    setTimeout(()=>document.getElementById("nameInput")?.focus(), 50);
    document.getElementById("btnSaveName").addEventListener("click", ()=>{
      const v = (document.getElementById("nameInput").value || "").trim();
      appState.userName = v || "Aluno";
      saveState();
      closeModal();
      toast("ok","Atualizado","Nome salvo.");
    });
  });

  el("btnSound")?.addEventListener("click", ()=>{
    appState.sound = !appState.sound;
    saveState();
    toast("info","Som", appState.sound ? "Ativado." : "Desativado.");
    beep(740, 60);
  });

  el("btnFocus")?.addEventListener("click", ()=>{
    appState.focusMode = !appState.focusMode;
    saveState();
    toast("info","Foco", appState.focusMode ? "Modo foco ligado." : "Modo foco desligado.");
  });

  // Nav
  document.querySelectorAll(".navBtn").forEach(btn => btn.addEventListener("click", ()=>go(btn.dataset.view)));

  // Init
  renderScoreWidgets();
  go("dashboard");
})();
</script>
</body>
</html>
