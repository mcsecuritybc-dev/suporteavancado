<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSim Pro v2.0 - Plataforma Avançada</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #005f73;
            --secondary: #0a9396;
            --accent: #94d2bd;
            --bg-light: #f0f4f8;
            --white: #ffffff;
            --danger: #ae2012;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --text-dark: #333;
            --sidebar-width: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        
        body { background-color: var(--bg-light); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        #sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #023047 0%, var(--primary) 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            transition: 0.3s;
            z-index: 100;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        .brand { padding: 25px; font-size: 1.6rem; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; }
        .brand i { color: var(--accent); }

        .menu { list-style: none; padding: 20px 0; flex: 1; overflow-y: auto; }
        .menu-item { cursor: pointer; transition: 0.2s; }
        .menu-link { padding: 15px 25px; display: flex; align-items: center; gap: 15px; opacity: 0.8; text-decoration: none; color: white; }
        .menu-link:hover, .menu-link.active { background: rgba(255,255,255,0.1); opacity: 1; border-left: 4px solid var(--accent); }
        
        .submenu { list-style: none; background: rgba(0,0,0,0.2); display: none; }
        .submenu.open { display: block; }
        .submenu li a { padding: 12px 25px 12px 55px; display: block; color: #ccc; font-size: 0.9rem; text-decoration: none; }
        .submenu li a:hover { color: white; background: rgba(255,255,255,0.05); }

        .user-profile { padding: 20px; background: rgba(0,0,0,0.2); font-size: 0.9rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

        /* --- Main Content --- */
        #main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { color: var(--primary); font-size: 1.8rem; }
        
        .btn-toggle { display: none; background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; }

        /* --- Components --- */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; border-top: 5px solid var(--secondary); display: flex; flex-direction: column; justify-content: space-between; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { color: var(--text-dark); margin-bottom: 10px; }
        .tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; }
        .tag.bls { background: #e0f7fa; color: #006064; }
        .tag.acls { background: #ffebee; color: #c62828; }
        .tag.atls { background: #e8f5e9; color: #2e7d32; }

        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; width: 100%; margin-top: 10px; }
        .btn-primary { background: var(--secondary); color: var(--white); }
        .btn-primary:hover { background: var(--primary); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }

        /* --- Sections --- */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Simulation Interface --- */
        .sim-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .timer-box { background: var(--danger); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-family: monospace; font-size: 1.2rem; }
        
        .patient-monitor { 
            background: #1a1a1a; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
            border: 2px solid #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        
        .vitals-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .vital-card { background: #000; border: 1px solid #333; padding: 10px; border-radius: 8px; text-align: center; }
        .vital-label { color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .vital-value { color: #0f0; font-family: 'Courier New', monospace; font-size: 2rem; font-weight: bold; text-shadow: 0 0 5px rgba(0,255,0,0.5); }
        .vital-unit { color: #0f0; font-size: 0.8rem; }

        /* ECG SVG Container */
        .ecg-container { width: 100%; height: 120px; background: #001100; border: 1px solid #003300; border-radius: 8px; overflow: hidden; position: relative; }
        .ecg-grid { position: absolute; width: 100%; height: 100%; background-image: linear-gradient(#002200 1px, transparent 1px), linear-gradient(90deg, #002200 1px, transparent 1px); background-size: 20px 20px; opacity: 0.3; }
        #ecg-path { fill: none; stroke: #0f0; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 2px #0f0); }

        .decision-area { background: white; padding: 25px; border-radius: 12px; }
        .decision-btn { 
            text-align: left; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; 
            background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: 0.2s; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .decision-btn:hover { background: #e3f2fd; border-color: var(--secondary); transform: translateX(5px); }

        /* --- Quiz Setup --- */
        .quiz-setup { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-dark); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }

        /* --- Quiz Active --- */
        .quiz-active { max-width: 800px; margin: 0 auto; }
        .quiz-timer-bar { height: 6px; background: #eee; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .quiz-timer-fill { height: 100%; background: var(--secondary); width: 100%; transition: width 1s linear; }
        
        /* --- Memory Game --- */
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; max-width: 800px; margin: 20px auto; }
        .memory-card { 
            aspect-ratio: 1; background: var(--secondary); border-radius: 12px; cursor: pointer; 
            perspective: 1000px; position: relative; transform-style: preserve-3d; transition: transform 0.6s;
        }
        .memory-card.flipped { transform: rotateY(180deg); }
        .card-face { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-front { background: var(--white); border: 2px solid var(--secondary); color: var(--primary); }
        .card-back { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; font-size: 2rem; }
        .card-text { font-size: 0.8rem; margin-top: 5px; font-weight: bold; text-align: center; padding: 0 5px; }

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar { position: fixed; left: -280px; height: 100%; }
            #sidebar.open { left: 0; }
            .btn-toggle { display: block; }
            .vitals-grid { grid-template-columns: repeat(2, 1fr); }
            .memory-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="brand">
            <i class="fas fa-heart-pulse"></i> MedSim Pro
        </div>
        <ul class="menu">
            <li class="menu-item">
                <a class="menu-link active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Dashboard</a>
            </li>
            <li class="menu-item">
                <a class="menu-link" onclick="toggleSubmenu('sub-cases')"><i class="fas fa-user-nurse"></i> Casos Clínicos <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.8rem;"></i></a>
                <ul id="sub-cases" class="submenu">
                    <li><a href="#" onclick="nav('cases'); filterCases('all')">Todos</a></li>
                    <li><a href="#" onclick="nav('cases'); filterCases('ACLS')">ACLS</a></li>
                    <li><a href="#" onclick="nav('cases'); filterCases('ATLS')">ATLS</a></li>
                    <li><a href="#" onclick="nav('cases'); filterCases('Neonato')">Neonato</a></li>
                </ul>
            </li>
            <li class="menu-item">
                <a class="menu-link" onclick="nav('quiz-setup')"><i class="fas fa-clipboard-question"></i> Quiz Arena</a>
            </li>
            <li class="menu-item">
                <a class="menu-link" onclick="nav('games')"><i class="fas fa-gamepad"></i> Jogos</a>
            </li>
            <li class="menu-item">
                <a class="menu-link" onclick="nav('tools')"><i class="fas fa-tools"></i> Equipamentos</a>
            </li>
        </ul>
        <div class="user-profile">
            <div class="stat-row"><span>Nível:</span> <strong id="user-level">Iniciante</strong></div>
            <div class="stat-row"><span>XP:</span> <strong id="xp-display">0</strong></div>
            <div class="stat-row"><span>Pontos:</span> <strong id="score-display">0</strong></div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
        <header>
            <button class="btn-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h1 id="page-title">Dashboard</h1>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="timer-box" id="global-timer" style="display: none; background: var(--primary);">03:00</div>
                <div style="text-align: right;">
                    <div style="font-size: 0.8rem; color: #666;">Bem-vindo,</div>
                    <strong>Dr. Usuário</strong>
                </div>
            </div>
        </header>

        <!-- DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="card-grid">
                <div class="card" style="border-color: var(--success);">
                    <div>
                        <h3><i class="fas fa-check-circle"></i> Casos Completos</h3>
                        <p id="dash-cases" style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">0</p>
                        <p class="text-muted">Total de casos disponíveis</p>
                    </div>
                </div>
                <div class="card" style="border-color: var(--warning);">
                    <div>
                        <h3><i class="fas fa-brain"></i> Precisão no Quiz</h3>
                        <p id="dash-quiz" style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">0%</p>
                        <p class="text-muted">Média de acertos</p>
                    </div>
                </div>
                <div class="card" style="border-color: var(--accent);">
                    <div>
                        <h3><i class="fas fa-trophy"></i> Ranking</h3>
                        <p style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;">Top 10%</p>
                        <p class="text-muted">Entre os usuários ativos</p>
                    </div>
                </div>
            </div>

            <h2 style="margin-top: 40px; color: var(--text-dark); border-left: 5px solid var(--primary); padding-left: 15px;">Casos em Destaque</h2>
            <div class="card-grid" style="margin-top: 20px;" id="featured-cases">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- CASES LIST & SIMULATOR -->
        <div id="cases" class="section">
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button class="btn btn-outline" style="width: auto;" onclick="filterCases('all')">Todos</button>
                <button class="btn btn-outline" style="width: auto;" onclick="filterCases('ACLS')">ACLS</button>
                <button class="btn btn-outline" style="width: auto;" onclick="filterCases('ATLS')">ATLS</button>
                <button class="btn btn-outline" style="width: auto;" onclick="filterCases('Neonato')">Neonato</button>
            </div>

            <div class="card-grid" id="cases-list">
                <!-- Populated by JS -->
            </div>
            
            <!-- Active Simulation View -->
            <div id="active-sim" style="display: none;">
                <div class="sim-header">
                    <button class="btn btn-outline" style="width: auto;" onclick="closeSimulation()"><i class="fas fa-arrow-left"></i> Voltar</button>
                    <div class="timer-box" id="sim-timer">03:00</div>
                </div>

                <div class="patient-monitor">
                    <div class="vitals-grid">
                        <div class="vital-card">
                            <div class="vital-label">FC (bpm)</div>
                            <div class="vital-value" id="sim-hr">--</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-label">PA (mmHg)</div>
                            <div class="vital-value" id="sim-bp">--/--</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-label">SpO2 (%)</div>
                            <div class="vital-value" id="sim-spo2">--</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-label">FR (rpm)</div>
                            <div class="vital-value" id="sim-rr">--</div>
                        </div>
                    </div>
                    <div class="ecg-container">
                        <div class="ecg-grid"></div>
                        <svg width="100%" height="100%" viewBox="0 0 800 120" preserveAspectRatio="none">
                            <path id="ecg-path" d="M0,60 L800,60" />
                        </svg>
                    </div>
                </div>

                <div class="decision-area">
                    <h3 id="sim-scenario" style="margin-bottom: 15px; color: var(--primary);">Cenário</h3>
                    <div id="sim-feedback" style="padding: 15px; background: #e8f5e9; color: #2e7d32; margin-bottom: 15px; border-radius: 8px; display: none;"></div>
                    <div id="sim-options" class="decision-tree">
                        <!-- Options injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- QUIZ SETUP -->
        <div id="quiz-setup" class="section">
            <div class="quiz-setup">
                <h2 style="margin-bottom: 20px; text-align: center;">Configurar Quiz</h2>
                <div class="form-group">
                    <label>Especialidade</label>
                    <select id="quiz-spec" class="form-control">
                        <option value="all">Geral (Misto)</option>
                        <option value="BLS">Suporte Básico (BLS)</option>
                        <option value="ACLS">Suporte Avançado (ACLS)</option>
                        <option value="ATLS">Trauma (ATLS)</option>
                        <option value="Pediatria">Pediatria/Neonato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nível de Dificuldade</label>
                    <select id="quiz-diff" class="form-control">
                        <option value="all">Misto</option>
                        <option value="easy">Fácil (Conceitos)</option>
                        <option value="medium">Médio (Aplicação)</option>
                        <option value="hard">Difícil (Casos Complexos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade de Questões</label>
                    <select id="quiz-count" class="form-control">
                        <option value="5">5 Questões</option>
                        <option value="10">10 Questões</option>
                        <option value="20">20 Questões</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="startQuiz()">Iniciar Quiz</button>
            </div>
        </div>

        <!-- QUIZ ACTIVE -->
        <div id="quiz-active" class="section">
            <div class="quiz-active">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span id="quiz-progress">Questão 1/10</span>
                    <span id="quiz-score-live">Pontos: 0</span>
                </div>
                <div class="quiz-timer-bar"><div class="quiz-timer-fill" id="quiz-timer-fill"></div></div>
                
                <div class="card" style="border-top: none; box-shadow: none; padding: 0;">
                    <h2 id="quiz-question" style="font-size: 1.4rem; margin-bottom: 20px;">Carregando...</h2>
                    <div class="options-grid" id="quiz-options" style="display: grid; gap: 15px;">
                        <!-- Options -->
                    </div>
                </div>
                
                <div id="quiz-explanation" style="margin-top: 20px; padding: 20px; background: #e3f2fd; border-left: 5px solid var(--primary); border-radius: 8px; display: none;">
                    <strong>Explicação Técnica:</strong> <span id="quiz-exp-text"></span>
                </div>
                <button class="btn btn-primary" id="next-q-btn" style="margin-top: 20px; display: none;" onclick="nextQuestion()">Próxima Questão</button>
                <button class="btn btn-danger" style="margin-top: 20px; display: none;" id="finish-quiz-btn" onclick="finishQuiz()">Ver Resultados</button>
            </div>
        </div>

        <!-- GAMES -->
        <div id="games" class="section">
            <div class="card-grid">
                <div class="card">
                    <h3><i class="fas fa-braille"></i> Memória Médica</h3>
                    <p>Associe o equipamento à sua função ou nome.</p>
                    <button class="btn btn-primary" onclick="startMemoryGame()">Jogar Agora</button>
                </div>
                <div class="card">
                    <h3><i class="fas fa-crown"></i> Show do Milhão</h3>
                    <p>Modo sobrevivência com ajudas.</p>
                    <button class="btn btn-primary" disabled style="opacity: 0.6; cursor: not-allowed;">Em Breve</button>
                </div>
            </div>

            <!-- Memory Game Board -->
            <div id="memory-board" style="display: none; text-align: center; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; max-width: 800px; margin: 0 auto 20px;">
                    <h3>Encontre os pares!</h3>
                    <button class="btn btn-danger" style="width: auto;" onclick="document.getElementById('memory-board').style.display='none'">Sair</button>
                </div>
                <div class="memory-grid" id="memory-grid"></div>
            </div>
        </div>

        <!-- TOOLS / EQUIPMENT -->
        <div id="tools" class="section">
            <div class="card-grid">
                <div class="card">
                    <h3>Monitor Cardíaco</h3>
                    <p>Simulador de ritmos e interpretação de ECG.</p>
                    <button class="btn btn-primary" onclick="loadTool('monitor')">Abrir Ferramenta</button>
                </div>
                <div class="card">
                    <h3>Ventilador Mecânico</h3>
                    <p>Configuração de modos (VC, PC, PSV).</p>
                    <button class="btn btn-primary" onclick="alert('Funcionalidade em desenvolvimento')">Em Breve</button>
                </div>
            </div>

            <div id="tool-monitor" style="margin-top: 30px; display: none;">
                <div class="patient-monitor" style="max-width: 800px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <h3 style="color: white;">Simulador de Ritmos</h3>
                        <button class="btn btn-danger" style="width: auto; padding: 5px 10px;" onclick="document.getElementById('tool-monitor').style.display='none'">X</button>
                    </div>
                    <div class="ecg-container" style="height: 200px; margin-bottom: 20px;">
                        <div class="ecg-grid"></div>
                        <svg width="100%" height="100%" viewBox="0 0 800 200" preserveAspectRatio="none">
                            <path id="tool-ecg-path" fill="none" stroke="#0f0" stroke-width="2" d="M0,100 L800,100" />
                        </svg>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-outline" style="width: auto;" onclick="setToolRhythm('sinus')">Ritmo Sinusal</button>
                        <button class="btn btn-outline" style="width: auto;" onclick="setToolRhythm('tachy')">Taquicardia Sinusal</button>
                        <button class="btn btn-outline" style="width: auto;" onclick="setToolRhythm('afib')">Fibrilação Atrial</button>
                        <button class="btn btn-danger" style="width: auto;" onclick="setToolRhythm('vfib')">Fibrilação Ventricular</button>
                        <button class="btn btn-outline" style="width: auto;" onclick="setToolRhythm('asystole')">Assistolia</button>
                        <button class="btn btn-outline" style="width: auto;" onclick="setToolRhythm('pvc')">Extra-sístole (PVC)</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATABASE ---
        const db = {
            cases: [
                {
                    id: 'acls_01', type: 'ACLS', title: 'PCR em FV', diff: 'Médio',
                    desc: 'Paciente 55 anos colapsa no corredor. Monitor mostra FV.',
                    start: {
                        text: "Paciente inconsciente, apneico, sem pulso. Monitor acoplado mostra Fibrilação Ventricular.",
                        vitals: { hr: 0, bp: '---', spo2: '--', rr: 0, rhythm: 'vfib' },
                        options: [
                            { text: "Iniciar RCP e carregar desfibrilador", next: 'step_2', feedback: "Correto. RCP enquanto carrega é crucial." },
                            { text: "Administrar Adrenalina 1mg", next: 'fail_drug', feedback: "Incorreto. Na FV, o choque é a prioridade." }
                        ]
                    },
                    steps: {
                        'step_2': {
                            text: "Desfibrilador carregado. Ritmo ainda em FV.",
                            vitals: { hr: 0, bp: '---', spo2: '--', rr: 0, rhythm: 'vfib' },
                            options: [
                                { text: "Choque 200J Bifásico", next: 'step_3', feedback: "Correto. Choque imediato." },
                                { text: "Checar pulso", next: 'fail_pulse', feedback: "Erro. Não perca tempo checando pulso se o ritmo é chocável." }
                            ]
                        },
                        'step_3': {
                            text: "Choque aplicado. O que fazer agora?",
                            vitals: { hr: 0, bp: '---', spo2: '--', rr: 0, rhythm: 'asystole' }, // Simula linha de base pós choque
                            options: [
                                { text: "Retomar RCP imediatamente (2 min)", next: 'success', feedback: "Correto! RCP pós-choque é vital." },
                                { text: "Checar ritmo", next: 'fail_check', feedback: "Incorreto. RCP primeiro, ritmo depois de 2 min." }
                            ]
                        },
                        'success': { text: "ROSC Obtido! Paciente retorna com ritmo sinusal.", vitals: { hr: 80, bp: '110/70', spo2: '96%', rr: 16, rhythm: 'sinus' }, options: [] },
                        'fail_drug': { text: "Tempo perdido. FV degenerou para Assistolia.", vitals: { hr: 0, bp: '---', spo2: '--', rr: 0, rhythm: 'asystole' }, options: [] },
                        'fail_pulse': { text: "Pausa prolongada reduziu chances de sobrevivência.", vitals: { hr: 0, bp: '---', spo2: '--', rr: 0, rhythm: 'vfib' }, options: [] },
                        'fail_check': { text: "A pausa para checar ritmo sem RCP prévia foi fatal.", vitals: { hr: 0, bp: '---', spo2: '--', rr: 0, rhythm: 'asystole' }, options: [] }
                    }
                },
                {
                    id: 'atls_01', type: 'ATLS', title: 'Trauma Penetrante', diff: 'Difícil',
                    desc: 'Vítima de arma branca no tórax esquerdo. Instável.',
                    start: {
                        text: "Paciente agitado, PA 70/40, FC 140. Ferimento tórax esquerdo. SatO2 88%.",
                        vitals: { hr: 140, bp: '70/40', spo2: '88', rr: 32, rhythm: 'tachy' },
                        options: [
                            { text: "Intubação Orotraqueal", next: 'fail_intub', feedback: "Risco. Hipotensão grave pode levar a PCR na indução." },
                            { text: "Acesso Venoso + Drenagem Torácica", next: 'step_2', feedback: "Correto. Tratar causa reversível (Pneumotórax Hipertensivo?)." }
                        ]
                    },
                    steps: {
                        'step_2': {
                            text: "Drenagem com saída de ar sob pressão. PA melhora para 90/60.",
                            vitals: { hr: 120, bp: '90/60', spo2: '94', rr: 24, rhythm: 'tachy' },
                            options: [
                                { text: "TC de Tórax", next: 'success', feedback: "Agora está estável o suficiente para imagem." },
                                { text: "Laparotomia", next: 'fail_surg', feedback: "Indicação incorreta sem evidência de sangramento abdominal." }
                            ]
                        },
                        'success': { text: "Diagnóstico confirmado: Pneumotórax Hipertensivo resolvido.", vitals: { hr: 90, bp: '120/80', spo2: '98', rr: 18, rhythm: 'sinus' }, options: [] },
                        'fail_intub': { text: "Paciente entrou em PCR na indução anestésica.", vitals: { hr: 0, bp: '---', spo2: '--', rr: 0, rhythm: 'asystole' }, options: [] },
                        'fail_surg': { text: "Cirurgia negativa. Paciente deteriorou.", vitals: { hr: 150, bp: '60/40', spo2: '80', rr: 35, rhythm: 'tachy' }, options: [] }
                    }
                },
                {
                    id: 'neo_01', type: 'Neonato', title: 'Reanimação Neonatal', diff: 'Médio',
                    desc: 'RN 34 semanas, nascido com líquido meconial, não chora.',
                    start: {
                        text: "RN flácido, cianótico, FC 60 bpm. Líquido amniótico com mecônio.",
                        vitals: { hr: 60, bp: '--', spo2: '70', rr: 0, rhythm: 'brady' },
                        options: [
                            { text: "Aspirar traqueia imediatamente", next: 'fail_asp', feedback: "Diretriz atual: Não aspirar traqueia rotineiramente se não vigoroso." },
                            { text: "Secar, estimular e posicionar", next: 'step_2', feedback: "Correto. Medidas iniciais." }
                        ]
                    },
                    steps: {
                        'step_2': {
                            text: "Após 30s de medidas iniciais, FC permanece 60 bpm e apneico.",
                            vitals: { hr: 60, bp: '--', spo2: '70', rr: 0, rhythm: 'brady' },
                            options: [
                                { text: "Iniciar VPP (Ventilação com Pressão Positiva)", next: 'success', feedback: "Correto. FC < 100 indica necessidade de VPP." },
                                { text: "Massagem Cardíaca", next: 'fail_massage', feedback: "Ainda não. FC > 60. Priorize ventilação." }
                            ]
                        },
                        'success': { text: "FC sobe para 120 bpm após VPP eficaz.", vitals: { hr: 120, bp: '--', spo2: '90', rr: 40, rhythm: 'sinus' }, options: [] },
                        'fail_asp': { text: "Tempo perdido na aspiração. Hipóxia piorou.", vitals: { hr: 40, bp: '--', spo2: '60', rr: 0, rhythm: 'brady' }, options: [] },
                        'fail_massage': { text: "Massagem sem ventilação adequada é ineficaz.", vitals: { hr: 50, bp: '--', spo2: '65', rr: 0, rhythm: 'brady' }, options: [] }
                    }
                },
                // Adicione mais casos aqui seguindo o modelo
            ],
            questions: [
                // ACLS
                { q: "Qual a dose de Amiodarona na 3ª choque em PCR por FV/TV?", spec: "ACLS", diff: "hard", options: ["150mg", "300mg", "1mg/kg", "5mg/kg"], ans: 1, exp: "300mg em bolus é a dose inicial para FV/TV refratária." },
                { q: "Qual a frequência de ventilação em via aérea avançada na PCR?", spec: "ACLS", diff: "medium", options: ["10 rpm", "12 rpm", "20 rpm", "30 rpm"], ans: 0, exp: "1 ventilação a cada 6 segundos (10 rpm) sem pausar compressões." },
                // BLS
                { q: "Qual a profundidade das compressões em adultos?", spec: "BLS", diff: "easy", options: ["2-3 cm", "5-6 cm", "Pelo menos 7 cm", "Metade do tórax"], ans: 1, exp: "Entre 5 e 6 cm de profundidade." },
                { q: "Qual a sequência do C-A-B?", spec: "BLS", diff: "easy", options: ["Circulação, Via Aérea, Respiração", "Compressões, Ar, Balão", "Cardíaco, Abdomen, Brain"], ans: 0, exp: "Circulation, Airway, Breathing." },
                // ATLS
                { q: "Sinal de Grey-Turner indica:", spec: "ATLS", diff: "hard", options: ["Fratura de crânio", "Sangramento retroperitoneal", "Pneumotórax", "Ruptura de baço"], ans: 1, exp: "Equimose em flancos, sugere sangramento retroperitoneal." },
                { q: "Glasgow 8 indica:", spec: "ATLS", diff: "medium", options: ["Trauma leve", "Necessidade de intubação", "Óbito cerebral", "Coma profundo"], ans: 1, exp: "Glasgow <= 8, intube (G8). Protege a via aérea." },
                // Pediatria
                { q: "Dose de Adrenalina em PCR pediátrica (IV/IO)?", spec: "Pediatria", diff: "hard", options: ["0.01 mg/kg", "0.1 mg/kg", "1 mg fixo", "0.5 mg/kg"], ans: 0, exp: "0.01 mg/kg (0.1 mL/kg da solução 1:10.000)." },
                { q: "FC normal para recém-nascido termo:", spec: "Pediatria", diff: "easy", options: ["60-80", "80-100", "120-160", "160-180"], ans: 2, exp: "Entre 120 e 160 bpm é o esperado." }
            ]
        };

        // --- STATE ---
        let state = {
            xp: 0, score: 0, casesCompleted: 0,
            currentSim: null, simTimer: null,
            quizQueue: [], quizIndex: 0, quizScore: 0, quizTimer: null
        };

        // --- NAVIGATION ---
        function nav(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            // Update Menu Active State
            document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active'));
            // Simple logic to highlight parent if child clicked could be added here
            
            const titles = {
                'dashboard': 'Dashboard', 'cases': 'Casos Clínicos', 
                'quiz-setup': 'Configurar Quiz', 'quiz-active': 'Quiz em Andamento',
                'games': 'Jogos', 'tools': 'Equipamentos'
            };
            document.getElementById('page-title').innerText = titles[sectionId] || 'MedSim Pro';
            
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
            
            // Reset views if needed
            if(sectionId === 'dashboard') renderDashboard();
            if(sectionId === 'cases') renderCasesList('all');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleSubmenu(id) {
            document.getElementById(id).classList.toggle('open');
        }

        function updateStats() {
            document.getElementById('xp-display').innerText = state.xp;
            document.getElementById('score-display').innerText = state.score;
            
            // Level logic
            let level = "Iniciante";
            if(state.xp > 500) level = "Residente";
            if(state.xp > 1500) level = "Especialista";
            if(state.xp > 3000) level = "Mestre";
            document.getElementById('user-level').innerText = level;

            localStorage.setItem('medsim_state_v2', JSON.stringify(state));
        }

        // --- ECG ENGINE (SVG) ---
        let ecgAnimationId;
        let ecgPoints = [];
        const maxPoints = 200; // Resolution
        
        function initECG(elementId, type) {
            const path = document.getElementById(elementId);
            ecgPoints = new Array(maxPoints).fill(100); // Start flat
            
            if(ecgAnimationId) cancelAnimationFrame(ecgAnimationId);
            
            let offset = 0;
            
            function draw() {
                // Generate new point based on rhythm
                let y = 100; // Baseline
                const phase = (offset % 100) / 100; // 0 to 1 cycle

                if (type === 'sinus') {
                    // P wave, QRS, T wave simulation
                    if (phase > 0.1 && phase < 0.15) y -= 10; // P
                    if (phase > 0.2 && phase < 0.22) y += 10; // Q
                    if (phase > 0.22 && phase < 0.25) y -= 80; // R (Spike)
                    if (phase > 0.25 && phase < 0.27) y += 15; // S
                    if (phase > 0.4 && phase < 0.5) y -= 15; // T
                } else if (type === 'tachy') {
                    // Faster sinus
                    const fastPhase = (offset % 50) / 50;
                    if (fastPhase > 0.2 && fastPhase < 0.25) y -= 80;
                } else if (type === 'vfib') {
                    // Chaotic
                    y = 100 + (Math.random() * 60 - 30);
                } else if (type === 'asystole') {
                    // Flat with slight wander
                    y = 100 + (Math.random() * 4 - 2);
                } else if (type === 'brady') {
                     // Slow sinus
                     const slowPhase = (offset % 150) / 150;
                     if (slowPhase > 0.2 && slowPhase < 0.25) y -= 80;
                } else if (type === 'afib') {
                    // Irregular baseline + QRS
                    y = 100 + (Math.random() * 10 - 5);
                    if (Math.random() > 0.7) y -= 80; // Random QRS
                } else if (type === 'pvc') {
                    // Normal then big spike
                    if (offset % 200 > 150) {
                         y = 100 + (Math.random() * 40 - 20); // Premature big wave
                    } else {
                        const phase = (offset % 100) / 100;
                        if (phase > 0.2 && phase < 0.25) y -= 80;
                    }
                }

                ecgPoints.push(y);
                ecgPoints.shift();
                
                // Build SVG Path
                let d = `M 0 ${ecgPoints[0]}`;
                const stepX = 800 / maxPoints;
                for(let i=1; i<ecgPoints.length; i++) {
                    d += ` L ${i*stepX} ${ecgPoints[i]}`;
                }
                
                path.setAttribute('d', d);
                offset++;
                ecgAnimationId = requestAnimationFrame(draw);
            }
            draw();
        }

        // --- CASES LOGIC ---
        function renderDashboard() {
            document.getElementById('dash-cases').innerText = state.casesCompleted;
            const featured = document.getElementById('featured-cases');
            featured.innerHTML = db.cases.slice(0, 3).map(c => createCaseCard(c)).join('');
        }

        function createCaseCard(c) {
            return `
                <div class="card">
                    <div>
                        <span class="tag ${c.type.toLowerCase()}">${c.type}</span>
                        <h3>${c.title}</h3>
                        <p>${c.desc}</p>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                            <i class="fas fa-star" style="color: gold"></i> Dificuldade: ${c.diff}
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="startSimulation('${c.id}')">Iniciar Caso</button>
                </div>
            `;
        }

        function filterCases(type) {
            renderCasesList(type);
        }

        function renderCasesList(filter) {
            const list = document.getElementById('cases-list');
            const filtered = filter === 'all' ? db.cases : db.cases.filter(c => c.type === filter);
            list.innerHTML = filtered.map(c => createCaseCard(c)).join('');
        }

        function startSimulation(caseId) {
            const caseData = db.cases.find(c => c.id === caseId);
            if(!caseData) return;

            document.getElementById('cases-list').style.display = 'none';
            document.getElementById('active-sim').style.display = 'block';
            
            state.currentSim = caseData;
            loadStep(caseData.start);
            
            // Start Timer
            startTimer(180, 'sim-timer', () => {
                alert("Tempo esgotado! O paciente deteriorou.");
                closeSimulation();
            });
        }

        function startTimer(seconds, elementId, callback) {
            clearInterval(state.simTimer);
            const display = document.getElementById(elementId);
            let remaining = seconds;
            
            function update() {
                const m = Math.floor(remaining / 60).toString().padStart(2, '0');
                const s = (remaining % 60).toString().padStart(2, '0');
                display.innerText = `${m}:${s}`;
                
                if(remaining <= 0) {
                    clearInterval(state.simTimer);
                    if(callback) callback();
                }
                remaining--;
            }
            update();
            state.simTimer = setInterval(update, 1000);
        }

        function loadStep(stepData) {
            // Update Vitals UI
            document.getElementById('sim-hr').innerText = stepData.vitals.hr;
            document.getElementById('sim-bp').innerText = stepData.vitals.bp;
            document.getElementById('sim-spo2').innerText = stepData.vitals.spo2;
            document.getElementById('sim-rr').innerText = stepData.vitals.rr;
            
            // Update ECG
            initECG('ecg-path', stepData.vitals.rhythm || 'sinus');

            // Update Text
            document.getElementById('sim-scenario').innerText = stepData.text;
            document.getElementById('sim-feedback').style.display = 'none';
            
            const optionsContainer = document.getElementById('sim-options');
            optionsContainer.innerHTML = '';
            
            if(stepData.options.length === 0) {
                const isWin = stepData.text.includes('ROSC') || stepData.text.includes('confirmado') || stepData.text.includes('Obtido');
                optionsContainer.innerHTML = `
                    <div style="text-align:center; padding:20px;">
                        <h2 style="color:${isWin ? 'var(--success)' : 'var(--danger)'}">
                            ${isWin ? 'Caso Concluído com Sucesso!' : 'Desfecho Fatal'}
                        </h2>
                        <p>${stepData.text}</p>
                        <button class="btn btn-primary" style="margin-top:10px;" onclick="closeSimulation()">Voltar à Lista</button>
                    </div>`;
                if(isWin) {
                    state.xp += 150;
                    state.score += 100;
                    state.casesCompleted++;
                    updateStats();
                }
                clearInterval(state.simTimer);
                return;
            }

            stepData.options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'decision-btn';
                btn.innerHTML = `<span>${opt.text}</span> <i class="fas fa-chevron-right"></i>`;
                btn.onclick = () => {
                    // Show Feedback
                    const fb = document.getElementById('sim-feedback');
                    fb.innerText = opt.feedback;
                    fb.style.display = 'block';
                    fb.style.background = opt.next.includes('success') ? '#d4edda' : '#f8d7da';
                    fb.style.color = opt.next.includes('success') ? '#155724' : '#721c24';
                    
                    // Disable buttons temporarily
                    const allBtns = document.querySelectorAll('.decision-btn');
                    allBtns.forEach(b => b.style.pointerEvents = 'none');

                    setTimeout(() => {
                        if(state.currentSim.steps[opt.next]) {
                            loadStep(state.currentSim.steps[opt.next]);
                        } else {
                            // Fallback for direct fail keys not in steps object
                            loadStep({ text: "Erro de fluxo no caso.", vitals: {hr:0,bp:'--',spo2:'--',rr:0, rhythm:'asystole'}, options: [] });
                        }
                    }, 2500);
                };
                optionsContainer.appendChild(btn);
            });
        }

        function closeSimulation() {
            clearInterval(state.simTimer);
            document.getElementById('active-sim').style.display = 'none';
            document.getElementById('cases-list').style.display = 'grid';
            state.currentSim = null;
            nav('cases');
        }

        // --- QUIZ LOGIC ---
        function startQuiz() {
            const spec = document.getElementById('quiz-spec').value;
            const diff = document.getElementById('quiz-diff').value;
            const count = parseInt(document.getElementById('quiz-count').value);

            // Filter Questions
            let pool = db.questions.filter(q => {
                const matchSpec = spec === 'all' || q.spec === spec;
                const matchDiff = diff === 'all' || q.diff === diff;
                return matchSpec && matchDiff;
            });

            // Shuffle and Slice
            pool.sort(() => 0.5 - Math.random());
            state.quizQueue = pool.slice(0, count);
            
            if(state.quizQueue.length === 0) {
                alert("Não há questões suficientes para esses filtros. Tente 'Geral'.");
                return;
            }

            state.quizIndex = 0;
            state.quizScore = 0;
            
            document.getElementById('quiz-setup').classList.remove('active');
            document.getElementById('quiz-active').classList.add('active');
            document.getElementById('page-title').innerText = 'Quiz em Andamento';
            
            loadQuestion();
        }

        function loadQuestion() {
            if(state.quizIndex >= state.quizQueue.length) {
                finishQuiz();
                return;
            }

            const q = state.quizQueue[state.quizIndex];
            document.getElementById('quiz-progress').innerText = `Questão ${state.quizIndex + 1}/${state.quizQueue.length}`;
            document.getElementById('quiz-score-live').innerText = `Pontos: ${state.quizScore}`;
            document.getElementById('quiz-question').innerText = q.q;
            document.getElementById('quiz-explanation').style.display = 'none';
            document.getElementById('next-q-btn').style.display = 'none';
            document.getElementById('finish-quiz-btn').style.display = 'none';

            const optsContainer = document.getElementById('quiz-options');
            optsContainer.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline';
                btn.style.textAlign = 'left';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(idx, q.ans, q.exp, btn);
                optsContainer.appendChild(btn);
            });

            // Start Timer for this question (3 mins = 180s)
            startQuizTimer(180);
        }

        function startQuizTimer(seconds) {
            clearInterval(state.quizTimer);
            const bar = document.getElementById('quiz-timer-fill');
            bar.style.width = '100%';
            bar.style.transition = 'none'; // Reset animation
            
            setTimeout(() => {
                bar.style.transition = `width ${seconds}s linear`;
                bar.style.width = '0%';
            }, 50);

            let remaining = seconds;
            state.quizTimer = setInterval(() => {
                remaining--;
                if(remaining <= 0) {
                    clearInterval(state.quizTimer);
                    alert("Tempo esgotado!");
                    nextQuestion();
                }
            }, 1000);
        }

        function checkAnswer(selected, correct, explanation, btnElement) {
            clearInterval(state.quizTimer);
            const allBtns = document.querySelectorAll('#quiz-options .btn');
            allBtns.forEach(b => b.disabled = true);

            if(selected === correct) {
                btnElement.classList.remove('btn-outline');
                btnElement.classList.add('btn-primary');
                btnElement.style.background = 'var(--success)';
                btnElement.style.borderColor = 'var(--success)';
                state.quizScore += 10;
                state.xp += 5;
            } else {
                btnElement.classList.remove('btn-outline');
                btnElement.classList.add('btn-danger');
                // Highlight correct
                allBtns[correct].classList.remove('btn-outline');
                allBtns[correct].style.background = 'var(--success)';
                allBtns[correct].style.borderColor = 'var(--success)';
            }

            document.getElementById('quiz-exp-text').innerText = explanation;
            document.getElementById('quiz-explanation').style.display = 'block';
            
            if(state.quizIndex < state.quizQueue.length - 1) {
                document.getElementById('next-q-btn').style.display = 'block';
            } else {
                document.getElementById('finish-quiz-btn').style.display = 'block';
            }
            updateStats();
        }

        function nextQuestion() {
            state.quizIndex++;
            loadQuestion();
        }

        function finishQuiz() {
            document.getElementById('quiz-active').classList.remove('active');
            document.getElementById('quiz-setup').classList.add('active');
            document.getElementById('page-title').innerText = 'Configurar Quiz';
            alert(`Quiz Finalizado! Pontuação: ${state.quizScore}/${state.quizQueue.length * 10}`);
        }

        // --- MEMORY GAME ---
        const memoryItems = [
            { icon: 'fa-stethoscope', name: 'Estetoscópio' },
            { icon: 'fa-syringe', name: 'Seringa' },
            { icon: 'fa-heart-pulse', name: 'ECG' },
            { icon: 'fa-pills', name: 'Medicação' },
            { icon: 'fa-user-doctor', name: 'Médico' },
            { icon: 'fa-wheelchair', name: 'Cadeira' },
            { icon: 'fa-mask', name: 'Máscara O2' },
            { icon: 'fa-crutch', name: 'Muleta' }
        ];

        function startMemoryGame() {
            document.getElementById('memory-board').style.display = 'block';
            const grid = document.getElementById('memory-grid');
            grid.innerHTML = '';
            
            // Select 6 pairs for mobile friendliness, or 8 for desktop
            const gameItems = memoryItems.slice(0, 6); 
            let cards = [...gameItems, ...gameItems];
            
            // Robust Shuffle
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }

            let flippedCards = [];
            let matchedPairs = 0;

            cards.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.index = index;
                card.dataset.name = item.name;
                
                card.innerHTML = `
                    <div class="card-face card-front">
                        <i class="fas ${item.icon}" style="font-size: 2rem; color: var(--secondary);"></i>
                        <div class="card-text">${item.name}</div>
                    </div>
                    <div class="card-face card-back">
                        <i class="fas fa-question"></i>
                    </div>
                `;
                
                card.onclick = () => {
                    if(flippedCards.length < 2 && !card.classList.contains('flipped')) {
                        card.classList.add('flipped');
                        flippedCards.push(card);

                        if(flippedCards.length === 2) {
                            setTimeout(() => {
                                if(flippedCards[0].dataset.name === flippedCards[1].dataset.name) {
                                    matchedPairs++;
                                    flippedCards = [];
                                    if(matchedPairs === gameItems.length) {
                                        setTimeout(() => {
                                            alert("Parabéns! Memória de elefante!");
                                            state.xp += 50;
                                            updateStats();
                                            document.getElementById('memory-board').style.display='none';
                                        }, 500);
                                    }
                                } else {
                                    flippedCards[0].classList.remove('flipped');
                                    flippedCards[1].classList.remove('flipped');
                                    flippedCards = [];
                                }
                            }, 1000);
                        }
                    }
                };
                grid.appendChild(card);
            });
        }

        // --- TOOLS ---
        function loadTool(tool) {
            if(tool === 'monitor') {
                document.getElementById('tool-monitor').style.display = 'block';
                setToolRhythm('sinus');
            }
        }

        function setToolRhythm(type) {
            initECG('tool-ecg-path', type);
        }

        // --- INIT ---
        window.onload = () => {
            const saved = localStorage.getItem('medsim_state_v2');
            if(saved) state = JSON.parse(saved);
            updateStats();
            renderDashboard();
            
            // Start default ECG animation for visual flair
            initECG('ecg-path', 'sinus');
        };

    </script>
</body>
</html>
