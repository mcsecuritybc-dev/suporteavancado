<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Centro de Treinamento Avan√ßado ‚Äî Emerg√™ncia</title>

  <style>
    :root{
      --bg0:#050814;
      --bg1:#071024;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.09);
      --stroke: rgba(255,255,255,0.12);
      --text:#EAF2FF;
      --muted: rgba(234,242,255,0.75);
      --muted2: rgba(234,242,255,0.60);
      --cyan:#22D3EE;
      --indigo:#6366F1;
      --emerald:#10B981;
      --amber:#F59E0B;
      --red:#EF4444;
      --good:#22C55E;
      --bad:#F43F5E;
      --radius:22px;
      --radius2:28px;
      --shadow: 0 20px 60px rgba(0,0,0,0.45);
      --shadow2: 0 14px 40px rgba(0,0,0,0.35);
      --btnPad: 16px 16px;
      --btnRadius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(34,211,238,0.22), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(99,102,241,0.22), transparent 60%),
        radial-gradient(900px 600px at 40% 110%, rgba(16,185,129,0.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-y:auto; /* UMA rolagem s√≥ */
    }

    /* Layout */
    .app{ display:flex; min-height:100vh; }
    .sidebar{
      width: 360px;
      flex: 0 0 360px;
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 16px;
      border-right: 1px solid rgba(255,255,255,0.10);
      background: rgba(5,8,20,0.48);
      backdrop-filter: blur(10px);
    }
    .main{ flex:1; padding: 18px 18px 40px; }

    /* Mobile */
    .topbar{
      display:none;
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 12px 12px;
      background: rgba(5,8,20,0.65);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    @media (max-width: 1024px){
      .sidebar{
        position: fixed;
        left: 0; top: 0; bottom: 0;
        z-index: 60;
        transform: translateX(-100%);
        transition: transform .18s ease;
      }
      .sidebar.open{ transform: translateX(0); }
      .main{ padding-top: 8px; }
      .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    }

    /* Cards */
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
    }
    .card.pad{ padding: 16px; }
    .grid{ display:grid; gap: 14px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }

    /* Typography */
    h1,h2,h3{ margin:0; }
    .titleTop{
      text-align:center;
      padding: 14px 14px 8px;
    }
    .brandSmall{ font-size: 12px; color: var(--muted2); letter-spacing: .10em; text-transform: uppercase; }
    .brandBig{ font-size: 22px; font-weight: 900; margin-top: 6px; }
    .sub{ font-size: 13px; color: var(--muted); margin-top: 8px; line-height: 1.35; }

    .pageTitle{ font-size: 28px; font-weight: 900; letter-spacing: -0.02em; text-align:center; }
    .pageSub{ text-align:center; color: var(--muted); margin-top: 6px; }

    /* Buttons */
    .btn{
      appearance:none;
      border: 0;
      cursor:pointer;
      padding: var(--btnPad);
      border-radius: var(--btnRadius);
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 16px;
      color: var(--text);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      transition: transform .06s ease, filter .12s ease, background .12s ease;
      width: 100%;
      text-align: left;
    }
    .btn:hover{ filter: brightness(1.05); background: rgba(255,255,255,0.10); }
    .btn:active{ transform: translateY(1px); }
    .btnRow{ display:flex; gap:10px; flex-wrap: wrap; }
    .btnRow .btn{ width:auto; min-width: 150px; text-align:center; }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(34,211,238,0.92), rgba(99,102,241,0.92));
      border: 1px solid rgba(255,255,255,0.14);
    }
    .btnOk{
      background: linear-gradient(135deg, rgba(34,197,94,0.92), rgba(16,185,129,0.92));
      border: 1px solid rgba(255,255,255,0.12);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(244,63,94,0.92), rgba(239,68,68,0.92));
      border: 1px solid rgba(255,255,255,0.12);
    }
    .btnWarn{
      background: linear-gradient(135deg, rgba(245,158,11,0.92), rgba(251,191,36,0.92));
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(10,10,20,0.95);
    }
    .btnSmall{
      padding: 12px 14px;
      font-size: 14px;
      border-radius: 16px;
    }
    .btnPill{
      width:auto;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
    }

    /* Nav */
    .navGroup{ padding: 10px; }
    .navBtn{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
      width: 100%;
      text-align:left;
      padding: 14px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.10);
      cursor:pointer;
      color: var(--text);
      font-weight: 900;
      font-size: 15px;
    }
    .navBtn:hover{ background: rgba(255,255,255,0.10); }
    .navBtn.active{
      background: linear-gradient(135deg, rgba(34,211,238,0.28), rgba(99,102,241,0.20));
      border: 1px solid rgba(34,211,238,0.28);
    }
    .navLeft{ display:flex; align-items:center; gap: 12px; min-width: 0; }
    .navIcon{
      width: 36px; height: 36px; flex: 0 0 36px;
      display:flex; align-items:center; justify-content:center;
      font-size: 20px;
      border-radius: 14px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .navLabel{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Widgets */
    .kpiRow{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .kpi{
      padding: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .kpi .k{ color: var(--muted2); font-size: 12px; }
    .kpi .v{ font-size: 22px; font-weight: 900; margin-top: 4px; }

    /* Content blocks */
    .block{
      padding: 16px;
      border-radius: var(--radius2);
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .muted{ color: var(--muted); }
    .small{ font-size: 13px; }
    .tiny{ font-size: 12px; color: var(--muted2); }
    .hr{ height:1px; background: rgba(255,255,255,0.10); margin: 14px 0; }

    /* Answer states */
    .optBtn{
      width:100%;
      text-align:left;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.07);
      cursor:pointer;
      font-size: 16px;
      font-weight: 900;
      color: var(--text);
      transition: filter .12s ease, transform .06s ease;
    }
    .optBtn:hover{ filter: brightness(1.05); }
    .optBtn:active{ transform: translateY(1px); }
    .optBtn.selected{
      background: rgba(34,197,94,0.22);
      border: 1px solid rgba(34,197,94,0.45);
    }
    .optBtn.correct{
      background: rgba(34,197,94,0.30);
      border: 1px solid rgba(34,197,94,0.55);
    }
    .optBtn.wrong{
      background: rgba(244,63,94,0.22);
      border: 1px solid rgba(244,63,94,0.55);
    }

    /* Inputs */
    input, select{
      width: 100%;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      font-weight: 900;
      outline: none;
    }
    input::placeholder{ color: rgba(234,242,255,0.50); font-weight: 800; }

    /* Toast */
    .toastWrap{
      position: fixed;
      left: 0; right: 0; bottom: 14px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index: 90;
    }
    .toast{
      width: min(980px, calc(100% - 16px));
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(5,8,20,0.75);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      pointer-events:none;
    }
    .toast .t1{ font-weight: 900; }
    .toast .t2{ margin-top:4px; color: var(--muted); font-size: 13px; }

    /* Mascot */
    .mascot{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 95;
      pointer-events:none;
    }
    .mascot.show{ display:flex; }
    .mascotCard{
      padding: 16px 18px;
      border-radius: 26px;
      background: rgba(5,8,20,0.78);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      gap: 14px;
    }
    .mascotEmoji{ font-size: 58px; }
    .mascotText .a{ font-weight: 900; font-size: 18px; }
    .mascotText .b{ color: var(--muted); margin-top: 4px; font-size: 13px; }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      z-index: 100;
    }
    .modal.show{ display:block; }
    .modalBg{
      position:absolute; inset:0;
      background: rgba(0,0,0,0.60);
    }
    .modalBox{
      position: relative;
      margin: 0 auto;
      width: min(980px, calc(100% - 18px));
      top: 50%;
      transform: translateY(-50%);
      background: rgba(5,8,20,0.85);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 16px;
    }

    /* Game tiles */
    .memGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 520px){ .memGrid{ grid-template-columns: repeat(3, 1fr); } }
    .memCard{
      height: 78px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.07);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .memCard.revealed{
      background: rgba(34,211,238,0.18);
      border: 1px solid rgba(34,211,238,0.35);
    }
    .memCard.matched{
      background: rgba(34,197,94,0.22);
      border: 1px solid rgba(34,197,94,0.45);
    }

    /* Word search */
    .wsGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 6px;
      max-width: 720px;
    }
    @media (max-width: 700px){ .wsGrid{ grid-template-columns: repeat(10, 1fr); } }
    .wsCell{
      aspect-ratio: 1/1;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
      text-transform: uppercase;
    }
    .wsCell.sel{
      background: rgba(245,158,11,0.25);
      border: 1px solid rgba(245,158,11,0.50);
      color: rgba(10,10,20,0.95);
    }
    .wsCell.good{
      background: rgba(34,197,94,0.25);
      border: 1px solid rgba(34,197,94,0.50);
    }

    /* Footer */
    .footer{
      margin-top: 18px;
      text-align:center;
      color: var(--muted2);
      font-size: 12px;
      padding-bottom: 18px;
    }
    .creator{ font-weight: 900; color: var(--text); }

  </style>
</head>

<body>
  <!-- Mobile topbar -->
  <div class="topbar">
    <button id="btnOpenMenu" class="btn btnPrimary btnSmall" style="width:auto;">üß≠ Menu</button>
    <div class="btnRow" style="gap:8px;">
      <span class="btnPill" id="pillScore">Score: 0</span>
      <button id="btnCopyStepMobile" class="btn btnSmall" style="width:auto;">üîó Link do passo</button>
    </div>
  </div>

  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="card">
        <div class="titleTop">
          <div class="brandSmall">Centro de Treinamento Avan√ßado</div>
          <div class="brandBig">üè• CTA ‚Äî Emerg√™ncia</div>
          <div class="sub">Plataforma multiprofissional para simula√ß√£o (Enfermagem, Fisioterapia, T√©cnicos e demais).</div>

          <div class="kpiRow">
            <div class="kpi">
              <div class="k">Score</div>
              <div class="v" id="kpiScore">0</div>
            </div>
            <div class="kpi">
              <div class="k">Acerto</div>
              <div class="v" id="kpiAcc">0%</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid">
            <div class="block">
              <div class="tiny">Modo Aula (Professor/Aluno) ‚Äî op√ß√£o A</div>
              <div style="margin-top:10px;" class="grid">
                <input id="classCodeInput" placeholder="C√≥digo da aula (ex.: TURMA1)" />
                <div class="btnRow">
                  <button id="btnSetClassCode" class="btn btnOk btnSmall">‚úÖ Aplicar</button>
                  <button id="btnCopyStep" class="btn btnSmall">üîó Copiar link do passo</button>
                </div>
              </div>
              <div class="tiny" style="margin-top:10px;">
                Mesmo c√≥digo = mesma ordem de quest√µes/casos/jogos.
              </div>
            </div>

            <div class="block">
              <div class="tiny">Aluno/Professor</div>
              <div style="font-weight: 900; font-size: 18px; margin-top: 6px;" id="userLabel">Aluno</div>
              <div class="btnRow" style="margin-top:10px;">
                <button id="btnName" class="btn btnSmall" style="width:auto;">‚úèÔ∏è Nome</button>
                <button id="btnReset" class="btn btnDanger btnSmall" style="width:auto;">‚ôªÔ∏è Reset</button>
              </div>
            </div>

            <div class="block tiny">
              Criador: <span class="creator">Dr. Moacir Carrion ‚Äî Fisioterapeuta</span>
            </div>
          </div>
        </div>

        <div class="navGroup grid">
          <button class="navBtn" data-view="dashboard">
            <span class="navLeft"><span class="navIcon">üßë‚Äç‚öïÔ∏è</span><span class="navLabel">Painel</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="triage">
            <span class="navLeft"><span class="navIcon">üö¶</span><span class="navLabel">Triagem</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="er">
            <span class="navLeft"><span class="navIcon">üöë</span><span class="navLabel">Sala de Emerg√™ncia</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="rapid">
            <span class="navLeft"><span class="navIcon">‚è±Ô∏è</span><span class="navLabel">Suporte R√°pido</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="quiz">
            <span class="navLeft"><span class="navIcon">üß†</span><span class="navLabel">Quiz</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="cases">
            <span class="navLeft"><span class="navIcon">üìã</span><span class="navLabel">Casos Cl√≠nicos</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="checklists">
            <span class="navLeft"><span class="navIcon">‚úÖ</span><span class="navLabel">Checklists</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="path">
            <span class="navLeft"><span class="navIcon">üß©</span><span class="navLabel">Patologias</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="epis">
            <span class="navLeft"><span class="navIcon">üß§</span><span class="navLabel">EPIs</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="games">
            <span class="navLeft"><span class="navIcon">üéÆ</span><span class="navLabel">Jogos</span></span>
            <span>‚Üí</span>
          </button>
          <button class="navBtn" data-view="review">
            <span class="navLeft"><span class="navIcon">üìö</span><span class="navLabel">Revis√£o</span></span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="card pad">
        <div class="pageTitle" id="pageTitle">Painel</div>
        <div class="pageSub" id="pageSub">Treine decis√µes e rotinas com feedback imediato, banco grande e modo aula sincroniz√°vel por link.</div>

        <div class="hr"></div>

        <div class="btnRow" style="justify-content:center;">
          <button class="btn btnPrimary btnSmall" style="width:auto;" id="btnInstructions">‚ÑπÔ∏è Instru√ß√µes</button>
          <button class="btn btnSmall" style="width:auto;" id="btnCopyStepTop">üîó Copiar link do passo atual</button>
          <button class="btn btnSmall" style="width:auto;" id="btnCloseMenuMobile">üìå Fechar menu</button>
        </div>
      </div>

      <div id="view" class="grid" style="margin-top:14px;"></div>

      <div class="footer">
        Material educacional para simula√ß√£o. Condutas reais dependem de protocolo institucional e avalia√ß√£o cl√≠nica.<br/>
        Criador: <span class="creator">Dr. Moacir Carrion ‚Äî Fisioterapeuta</span>
      </div>
    </main>
  </div>

  <!-- Toast -->
  <div class="toastWrap" id="toastWrap" style="display:none;">
    <div class="toast">
      <div class="t1" id="toastT1">Info</div>
      <div class="t2" id="toastT2">Mensagem</div>
    </div>
  </div>

  <!-- Mascot -->
  <div class="mascot" id="mascot">
    <div class="mascotCard">
      <div class="mascotEmoji">üßë‚Äç‚öïÔ∏è</div>
      <div class="mascotText">
        <div class="a" id="mascotA">OK</div>
        <div class="b" id="mascotB">Feedback</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalBg" id="modalBg"></div>
    <div class="modalBox">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
        <div>
          <div style="font-weight:900; font-size:20px;" id="modalTitle">T√≠tulo</div>
          <div class="small muted" style="margin-top:6px;" id="modalSub">Sub</div>
        </div>
        <button class="btn btnSmall" style="width:auto;" id="modalClose">‚úñÔ∏è Fechar</button>
      </div>
      <div class="hr"></div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
/* =========================================================
   Centro de Treinamento Avan√ßado ‚Äî Emerg√™ncia (single-file)
   - Banco: Quiz 50, Casos 20, Checklists por cen√°rio (>=5)
   - Triagem: banco + bot√£o Pr√≥xima
   - Sala de Emerg√™ncia: cen√°rios por patologia + hints
   - Suporte R√°pido: 2 min, escolher patologia + interven√ß√µes
   - Jogos: Mem√≥ria + Ca√ßa-palavras (funcionais)
   - Modo Aula (op√ß√£o A): mesma sequ√™ncia por C√≥digo da Aula
     + Link do passo atual (view + index) para sincronizar
   ========================================================= */

document.addEventListener("DOMContentLoaded", () => {
  const LS = {
    KEY: "CTA_EMERG_V1",
  };

  // --- Utilities
  const $ = (id) => document.getElementById(id);
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

  function toast(title, msg){
    $("toastT1").textContent = title;
    $("toastT2").textContent = msg;
    $("toastWrap").style.display = "flex";
    setTimeout(()=> $("toastWrap").style.display = "none", 2600);
  }

  function mascot(title, msg){
    $("mascotA").textContent = title;
    $("mascotB").textContent = msg;
    const m = $("mascot");
    m.classList.add("show");
    setTimeout(()=> m.classList.remove("show"), 2000); // 2 segundos
  }

  function openModal(title, sub, bodyHtml){
    $("modalTitle").textContent = title;
    $("modalSub").textContent = sub || "";
    $("modalBody").innerHTML = bodyHtml || "";
    $("modal").classList.add("show");
  }
  function closeModal(){
    $("modal").classList.remove("show");
  }
  $("modalClose").addEventListener("click", closeModal);
  $("modalBg").addEventListener("click", closeModal);

  // --- Deterministic RNG (mulberry32) with string hash
  function hashStringToSeed(str){
    let h = 2166136261 >>> 0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }
  function seededShuffle(arr, seed){
    const rng = mulberry32(seed >>> 0);
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(rng()* (i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // --- State
  const defaultState = {
    userName: "Aluno",
    classCode: "TURMA1",
    score: 0,
    correct: 0,
    wrong: 0,
    view: "dashboard",

    // indices per module (these are "steps")
    idx: {
      triage: 0,
      quiz: 0,
      cases: 0,
      checklists: 0,
      er: 0,
      rapid: 0,
      games: 0, // used for mem/word states
    },

    review: [], // recent log
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(LS.KEY);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      return { ...structuredClone(defaultState), ...s, idx: { ...structuredClone(defaultState.idx), ...(s.idx||{}) } };
    }catch(e){
      return structuredClone(defaultState);
    }
  }
  let state = loadState();

  function saveState(){
    localStorage.setItem(LS.KEY, JSON.stringify(state));
    renderKpis();
  }

  function logReview(type, detail){
    state.review.unshift({ t: new Date().toISOString(), type, detail });
    if(state.review.length > 200) state.review.pop();
  }

  function addScore(delta, reason){
    state.score = Math.max(0, state.score + delta);
    logReview("score", `${delta>0?"+":""}${delta} ‚Äî ${reason}`);
    saveState();
  }

  function accuracy(){
    const total = state.correct + state.wrong;
    if(total === 0) return 0;
    return Math.round((state.correct/total)*100);
  }

  function renderKpis(){
    $("kpiScore").textContent = state.score;
    $("kpiAcc").textContent = `${accuracy()}%`;
    $("pillScore").textContent = `Score: ${state.score}`;
    $("userLabel").textContent = state.userName || "Aluno";
    $("classCodeInput").value = state.classCode || "TURMA1";
  }

  // --- URL step sync (Modo Aula)
  // ?view=quiz&step=3&code=TURMA1
  function readUrlParams(){
    const url = new URL(window.location.href);
    const view = url.searchParams.get("view");
    const step = url.searchParams.get("step");
    const code = url.searchParams.get("code");

    if(code && typeof code === "string" && code.trim().length){
      state.classCode = code.trim().slice(0, 24);
    }
    if(view && VIEW_META[view]){
      state.view = view;
    }
    if(step !== null){
      const n = parseInt(step, 10);
      if(!Number.isNaN(n)){
        // apply only to that view
        if(state.idx[view] !== undefined){
          state.idx[view] = clamp(n, 0, 9999);
        }
      }
    }
    saveState();

    // clean URL (optional). We'll keep it, as it's used for sync.
  }

  function copyStepLink(){
    const url = new URL(window.location.href);
    url.searchParams.set("code", state.classCode || "TURMA1");
    url.searchParams.set("view", state.view);
    url.searchParams.set("step", String(state.idx[state.view] || 0));
    navigator.clipboard?.writeText(url.toString())
      .then(()=> toast("Link copiado", "Envie no grupo para alunos abrirem no mesmo passo."))
      .catch(()=> toast("N√£o copiou", "Seu navegador bloqueou. Copie manualmente pela barra de endere√ßo."));
  }

  // --- Large banks (Quiz 50, Cases 20, Checklists 5 scenarios w/5+ items, Triage bank)
  // Observa√ß√£o: ‚Äúembasamento‚Äù aqui √© descrito como ‚Äúconceitos/diretrizes‚Äù (sem citar ano/vers√£o espec√≠fica).
  // Voc√™ pode trocar/editar livremente as fontes no texto.
  const TRIAGE_BANK = [
    {
      id:"t1",
      q:"Triagem: paciente com dispneia intensa, uso de musculatura acess√≥ria e SpO‚ÇÇ 86% em ar ambiente. Prioridade?",
      opts:["Vermelho (emerg√™ncia imediata)","Verde (pouco urgente)","Azul (n√£o urgente)"],
      ans:0,
      why:"Hipoxemia e sinais de esfor√ßo respirat√≥rio indicam risco imediato; prioridade alta.",
      src:"Conceitos de triagem e avalia√ß√£o prim√°ria (ABCDE).",
      hint:"Pense no risco de vida imediato associado √† ventila√ß√£o/oxigena√ß√£o."
    },
    {
      id:"t2",
      q:"Triagem: paciente com dor tor√°cica s√∫bita, sudorese, n√°usea, palidez. Prioridade?",
      opts:["Amarelo","Vermelho","Azul"],
      ans:1,
      why:"Dor tor√°cica com sinais auton√¥micos sugere s√≠ndrome coronariana/instabilidade ‚Üí atendimento imediato.",
      src:"Conceitos de dor tor√°cica na emerg√™ncia.",
      hint:"Dor tor√°cica t√≠pica + sinais sist√™micos costuma ser alto risco."
    },
    {
      id:"t3",
      q:"Triagem: ferimento superficial com sangramento controlado e sinais vitais normais. Prioridade?",
      opts:["Vermelho","Verde","Laranja"],
      ans:1,
      why:"Baixo risco imediato e est√°vel ‚Üí pode aguardar com seguran√ßa.",
      src:"Conceitos de triagem por gravidade.",
      hint:"Observe estabilidade hemodin√¢mica e aus√™ncia de amea√ßa imediata."
    },
    {
      id:"t4",
      q:"Triagem: paciente confuso, hipotenso (PA 86/54), extremidades frias. Prioridade?",
      opts:["Vermelho","Verde","Azul"],
      ans:0,
      why:"Sinais de choque/hipoperfus√£o exigem interven√ß√£o imediata.",
      src:"Conceitos de choque e perfus√£o.",
      hint:"Hipotens√£o + altera√ß√£o de consci√™ncia aponta hipoperfus√£o."
    },
    {
      id:"t5",
      q:"Triagem: crise convulsiva ativa na chegada. Prioridade?",
      opts:["Vermelho","Verde","Amarelo"],
      ans:0,
      why:"Convuls√£o ativa √© amea√ßa imediata (via a√©rea/aspira√ß√£o/hip√≥xia).",
      src:"Conceitos de emerg√™ncia neurol√≥gica.",
      hint:"Atividade convulsiva ativa = risco imediato."
    },
    {
      id:"t6",
      q:"Triagem: paciente febril, dor leve, est√°vel, sem sinais de gravidade. Prioridade?",
      opts:["Azul/Verde (baixa urg√™ncia)","Vermelho","Laranja"],
      ans:0,
      why:"Sem sinais de gravidade e est√°vel ‚Üí baixa urg√™ncia.",
      src:"Conceitos de triagem por gravidade.",
      hint:"Procure sinais de instabilidade."
    },
    {
      id:"t7",
      q:"Triagem: suspeita de AVC (face ca√≠da, fala alterada, fraqueza s√∫bita). Prioridade?",
      opts:["Vermelho","Verde","Azul"],
      ans:0,
      why:"AVC √© tempo-dependente e precisa de fluxo r√°pido (imediato).",
      src:"Conceitos de AVC na emerg√™ncia.",
      hint:"Patologias tempo-dependentes sobem a prioridade."
    },
    {
      id:"t8",
      q:"Triagem: anafilaxia (urtic√°ria + broncoespasmo + hipotens√£o). Prioridade?",
      opts:["Vermelho","Amarelo","Verde"],
      ans:0,
      why:"Risco imediato de colapso circulat√≥rio e via a√©rea.",
      src:"Conceitos de anafilaxia na emerg√™ncia.",
      hint:"Anafilaxia √© amea√ßa imediata."
    },
    {
      id:"t9",
      q:"Triagem: trauma com sangramento arterial ativo. Prioridade?",
      opts:["Vermelho","Verde","Azul"],
      ans:0,
      why:"Hemorragia ativa pode levar a choque rapidamente.",
      src:"Conceitos de trauma e controle de hemorragia.",
      hint:"Sangramento ativo = risco de choque."
    },
    {
      id:"t10",
      q:"Triagem: paciente com dor abdominal intensa + defesa abdominal + palidez. Prioridade?",
      opts:["Laranja/Vermelho (alta prioridade)","Azul","Verde"],
      ans:0,
      why:"Pode indicar abdome agudo com risco; precisa avalia√ß√£o r√°pida.",
      src:"Conceitos de abdome agudo.",
      hint:"Intensidade + sinais de irrita√ß√£o peritoneal elevam o risco."
    }
  ];

  const QUIZ_BANK = [
    // 50 itens (compactos, por√©m reais e √∫teis)
    {id:"q1", topic:"ABCDE", lvl:1, q:"No ABCDE, a letra A refere-se a:", opts:["Via a√©rea","Ventila√ß√£o","Circula√ß√£o"], ans:0, why:"A = Airway (via a√©rea).", src:"Conceitos ABCDE.", hint:"Pense na sequ√™ncia do ABCDE."},
    {id:"q2", topic:"ABCDE", lvl:1, q:"No ABCDE, a letra B refere-se a:", opts:["Circula√ß√£o","Ventila√ß√£o/respira√ß√£o","Disfun√ß√£o neurol√≥gica"], ans:1, why:"B = Breathing.", src:"Conceitos ABCDE.", hint:"Ap√≥s via a√©rea vem respira√ß√£o."},
    {id:"q3", topic:"RCP", lvl:1, q:"Em ritmo choc√°vel (FV/TVsp), a conduta-chave imediata inclui:", opts:["Desfibrila√ß√£o precoce + RCP","Atropina como 1¬™ escolha","Aguardar exames"], ans:0, why:"Ritmo choc√°vel: choque + RCP de alta qualidade.", src:"Conceitos de suporte avan√ßado de vida.", hint:"Ritmo choc√°vel = choque."},
    {id:"q4", topic:"Oxigena√ß√£o", lvl:1, q:"Objetivo comum de SpO‚ÇÇ em adulto sem reten√ß√£o cr√¥nica de CO‚ÇÇ:", opts:[">94% (em geral)","80%","100% sempre"], ans:0, why:"Alvo geralmente >94% dependendo do caso.", src:"Conceitos de oxigenoterapia.", hint:"Evite extremos; pense em alvo seguro."},
    {id:"q5", topic:"Choque", lvl:1, q:"Sinal cl√°ssico de hipoperfus√£o perif√©rica:", opts:["Extremidades frias e tempo de enchimento capilar prolongado","Pele quente e rosada","Bradicardia isolada"], ans:0, why:"Hipoperfus√£o costuma cursar com vasoconstri√ß√£o perif√©rica.", src:"Conceitos de choque.", hint:"Pense em vasoconstri√ß√£o."},
    {id:"q6", topic:"Sepse", lvl:2, q:"Na sepse, uma prioridade inicial na emerg√™ncia √©:", opts:["Reconhecer gravidade e iniciar bundle precoce conforme protocolo","Aguardar 24h para antibi√≥tico","Evitar monitoriza√ß√£o"], ans:0, why:"Sepse √© tempo-dependente: abordagem precoce melhora desfechos.", src:"Conceitos de bundles de sepse.", hint:"Tempo importa."},
    {id:"q7", topic:"AVC", lvl:2, q:"Em suspeita de AVC, o fator cr√≠tico √©:", opts:["Tempo at√© avalia√ß√£o e imagem","Esperar melhora espont√¢nea","Evitar triagem"], ans:0, why:"AVC √© tempo-dependente.", src:"Conceitos de AVC.", hint:"‚ÄúTempo √© c√©rebro‚Äù (conceito)."},
    {id:"q8", topic:"Trauma", lvl:2, q:"Em trauma com hemorragia, uma prioridade √©:", opts:["Controle r√°pido de sangramento","Dar alta imediata","Suspender monitoriza√ß√£o"], ans:0, why:"Controle de hemorragia reduz choque e mortalidade.", src:"Conceitos de trauma.", hint:"Pare o sangramento."},
    {id:"q9", topic:"Vias a√©reas", lvl:2, q:"Sinal de amea√ßa de via a√©rea:", opts:["Estridor","Tosse leve isolada","Press√£o arterial normal"], ans:0, why:"Estridor sugere obstru√ß√£o de via a√©rea.", src:"Conceitos de via a√©rea.", hint:"Som inspirat√≥rio agudo."},
    {id:"q10", topic:"Farmaco", lvl:2, q:"Em anafilaxia com instabilidade, a conduta de primeira linha (conceito) envolve:", opts:["Tratamento imediato conforme protocolo e suporte ABC","Apenas anti-histam√≠nico e observar","Esperar exames"], ans:0, why:"Anafilaxia √© emerg√™ncia: interven√ß√£o imediata e suporte.", src:"Conceitos de anafilaxia.", hint:"Emerg√™ncia de via a√©rea e perfus√£o."},

    // 40 adicionais
    {id:"q11", topic:"Monitoriza√ß√£o", lvl:1, q:"Um par√¢metro essencial na admiss√£o de emerg√™ncia:", opts:["Sinais vitais completos","Apenas temperatura","Somente peso"], ans:0, why:"Monitoriza√ß√£o orienta decis√µes.", src:"Boas pr√°ticas de emerg√™ncia.", hint:"O b√°sico guia a conduta."},
    {id:"q12", topic:"Seguran√ßa", lvl:1, q:"Boa pr√°tica na administra√ß√£o de medica√ß√£o:", opts:["Checar identifica√ß√£o e alergias","Aplicar sem confer√™ncia","Evitar rotulagem"], ans:0, why:"Barreiras reduzem erros.", src:"Seguran√ßa do paciente (conceito).", hint:"Reduza erros com checagens."},
    {id:"q13", topic:"Ventila√ß√£o", lvl:2, q:"Em broncoespasmo grave, uma prioridade √©:", opts:["Avaliar fadiga/hipoventila√ß√£o e oferecer suporte conforme protocolo","Dar seda√ß√£o e liberar","Ignorar SpO‚ÇÇ"], ans:0, why:"Risco de fal√™ncia ventilat√≥ria exige aten√ß√£o.", src:"Conceitos de insufici√™ncia respirat√≥ria.", hint:"Pense em fadiga respirat√≥ria."},
    {id:"q14", topic:"Cardio", lvl:2, q:"Dor tor√°cica + hipotens√£o sugere:", opts:["Instabilidade hemodin√¢mica (alto risco)","Baixo risco","Sempre ansiedade"], ans:0, why:"Hipotens√£o com dor tor√°cica √© sinal de gravidade.", src:"Conceitos de dor tor√°cica.", hint:"Instabilidade = gravidade."},
    {id:"q15", topic:"ABCDE", lvl:1, q:"No ABCDE, a letra C est√° ligada a:", opts:["Circula√ß√£o/hemorragia","Temperatura","Apenas glicemia"], ans:0, why:"C = Circulation.", src:"Conceitos ABCDE.", hint:"C de Circula√ß√£o."},

    {id:"q16", topic:"Neuro", lvl:2, q:"No ABCDE, avalia√ß√£o neurol√≥gica r√°pida √©:", opts:["D (Disability)","B","A"], ans:0, why:"D = Disability (estado neurol√≥gico).", src:"Conceitos ABCDE.", hint:"Qual letra trata do neuro?"},
    {id:"q17", topic:"Exposi√ß√£o", lvl:1, q:"A letra E do ABCDE envolve:", opts:["Exposi√ß√£o e controle de temperatura","Eletrocardiograma","Endoscopia"], ans:0, why:"Expor para buscar les√µes e prevenir hipotermia.", src:"Conceitos ABCDE.", hint:"E = Expose."},
    {id:"q18", topic:"Choque", lvl:2, q:"Sinais de choque podem incluir:", opts:["Taquicardia + hipotens√£o + pele fria","Bradicardia + pele quente sempre","Somente febre"], ans:0, why:"Padr√£o t√≠pico de hipoperfus√£o.", src:"Conceitos de choque.", hint:"Pense em resposta adren√©rgica."},
    {id:"q19", topic:"Glicemia", lvl:1, q:"Hipoglicemia pode simular:", opts:["Altera√ß√£o neurol√≥gica/AVC","Fratura exposta","Apendicite sempre"], ans:0, why:"Hipoglicemia altera n√≠vel de consci√™ncia e fala.", src:"Conceitos de emerg√™ncia metab√≥lica.", hint:"Sempre checar glicemia no neuro."},
    {id:"q20", topic:"PCR", lvl:2, q:"Ap√≥s desfibrilar, a conduta imediata √©:", opts:["Retomar RCP sem demora","Aguardar 2 minutos sem RCP","Checar press√£o arterial primeiro"], ans:0, why:"Minimizar pausas na RCP.", src:"Conceitos de RCP.", hint:"Pausas m√≠nimas."},

    {id:"q21", topic:"Infec√ß√£o", lvl:1, q:"Sinal de gravidade infecciosa:", opts:["Hipotens√£o e confus√£o","Dor leve isolada","Espinhas"], ans:0, why:"Sinais sist√™micos sugerem sepse.", src:"Conceitos de sepse.", hint:"Procure instabilidade."},
    {id:"q22", topic:"Resp", lvl:1, q:"Indicador de esfor√ßo respirat√≥rio:", opts:["Uso de musculatura acess√≥ria","Unhas curtas","Olhos castanhos"], ans:0, why:"Sinal cl√≠nico importante.", src:"Semiologia respirat√≥ria (conceito).", hint:"Observe t√≥rax/pesco√ßo."},
    {id:"q23", topic:"Trauma", lvl:2, q:"Imobiliza√ß√£o cervical √© considerada quando:", opts:["Suspeita de trauma e risco de les√£o cervical","Dor de cabe√ßa cr√¥nica","Febre baixa"], ans:0, why:"Prote√ß√£o de coluna em trauma selecionado.", src:"Conceitos de trauma.", hint:"Trauma + mecanismo."},
    {id:"q24", topic:"Sinais vitais", lvl:1, q:"Taquipneia √©:", opts:["FR elevada","FC elevada","PA elevada"], ans:0, why:"FR = frequ√™ncia respirat√≥ria.", src:"Sinais vitais (conceito).", hint:"Respira√ß√£o."},
    {id:"q25", topic:"Oxig√™nio", lvl:2, q:"O‚ÇÇ suplementar √© indicado quando:", opts:["Hipoxemia ou desconforto conforme avalia√ß√£o","Sempre em todo paciente","Nunca"], ans:0, why:"Indica√ß√£o cl√≠nica.", src:"Conceitos de oxigenoterapia.", hint:"Use quando precisa."},

    {id:"q26", topic:"Neuro", lvl:2, q:"Sinal de rebaixamento neurol√≥gico relevante:", opts:["Glasgow reduzido","Unhas pintadas","Cabelo curto"], ans:0, why:"Avalia√ß√£o do n√≠vel de consci√™ncia.", src:"Conceitos neuro na emerg√™ncia.", hint:"Escala de consci√™ncia."},
    {id:"q27", topic:"Cardio", lvl:2, q:"No IAM, atraso no atendimento tende a:", opts:["Piorar desfechos","N√£o mudar nada","Curar sozinho"], ans:0, why:"Tempo-dependente.", src:"Conceitos de IAM.", hint:"Tempo importa."},
    {id:"q28", topic:"EPI", lvl:1, q:"Uso de prote√ß√£o ocular √© especialmente importante quando:", opts:["Risco de respingos/ aeross√≥is","Paciente sorrindo","Ambiente silencioso"], ans:0, why:"Barreira contra exposi√ß√£o.", src:"Boas pr√°ticas de biosseguran√ßa.", hint:"Risco de respingos."},
    {id:"q29", topic:"Via a√©rea", lvl:2, q:"Sialorreia + voz abafada + dificuldade de deglutir pode sugerir:", opts:["Risco de via a√©rea","Dor lombar","Apenas ansiedade"], ans:0, why:"Sinais de via a√©rea comprometida.", src:"Conceitos de via a√©rea.", hint:"Degluti√ß√£o/voz."},
    {id:"q30", topic:"Choque", lvl:2, q:"Tempo de enchimento capilar prolongado sugere:", opts:["Hipoperfus√£o","Hipertens√£o","Hipertermia"], ans:0, why:"Perfus√£o perif√©rica reduzida.", src:"Semiologia (conceito).", hint:"Perfus√£o perif√©rica."},

    {id:"q31", topic:"Acesso", lvl:1, q:"Em emerg√™ncia, garantir acesso venoso √© √∫til para:", opts:["Medica√ß√£o e fluidos quando indicados","Apenas est√©tica","Evitar monitor"], ans:0, why:"Permite terapias r√°pidas.", src:"Conceitos de emerg√™ncia.", hint:"Acesso = rapidez."},
    {id:"q32", topic:"Resp", lvl:2, q:"Sinais de fal√™ncia ventilat√≥ria podem incluir:", opts:["Sonol√™ncia/hipoventila√ß√£o","Apetite aumentado","Cabelo √∫mido"], ans:0, why:"Reten√ß√£o de CO‚ÇÇ e fadiga podem causar sonol√™ncia.", src:"Conceitos de insufici√™ncia ventilat√≥ria.", hint:"CO‚ÇÇ alto pode dar sonol√™ncia."},
    {id:"q33", topic:"Anamnese", lvl:1, q:"SAMPLE √© um mnem√¥nico √∫til para:", opts:["Hist√≥ria breve focada","Dosagem de antibi√≥tico","ECG"], ans:0, why:"SAMPLE estrutura coleta r√°pida.", src:"Conceitos de atendimento inicial.", hint:"Hist√≥ria r√°pida."},
    {id:"q34", topic:"ABCDE", lvl:1, q:"No ABCDE, reavalia√ß√£o √©:", opts:["Essencial ap√≥s interven√ß√µes","Desnecess√°ria","Opcional apenas no fim"], ans:0, why:"Reavalia√ß√£o confirma resposta e novas amea√ßas.", src:"Conceitos ABCDE.", hint:"Sempre reavaliar."},
    {id:"q35", topic:"PCR", lvl:2, q:"Qualidade da RCP depende de:", opts:["Profundidade e frequ√™ncia adequadas com m√≠nimas pausas","Apenas de oxig√™nio","Somente de medica√ß√£o"], ans:0, why:"RCP de alta qualidade √© base.", src:"Conceitos de RCP.", hint:"Compress√µes boas."},

    {id:"q36", topic:"Sepse", lvl:2, q:"Sinais de disfun√ß√£o org√¢nica podem incluir:", opts:["Confus√£o/hipotens√£o/olig√∫ria","Somente espirros","Apenas tosse"], ans:0, why:"Disfun√ß√£o sist√™mica.", src:"Conceitos de sepse.", hint:"Pense em √≥rg√£os."},
    {id:"q37", topic:"Trauma", lvl:2, q:"Em trauma, hipotermia √© perigosa porque:", opts:["Piora coagulopatia e progn√≥stico","Sempre melhora dor","N√£o importa"], ans:0, why:"Tr√≠ade letal no trauma (conceito).", src:"Conceitos de trauma.", hint:"Temperatura importa."},
    {id:"q38", topic:"EPI", lvl:1, q:"Higieniza√ß√£o das m√£os √©:", opts:["Fundamental antes/depois do contato","Opcional","Apenas com luva"], ans:0, why:"Medida mais efetiva contra transmiss√£o.", src:"Biosseguran√ßa (conceito).", hint:"Sempre."},
    {id:"q39", topic:"Neuro", lvl:2, q:"Convuls√£o prolongada aumenta risco de:", opts:["Hip√≥xia/les√£o secund√°ria","Crescimento de cabelo","Sono profundo ben√©fico"], ans:0, why:"Emerg√™ncia neurol√≥gica.", src:"Conceitos de convuls√£o.", hint:"Dura√ß√£o importa."},
    {id:"q40", topic:"Resp", lvl:1, q:"FR normal em adulto geralmente √© em torno de:", opts:["12‚Äì20 irpm (aprox.)","2 irpm","40‚Äì60 irpm sempre"], ans:0, why:"Faixa aproximada usada clinicamente.", src:"Sinais vitais (conceito).", hint:"Valores usuais."},

    {id:"q41", topic:"Cardio", lvl:2, q:"Em dor tor√°cica, um exame inicial importante √©:", opts:["ECG (quando dispon√≠vel)","Tomografia sempre","EEG"], ans:0, why:"ECG orienta conduta e risco.", src:"Conceitos de dor tor√°cica.", hint:"Exame r√°pido card√≠aco."},
    {id:"q42", topic:"Resp", lvl:2, q:"Sibilos difusos sugerem:", opts:["Broncoespasmo","Fratura de f√™mur","Insufici√™ncia renal"], ans:0, why:"Sibil√¢ncia indica fluxo em vias a√©reas estreitadas.", src:"Semiologia respirat√≥ria (conceito).", hint:"Som expirat√≥rio musical."},
    {id:"q43", topic:"Choque", lvl:2, q:"Olig√∫ria pode sugerir:", opts:["Hipoperfus√£o renal","Sono","Alergia alimentar"], ans:0, why:"Perfus√£o reduzida ‚Üí d√©bito urin√°rio baixo.", src:"Conceitos de perfus√£o.", hint:"Diurese √© marcador."},
    {id:"q44", topic:"EPI", lvl:1, q:"M√°scara N95/PFF2 √© indicada principalmente em:", opts:["Risco de aeross√≥is","Curativos secos","Dor lombar"], ans:0, why:"Prote√ß√£o respirat√≥ria em aeross√≥is.", src:"Biosseguran√ßa (conceito).", hint:"Aerosol."},
    {id:"q45", topic:"ABCDE", lvl:1, q:"Ao detectar amea√ßa, deve-se:", opts:["Intervir e reavaliar","Aguardar evolu√ß√£o","Ignorar"], ans:0, why:"Interven√ß√£o imediata e reavalia√ß√£o.", src:"Conceitos ABCDE.", hint:"Agir e reavaliar."},

    {id:"q46", topic:"Metab√≥lico", lvl:2, q:"Em altera√ß√£o neurol√≥gica, um teste r√°pido √∫til √©:", opts:["Glicemia capilar","Raio-X de cr√¢nio sempre","Audiometria"], ans:0, why:"Hipoglicemia √© causa revers√≠vel frequente.", src:"Conceitos de abordagem neuro.", hint:"Revers√≠vel e r√°pido."},
    {id:"q47", topic:"Resp", lvl:2, q:"Em insufici√™ncia respirat√≥ria, sinais de gravidade incluem:", opts:["Cianose/queda de SpO‚ÇÇ/esfor√ßo intenso","Pele hidratada","Sono normal"], ans:0, why:"Sinais cl√≠nicos de fal√™ncia respirat√≥ria.", src:"Conceitos de insufici√™ncia respirat√≥ria.", hint:"Oxigena√ß√£o baixa + esfor√ßo."},
    {id:"q48", topic:"Trauma", lvl:2, q:"Dor + deformidade + incapacidade funcional ap√≥s queda sugere:", opts:["Fratura/les√£o importante","Sempre resfriado","Apenas ansiedade"], ans:0, why:"Sinais sugestivos de les√£o estrutural.", src:"Conceitos de trauma ortop√©dico.", hint:"Fun√ß√£o comprometida."},
    {id:"q49", topic:"Sepse", lvl:2, q:"Febre + taquicardia + hipotens√£o em contexto infeccioso sugere:", opts:["Sepse/choque s√©ptico (suspeita)","Alergia leve","Gastrite simples"], ans:0, why:"Instabilidade em contexto infeccioso ‚Üí suspeitar sepse.", src:"Conceitos de sepse.", hint:"Infec√ß√£o + instabilidade."},
    {id:"q50", topic:"Seguran√ßa", lvl:1, q:"Rotulagem de seringas/solu√ß√µes:", opts:["Reduz troca e erros","Aumenta risco","√â in√∫til"], ans:0, why:"Barreira de seguran√ßa na pr√°tica.", src:"Seguran√ßa do paciente (conceito).", hint:"Evita confus√£o."},
  ];

  const CASES_BANK = [
    // 20 casos (cada um com 3 op√ß√µes)
    {
      id:"c1", title:"Sepse prov√°vel",
      stem:"67a com febre, confus√£o, pele fria, PA 86/54, FC 118, FR 30, SpO‚ÇÇ 88% AA.",
      q:"Primeira prioridade no atendimento:",
      opts:[
        {t:"Oxigenar e iniciar avalia√ß√£o ABCDE + monitoriza√ß√£o", ok:true},
        {t:"Aguardar exames antes de qualquer interven√ß√£o", ok:false},
        {t:"Oferecer √°gua e observar", ok:false},
      ],
      why:"Hipoxemia/choque exigem interven√ß√£o imediata e fluxo r√°pido conforme protocolo.",
      src:"Conceitos ABCDE + sepse (bundle precoce).",
      hint:"Identifique amea√ßa imediata √† vida (oxigena√ß√£o/perfus√£o).",
      pts:10
    },
    {
      id:"c2", title:"PCR com FV",
      stem:"Colapso s√∫bito; monitor mostra fibrila√ß√£o ventricular; pulso ausente.",
      q:"Conduta imediata mais efetiva:",
      opts:[
        {t:"Desfibrilar e retomar RCP imediatamente", ok:true},
        {t:"Atropina como 1¬™ medida", ok:false},
        {t:"Esperar 2 min para checar novamente", ok:false},
      ],
      why:"Ritmo choc√°vel: choque precoce + RCP de alta qualidade.",
      src:"Conceitos de RCP avan√ßada.",
      hint:"Ritmo choc√°vel = choque + RCP sem pausas longas.",
      pts:10
    },
    {
      id:"c3", title:"Suspeita de AVC",
      stem:"Paciente com face desviada, fala arrastada, fraqueza em MSD/MID h√° 40 minutos.",
      q:"A√ß√£o priorit√°ria:",
      opts:[
        {t:"Ativar fluxo r√°pido de AVC e avalia√ß√£o imediata", ok:true},
        {t:"Aguardar 6h para observar", ok:false},
        {t:"Liberar com analgesia apenas", ok:false},
      ],
      why:"AVC √© tempo-dependente; precisa avalia√ß√£o e imagem r√°pidas.",
      src:"Conceitos de AVC na emerg√™ncia.",
      hint:"Tempo determina janela terap√™utica.",
      pts:10
    },
    {
      id:"c4", title:"Anafilaxia",
      stem:"Urtic√°ria difusa, chiado, edema de l√°bios e hipotens√£o ap√≥s alimento.",
      q:"Prioridade inicial:",
      opts:[
        {t:"Suporte ABC imediato e tratamento conforme protocolo", ok:true},
        {t:"Somente anti-histam√≠nico e alta", ok:false},
        {t:"Aguardar exames laboratoriais", ok:false},
      ],
      why:"Anafilaxia amea√ßa via a√©rea e perfus√£o.",
      src:"Conceitos de anafilaxia na emerg√™ncia.",
      hint:"Via a√©rea e choque s√£o prioridade.",
      pts:10
    },
    {
      id:"c5", title:"Crise asm√°tica grave",
      stem:"Dispneia intensa, fala entrecortada, sibilos difusos, SpO‚ÇÇ 89% AA.",
      q:"Conduta inicial apropriada:",
      opts:[
        {t:"Oxigenar e iniciar broncodilata√ß√£o conforme protocolo + reavalia√ß√£o", ok:true},
        {t:"Seda√ß√£o e enviar para casa", ok:false},
        {t:"Ignorar satura√ß√£o e apenas observar", ok:false},
      ],
      why:"Hipoxemia e broncoespasmo exigem interven√ß√£o e monitoriza√ß√£o.",
      src:"Conceitos de insufici√™ncia respirat√≥ria/asma.",
      hint:"Tratamento precoce e reavalia√ß√£o.",
      pts:10
    },
    {
      id:"c6", title:"Hipoglicemia",
      stem:"Paciente confuso, sudorese, tremor; glicemia capilar 45 mg/dL.",
      q:"Conduta priorit√°ria:",
      opts:[
        {t:"Corre√ß√£o imediata da glicemia conforme protocolo", ok:true},
        {t:"Aguardar TC de cr√¢nio", ok:false},
        {t:"Apenas hidratar e observar", ok:false},
      ],
      why:"Hipoglicemia √© causa revers√≠vel e deve ser corrigida rapidamente.",
      src:"Conceitos de emerg√™ncia metab√≥lica.",
      hint:"Causa revers√≠vel e r√°pida.",
      pts:10
    },
    {
      id:"c7", title:"Trauma com hemorragia",
      stem:"Ferimento com sangramento ativo e sinais de choque incipiente.",
      q:"Prioridade:",
      opts:[
        {t:"Controle de hemorragia + avalia√ß√£o ABCDE", ok:true},
        {t:"Solicitar exames e aguardar", ok:false},
        {t:"Colocar em observa√ß√£o sem interven√ß√µes", ok:false},
      ],
      why:"Hemorragia mata r√°pido: controle imediato √© chave.",
      src:"Conceitos de trauma.",
      hint:"Primeiro pare o sangramento.",
      pts:10
    },
    {
      id:"c8", title:"Dor tor√°cica t√≠pica",
      stem:"Dor tor√°cica em aperto, sudorese, n√°usea, PA lim√≠trofe.",
      q:"A√ß√£o inicial √∫til:",
      opts:[
        {t:"Monitoriza√ß√£o e ECG precoce (quando dispon√≠vel) + avalia√ß√£o de risco", ok:true},
        {t:"Alta imediata", ok:false},
        {t:"Somente anti-inflamat√≥rio e observar em casa", ok:false},
      ],
      why:"ECG e monitoriza√ß√£o orientam conduta.",
      src:"Conceitos de s√≠ndrome coronariana.",
      hint:"Exame r√°pido que muda conduta.",
      pts:10
    },
    {
      id:"c9", title:"Pneumot√≥rax suspeito",
      stem:"Dispneia s√∫bita ap√≥s trauma, assimetria ventilat√≥ria, hipotens√£o progressiva.",
      q:"Prioridade:",
      opts:[
        {t:"Reconhecer risco e intervir conforme protocolo (suporte ABC) com urg√™ncia", ok:true},
        {t:"Aguardar evolu√ß√£o", ok:false},
        {t:"Dar alta", ok:false},
      ],
      why:"Condi√ß√£o potencialmente fatal e tempo-dependente.",
      src:"Conceitos de trauma tor√°cico.",
      hint:"Emerg√™ncia tempo-dependente.",
      pts:10
    },
    {
      id:"c10", title:"Convuls√£o",
      stem:"Convuls√£o t√¥nico-cl√¥nica cont√≠nua na chegada.",
      q:"Primeira prioridade:",
      opts:[
        {t:"Proteger via a√©rea/oxigena√ß√£o e manejo imediato conforme protocolo", ok:true},
        {t:"Aguardar cessar espontaneamente", ok:false},
        {t:"Dar √°gua", ok:false},
      ],
      why:"Convuls√£o ativa aumenta risco de hip√≥xia e aspira√ß√£o.",
      src:"Conceitos de emerg√™ncia neurol√≥gica.",
      hint:"Via a√©rea e oxigena√ß√£o primeiro.",
      pts:10
    },
    // 10 adicionais
    { id:"c11", title:"Choque hipovol√™mico suspeito", stem:"PA 90/60, FC 130, pele fria, hist√≥ria de sangramento GI.",
      q:"Prioridade inicial:", opts:[
        {t:"Avaliar perfus√£o e iniciar reposi√ß√£o/condutas conforme protocolo + monitoriza√ß√£o", ok:true},
        {t:"Enviar para casa", ok:false},
        {t:"Esperar 6h", ok:false},
      ], why:"Sinais de hipoperfus√£o exigem interven√ß√£o e reavalia√ß√£o.", src:"Conceitos de choque/hemorragia.", hint:"Perfus√£o baixa requer a√ß√£o.", pts:10
    },
    { id:"c12", title:"Edema agudo de pulm√£o", stem:"Dispneia, crepita√ß√µes, PA elevada, ortopneia, SpO‚ÇÇ baixa.",
      q:"Conduta inicial:", opts:[
        {t:"Suporte ventilat√≥rio/oxig√™nio e manejo conforme protocolo + monitoriza√ß√£o", ok:true},
        {t:"Somente analg√©sico", ok:false},
        {t:"Aguardar melhora espont√¢nea", ok:false},
      ], why:"Hipoxemia e congest√£o exigem suporte e manejo r√°pido.", src:"Conceitos de insufici√™ncia card√≠aca aguda.", hint:"Oxigena√ß√£o e al√≠vio respirat√≥rio.", pts:10
    },
    { id:"c13", title:"Tromboembolismo suspeito", stem:"Dispneia s√∫bita, dor pleur√≠tica, taquicardia, fator de risco.",
      q:"A√ß√£o inicial:", opts:[
        {t:"Avaliar gravidade e iniciar investiga√ß√£o/condutas conforme protocolo", ok:true},
        {t:"Alta sem avalia√ß√£o", ok:false},
        {t:"Ignorar sinais vitais", ok:false},
      ], why:"Pode ser condi√ß√£o grave; requer avalia√ß√£o estruturada.", src:"Conceitos de TEP.", hint:"Dispneia s√∫bita + risco = aten√ß√£o.", pts:10
    },
    { id:"c14", title:"Trauma cranioencef√°lico", stem:"Queda, v√¥mitos, sonol√™ncia crescente.",
      q:"Prioridade:", opts:[
        {t:"Avalia√ß√£o neurol√≥gica e prote√ß√£o de via a√©rea conforme necess√°rio", ok:true},
        {t:"Apenas observa√ß√£o sem reavalia√ß√£o", ok:false},
        {t:"Alta imediata", ok:false},
      ], why:"Risco de piora neurol√≥gica e via a√©rea.", src:"Conceitos de TCE.", hint:"Neuro pode piorar r√°pido.", pts:10
    },
    { id:"c15", title:"Hemorragia p√≥s-parto (simulado)", stem:"Sangramento intenso, tontura, PA caindo.",
      q:"Conduta inicial:", opts:[
        {t:"Reconhecer hemorragia e acionar protocolo + suporte hemodin√¢mico", ok:true},
        {t:"Esperar 2h", ok:false},
        {t:"Apenas compressa fria", ok:false},
      ], why:"Hemorragia maci√ßa exige protocolo e suporte imediato.", src:"Conceitos de hemorragia obst√©trica (simula√ß√£o).", hint:"Sangramento importante = protocolo.", pts:10
    },
    { id:"c16", title:"Intoxica√ß√£o", stem:"Rebaixamento + respira√ß√£o lenta ap√≥s uso de subst√¢ncia desconhecida.",
      q:"Prioridade:", opts:[
        {t:"Suporte de via a√©rea/ventila√ß√£o e avalia√ß√£o r√°pida (ABCDE)", ok:true},
        {t:"Aguardar acordar", ok:false},
        {t:"Somente soro oral", ok:false},
      ], why:"Hipoventila√ß√£o e rebaixamento amea√ßam vida.", src:"Conceitos de intoxica√ß√£o/ABCDE.", hint:"Ventila√ß√£o primeiro.", pts:10
    },
    { id:"c17", title:"Dor abdominal + instabilidade", stem:"Dor intensa, sudorese, PA 88/56, palidez.",
      q:"Prioridade:", opts:[
        {t:"Avaliar choque/abdome agudo e conduzir fluxo r√°pido conforme protocolo", ok:true},
        {t:"Alta com antiespasm√≥dico", ok:false},
        {t:"Aguardar 24h", ok:false},
      ], why:"Instabilidade sugere condi√ß√£o grave.", src:"Conceitos de abdome agudo e choque.", hint:"Inst√°vel = alto risco.", pts:10
    },
    { id:"c18", title:"Hemoptise importante", stem:"Sangramento respirat√≥rio significativo + dispneia.",
      q:"A√ß√£o inicial:", opts:[
        {t:"Proteger via a√©rea e oxigenar; monitorizar e acionar fluxo", ok:true},
        {t:"Somente analg√©sico", ok:false},
        {t:"Enviar para casa", ok:false},
      ], why:"Risco de aspira√ß√£o/hip√≥xia.", src:"Conceitos de via a√©rea e sangramento.", hint:"Prote√ß√£o de via a√©rea.", pts:10
    },
    { id:"c19", title:"Arritmia inst√°vel (simulado)", stem:"Taquicardia, hipotens√£o, confus√£o, dor tor√°cica.",
      q:"Conduta inicial:", opts:[
        {t:"Reconhecer instabilidade e seguir protocolo de urg√™ncia", ok:true},
        {t:"Aguardar normalizar", ok:false},
        {t:"Liberar para casa", ok:false},
      ], why:"Instabilidade hemodin√¢mica exige a√ß√£o r√°pida.", src:"Conceitos de arritmias.", hint:"Inst√°vel = urg√™ncia.", pts:10
    },
    { id:"c20", title:"Febre + rigidez de nuca (simulado)", stem:"Febre alta, cefaleia, rigidez de nuca, prostra√ß√£o.",
      q:"Prioridade:", opts:[
        {t:"Reconhecer gravidade e acionar avalia√ß√£o imediata + isolamento conforme protocolo", ok:true},
        {t:"Somente dipirona e alta", ok:false},
        {t:"Aguardar 48h", ok:false},
      ], why:"Sinais men√≠ngeos podem indicar condi√ß√£o grave.", src:"Conceitos de s√≠ndrome men√≠ngea.", hint:"Sinais neurol√≥gicos + febre.", pts:10
    },
  ];

  // Checklists por cen√°rio (>=5 cen√°rios, cada um com >=5 itens)
  const CHECKLIST_SCENARIOS = [
    {
      id:"cl_intub",
      title:"Checklist ‚Äî Intuba√ß√£o (simula√ß√£o)",
      intro:"Marque os itens VERDADEIROS como necess√°rios/adequados antes/durante o procedimento (conceito).",
      items:[
        {t:"Monitoriza√ß√£o (SpO‚ÇÇ, PA, ECG quando dispon√≠vel).", truth:true, why:"Monitoriza√ß√£o aumenta seguran√ßa e detecta deteriora√ß√£o."},
        {t:"Pr√©-oxigena√ß√£o quando indicado.", truth:true, why:"Reduz risco de dessatura√ß√£o durante tentativa."},
        {t:"Checar material (laringosc√≥pio, c√¢nulas, fixa√ß√£o).", truth:true, why:"Evita falhas e atrasos."},
        {t:"N√£o checar aspira√ß√£o/suc√ß√£o.", truth:false, why:"Suc√ß√£o deve estar pronta para secre√ß√µes/v√¥mitos."},
        {t:"Plano alternativo caso falha (conceito).", truth:true, why:"Reduz tempo e aumenta seguran√ßa."},
      ],
      src:"Boas pr√°ticas de via a√©rea (conceitos).",
      pts:14
    },
    {
      id:"cl_sepse",
      title:"Checklist ‚Äî Sepse (simula√ß√£o)",
      intro:"Selecione as a√ß√µes adequadas no in√≠cio do atendimento (conceito).",
      items:[
        {t:"Reconhecer gravidade e monitorizar sinais vitais.", truth:true, why:"Identifica instabilidade e orienta suporte."},
        {t:"Aguardar 24h para antibi√≥tico.", truth:false, why:"Sepse √© tempo-dependente."},
        {t:"Coletar exames/culturas conforme protocolo institucional.", truth:true, why:"Ajuda diagn√≥stico e direciona tratamento."},
        {t:"Iniciar suporte hemodin√¢mico conforme protocolo quando indicado.", truth:true, why:"Hipoperfus√£o requer suporte."},
        {t:"Reavaliar resposta ap√≥s interven√ß√µes.", truth:true, why:"Garante ajuste terap√™utico."},
      ],
      src:"Conceitos de sepse (bundle precoce).",
      pts:14
    },
    {
      id:"cl_pcr",
      title:"Checklist ‚Äî PCR (simula√ß√£o)",
      intro:"Marque a√ß√µes adequadas durante PCR (conceito).",
      items:[
        {t:"Iniciar RCP de alta qualidade imediatamente.", truth:true, why:"Base do atendimento."},
        {t:"Minimizar pausas nas compress√µes.", truth:true, why:"Mant√©m perfus√£o."},
        {t:"Se ritmo choc√°vel, desfibrilar e retomar RCP.", truth:true, why:"Choque precoce melhora chance."},
        {t:"Aguardar sem RCP para ‚Äúdescansar‚Äù.", truth:false, why:"Pausas prolongadas pioram perfus√£o."},
        {t:"Reavaliar ritmos em ciclos e buscar causas revers√≠veis.", truth:true, why:"Direciona corre√ß√£o do problema."},
      ],
      src:"Conceitos de RCP avan√ßada.",
      pts:14
    },
    {
      id:"cl_meds",
      title:"Checklist ‚Äî Medica√ß√£o Segura",
      intro:"Selecione boas pr√°ticas de seguran√ßa (conceito).",
      items:[
        {t:"Identifica√ß√£o ativa do paciente (duas checagens).", truth:true, why:"Barreira contra erro de paciente."},
        {t:"Checar alergias e contraindica√ß√µes.", truth:true, why:"Evita eventos adversos."},
        {t:"Rotular seringas/solu√ß√µes preparadas.", truth:true, why:"Reduz trocas e erros."},
        {t:"Administrar sem prescri√ß√£o/protocolo aplic√°vel.", truth:false, why:"Risco legal e cl√≠nico; seguir normas."},
        {t:"Registrar administra√ß√£o e observar efeitos.", truth:true, why:"Rastreabilidade e seguran√ßa."},
      ],
      src:"Seguran√ßa do paciente (conceitos).",
      pts:14
    },
    {
      id:"cl_trauma",
      title:"Checklist ‚Äî Trauma (avalia√ß√£o inicial)",
      intro:"Marque itens que fazem parte do atendimento inicial (conceito).",
      items:[
        {t:"Avalia√ß√£o prim√°ria ABCDE.", truth:true, why:"Estrutura prioridades."},
        {t:"Controle de hemorragia externa.", truth:true, why:"Reduz choque rapidamente."},
        {t:"Prevenir hipotermia durante exposi√ß√£o.", truth:true, why:"Hipotermia piora progn√≥stico."},
        {t:"Ignorar mecanismo de trauma.", truth:false, why:"Mecanismo orienta riscos ocultos."},
        {t:"Reavalia√ß√£o seriada ap√≥s interven√ß√µes.", truth:true, why:"Detecta deteriora√ß√£o."},
      ],
      src:"Conceitos de trauma e ABCDE.",
      pts:14
    },
  ];

  const PATHOLOGIES = [
    {name:"Sepse / Choque s√©ptico", tags:["infec√ß√£o","hipotens√£o","lactato"], actions:[
      "Reconhecer gravidade e monitorizar.",
      "Oxigenar/ventilar se necess√°rio (ABCDE).",
      "Bundle precoce conforme protocolo: antibi√≥tico oportuno, exames.",
      "Suporte hemodin√¢mico e reavalia√ß√£o seriada."
    ], src:"Conceitos de sepse/bundle."},
    {name:"PCR (FV/TVsp/assistolia/AEsp)", tags:["acls","rcp"], actions:[
      "RCP de alta qualidade, pausas m√≠nimas.",
      "Desfibrilar em ritmo choc√°vel e retomar RCP.",
      "Ciclos com reavalia√ß√£o de ritmo e causas revers√≠veis.",
      "P√≥s-ROSC: otimizar ventila√ß√£o/perfus√£o e investigar causa."
    ], src:"Conceitos de RCP avan√ßada."},
    {name:"AVC isqu√™mico (suspeita)", tags:["tempo","neuro"], actions:[
      "Ativar fluxo r√°pido de AVC e avalia√ß√£o neurol√≥gica breve.",
      "Checar glicemia capilar (causa revers√≠vel).",
      "Imagem e conduta conforme protocolo e janela terap√™utica.",
      "Suporte ABC e monitoriza√ß√£o."
    ], src:"Conceitos de AVC na emerg√™ncia."},
    {name:"IAM / S√≠ndrome coronariana", tags:["dor tor√°cica","ecg"], actions:[
      "Monitoriza√ß√£o e ECG precoce (quando dispon√≠vel).",
      "Avaliar instabilidade e dor.",
      "Conduta conforme protocolo institucional.",
      "Reavalia√ß√£o e estratifica√ß√£o de risco."
    ], src:"Conceitos de dor tor√°cica/IAM."},
    {name:"Anafilaxia", tags:["alergia","choque","via a√©rea"], actions:[
      "Suporte ABC imediato.",
      "Tratamento imediato conforme protocolo.",
      "Monitoriza√ß√£o e reavalia√ß√£o seriada.",
      "Orientar preven√ß√£o e risco de recorr√™ncia."
    ], src:"Conceitos de anafilaxia."},
    {name:"Crise asm√°tica grave", tags:["broncoespasmo","resp"], actions:[
      "Oxigenar conforme necessidade e monitorizar.",
      "Broncodilata√ß√£o e terapia conforme protocolo.",
      "Avaliar fadiga/hipoventila√ß√£o.",
      "Reavaliar resposta continuamente."
    ], src:"Conceitos de insufici√™ncia respirat√≥ria/asma."},
    {name:"Edema agudo de pulm√£o", tags:["ic","hip√≥xia"], actions:[
      "Suporte ventilat√≥rio/oxig√™nio e monitoriza√ß√£o.",
      "Manejo conforme protocolo (hemodin√¢mica).",
      "Reavaliar sinais de perfus√£o/respira√ß√£o."
    ], src:"Conceitos de IC aguda."},
    {name:"TEP (suspeita)", tags:["dispneia","risco"], actions:[
      "Avaliar gravidade e estabilidade hemodin√¢mica.",
      "Oxigenar se necess√°rio.",
      "Investiga√ß√£o e conduta conforme protocolo."
    ], src:"Conceitos de TEP."},
    {name:"Hipoglicemia", tags:["metab√≥lico","neuro"], actions:[
      "Confirmar glicemia capilar.",
      "Corrigir imediatamente conforme protocolo.",
      "Reavaliar consci√™ncia e risco de recorr√™ncia."
    ], src:"Conceitos de emerg√™ncia metab√≥lica."},
    {name:"Choque hemorr√°gico", tags:["trauma","sangramento"], actions:[
      "Controle de hemorragia imediato.",
      "Suporte hemodin√¢mico conforme protocolo.",
      "Monitoriza√ß√£o e reavalia√ß√£o."
    ], src:"Conceitos de trauma/hemorragia."},
  ];

  const EPIS = [
    {title:"EPIs ‚Äî Base", items:[
      "Higieniza√ß√£o das m√£os (antes/depois).",
      "Luvas quando indicado.",
      "M√°scara conforme risco (cir√∫rgica / PFF2/N95 em aeross√≥is).",
      "Prote√ß√£o ocular em risco de respingos.",
      "Avental/Capote em contato com fluidos."
    ]},
    {title:"Boas pr√°ticas", items:[
      "Trocar EPIs conforme sujidade/umidade e entre pacientes.",
      "Descartar corretamente (perfurocortante e res√≠duos).",
      "Evitar tocar face durante assist√™ncia.",
      "Limpeza de superf√≠cies e equipamentos conforme protocolo.",
      "Treinamento e ajuste correto de m√°scara respirat√≥ria."
    ]},
  ];

  // Sala de Emerg√™ncia: cen√°rios selecion√°veis + dicas sem entregar resposta
  const ER_SCENARIOS = [
    {
      id:"er_pcr",
      title:"PCR (simula√ß√£o)",
      intro:"Paciente inconsciente, sem respira√ß√£o efetiva e sem pulso.",
      steps:[
        "Avaliar responsividade e respira√ß√£o/pulso rapidamente.",
        "Acionar ajuda e iniciar RCP de alta qualidade.",
        "Conectar desfibrilador/monitor e identificar ritmo.",
        "Se choc√°vel: desfibrilar e retomar RCP imediatamente.",
        "Ciclos com reavalia√ß√£o e causas revers√≠veis; p√≥s-ROSC."
      ],
      hint:"Pense em prioridade absoluta e tempo cr√≠tico. Evite pausas longas.",
      src:"Conceitos de RCP avan√ßada.",
      tasks:[
        {label:"1) Prioridade inicial", choices:["Iniciar RCP e chamar ajuda","Aguardar equipe chegar","Registrar ficha primeiro"], correct:0, why:"RCP precoce √© base."},
        {label:"2) Ritmo choc√°vel", choices:["Desfibrilar + retomar RCP","Atropina 1¬™ medida","Aguardar 2 min sem compress√£o"], correct:0, why:"Choque precoce + RCP."},
        {label:"3) Ap√≥s interven√ß√£o", choices:["Reavaliar e ajustar conduta","Encerrar atendimento","Ignorar monitor"], correct:0, why:"Reavalia√ß√£o √© essencial."},
      ]
    },
    {
      id:"er_sepse",
      title:"Sepse/Choque s√©ptico (simula√ß√£o)",
      intro:"Febre, confus√£o, hipotens√£o, taquipneia e sinais de hipoperfus√£o.",
      steps:[
        "Reconhecer gravidade e iniciar monitoriza√ß√£o.",
        "Oxigenar/ventilar conforme ABCDE.",
        "Coletar exames/culturas conforme protocolo e iniciar antibi√≥tico oportuno.",
        "Suporte hemodin√¢mico conforme protocolo; reavalia√ß√£o seriada.",
        "Escalonar suporte conforme necessidade."
      ],
      hint:"Tempo importa. Pense em oxigena√ß√£o/perfus√£o e bundle precoce.",
      src:"Conceitos de sepse/bundle.",
      tasks:[
        {label:"1) A√ß√£o inicial", choices:["Monitorizar e avaliar ABCDE","Esperar exames antes de agir","Somente antit√©rmico e alta"], correct:0, why:"Estrutura e prioridade."},
        {label:"2) Antibi√≥tico", choices:["Oportuno conforme protocolo","Somente ap√≥s 24h","N√£o √© necess√°rio"], correct:0, why:"Tempo-depend√™ncia."},
        {label:"3) Ap√≥s interven√ß√µes", choices:["Reavaliar perfus√£o e resposta","Encerrar sem reavalia√ß√£o","Ignorar diurese"], correct:0, why:"Resposta guia ajuste."},
      ]
    },
    {
      id:"er_avc",
      title:"AVC (simula√ß√£o)",
      intro:"Fraqueza s√∫bita + fala alterada h√° 45 minutos.",
      steps:[
        "Triagem imediata (tempo-dependente) e avalia√ß√£o neurol√≥gica breve.",
        "Checar glicemia capilar (causa revers√≠vel).",
        "Ativar fluxo r√°pido e realizar imagem conforme protocolo.",
        "Suporte ABC e monitoriza√ß√£o.",
        "Conduta conforme janela terap√™utica e equipe."
      ],
      hint:"Tempo define janela. N√£o esque√ßa causas revers√≠veis (glicemia).",
      src:"Conceitos de AVC na emerg√™ncia.",
      tasks:[
        {label:"1) Prioridade", choices:["Ativar fluxo r√°pido de AVC","Aguardar melhora espont√¢nea","Dar alta"], correct:0, why:"Tempo-dependente."},
        {label:"2) Teste r√°pido √∫til", choices:["Glicemia capilar","Audiometria","Raio-x de f√™mur"], correct:0, why:"Hipoglicemia pode simular."},
        {label:"3) Ap√≥s identifica√ß√£o", choices:["Imagem e conduta conforme protocolo","Somente analg√©sico e observa√ß√£o domiciliar","Ignorar sinais"], correct:0, why:"Fluxo r√°pido."},
      ]
    }
  ];

  // Suporte R√°pido (2 minutos): escolher patologia + interven√ß√µes
  const RAPID_CASES = [
    {
      id:"r1",
      stem:"Paciente com urtic√°ria, chiado, edema de l√°bios e queda de PA ap√≥s alimento.",
      dx:["Anafilaxia","AVC","Fratura de punho"],
      correctDx:0,
      interventions:["Suporte ABC imediato","Monitoriza√ß√£o e reavalia√ß√£o","Aguardar 24h sem conduta","Tratamento conforme protocolo"],
      correctInt:[0,1,3],
      hint:"Pense em via a√©rea + choque e rapidez."
    },
    {
      id:"r2",
      stem:"Dispneia intensa, SpO‚ÇÇ 86% AA, uso de musculatura acess√≥ria.",
      dx:["Crise asm√°tica grave","Dor lombar","Otite"],
      correctDx:0,
      interventions:["Oxigenar e monitorizar","Broncodilata√ß√£o conforme protocolo","Dar alta imediata","Reavaliar resposta"],
      correctInt:[0,1,3],
      hint:"Oxigena√ß√£o + broncoespasmo + reavalia√ß√£o."
    },
    {
      id:"r3",
      stem:"Febre, confus√£o, hipotens√£o, pele fria; suspeita infecciosa.",
      dx:["Sepse/choque s√©ptico","Enxaqueca","Gastrite"],
      correctDx:0,
      interventions:["Monitoriza√ß√£o e ABCDE","Antibi√≥tico oportuno conforme protocolo","Esperar 24h","Suporte hemodin√¢mico conforme protocolo"],
      correctInt:[0,1,3],
      hint:"Tempo importa e perfus√£o est√° ruim."
    },
    {
      id:"r4",
      stem:"Face desviada, fala arrastada, fraqueza s√∫bita h√° 30‚Äì60 min.",
      dx:["AVC (suspeita)","Hipertens√£o leve sem risco","Rinite"],
      correctDx:0,
      interventions:["Ativar fluxo r√°pido","Checar glicemia capilar","Aguardar em casa","Imagem conforme protocolo"],
      correctInt:[0,1,3],
      hint:"Tempo-dependente; descarte hipoglicemia."
    },
    {
      id:"r5",
      stem:"Colapso s√∫bito, pulso ausente, ritmo choc√°vel no monitor (simulado).",
      dx:["PCR com FV/TVsp","C√≥lica renal","Vertigem benigna"],
      correctDx:0,
      interventions:["Iniciar RCP de alta qualidade","Desfibrilar quando indicado e retomar RCP","Aguardar equipe sem compress√µes","Reavaliar em ciclos"],
      correctInt:[0,1,3],
      hint:"Choque + RCP sem pausas."
    },
  ];

  // Games content
  const GAME_TERMS = [
    "ABCDE","RCP","SEPSE","AVC","IAM","OXIGENO","CHOQUE","EPI","TRIAGEM","SAMPLE","MONITOR","VIAAREA"
  ];

  // --- Derived: deterministic order using classCode seed
  function seed(){
    return hashStringToSeed((state.classCode||"TURMA1").toUpperCase().trim());
  }

  function getOrderedBanks(){
    const s = seed();
    return {
      triage: seededShuffle(TRIAGE_BANK, s ^ 0xA1B2C3),
      quiz: seededShuffle(QUIZ_BANK, s ^ 0xB2C3D4),
      cases: seededShuffle(CASES_BANK, s ^ 0xC3D4E5),
      checklists: seededShuffle(CHECKLIST_SCENARIOS, s ^ 0xD4E5F6),
      er: seededShuffle(ER_SCENARIOS, s ^ 0xE5F607),
      rapid: seededShuffle(RAPID_CASES, s ^ 0xF60718),
      gamesTerms: seededShuffle(GAME_TERMS, s ^ 0x13579B),
    };
  }

  // --- Navigation + views
  const VIEW_META = {
    dashboard: {title:"Painel", sub:"Escolha um m√≥dulo e treine com feedback imediato. Use o C√≥digo da Aula para mesma sequ√™ncia em todos."},
    triage: {title:"Triagem", sub:"Quest√µes rotativas + bot√£o Pr√≥xima. Dica dispon√≠vel sem entregar resposta."},
    er: {title:"Sala de Emerg√™ncia", sub:"Escolha a situa√ß√£o e resolva etapas sequenciais. Dicas sem revelar respostas."},
    rapid: {title:"Suporte R√°pido", sub:"Voc√™ tem 2 minutos: identifique patologia e interven√ß√µes. Se falhar, √≥bito simulado."},
    quiz: {title:"Quiz", sub:"50 quest√µes. Sele√ß√£o verde + feedback. Auto-pr√≥xima em 5s (e bot√£o Pr√≥xima)."},
    cases: {title:"Casos Cl√≠nicos", sub:"20 casos. Decis√£o + justificativa. Rotativo pelo C√≥digo da Aula."},
    checklists: {title:"Checklists", sub:"5 cen√°rios (cada um 5+ itens). Marque V/F e corrija."},
    path: {title:"Patologias", sub:"Consulta r√°pida ampliada: condutas iniciais (educacional)."},
    epis: {title:"EPIs", sub:"Resumo essencial de EPIs e boas pr√°ticas."},
    games: {title:"Jogos", sub:"Ca√ßa-palavras e Mem√≥ria ‚Äî termos e rotinas de emerg√™ncia."},
    review: {title:"Revis√£o", sub:"Hist√≥rico de desempenho e registros recentes."},
  };

  function setActiveNav(view){
    document.querySelectorAll(".navBtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.view === view);
    });
  }

  function setHeader(view){
    const m = VIEW_META[view] || VIEW_META.dashboard;
    $("pageTitle").textContent = m.title;
    $("pageSub").textContent = m.sub;
    document.title = `Centro de Treinamento Avan√ßado ‚Äî ${m.title}`;
  }

  function go(view){
    if(!VIEW_META[view]) view = "dashboard";
    state.view = view;
    saveState();
    setHeader(view);
    setActiveNav(view);
    render(view);

    // close menu on mobile
    if(window.innerWidth <= 1024){
      $("sidebar").classList.remove("open");
    }
  }

  function viewCard(title, subtitle, innerHtml){
    const d = document.createElement("div");
    d.className = "card pad";
    d.innerHTML = `
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <h2 style="font-size:22px; font-weight:900;">${escapeHtml(title)}</h2>
          ${subtitle ? `<div class="small muted" style="margin-top:6px;">${escapeHtml(subtitle)}</div>` : ""}
        </div>
      </div>
      <div class="hr"></div>
      <div>${innerHtml}</div>
    `;
    return d;
  }

  function escapeHtml(str){
    return (""+str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // --- Render views
  function render(view){
    const container = $("view");
    container.innerHTML = "";

    switch(view){
      case "dashboard": return renderDashboard(container);
      case "triage": return renderTriage(container);
      case "er": return renderER(container);
      case "rapid": return renderRapid(container);
      case "quiz": return renderQuiz(container);
      case "cases": return renderCases(container);
      case "checklists": return renderChecklists(container);
      case "path": return renderPath(container);
      case "epis": return renderEPIs(container);
      case "games": return renderGames(container);
      case "review": return renderReview(container);
      default: return renderDashboard(container);
    }
  }

  function renderDashboard(container){
    const html = `
      <div class="grid2">
        <div class="block">
          <div style="font-weight:900; font-size:18px;">üöÄ Come√ßar</div>
          <div class="small muted" style="margin-top:8px;">Escolha um m√≥dulo. A sequ√™ncia √© definida pelo C√≥digo da Aula.</div>
          <div class="hr"></div>
          <div class="grid2">
            <button class="btn btnPrimary" data-go="er">üöë Sala de Emerg√™ncia</button>
            <button class="btn btnPrimary" data-go="rapid">‚è±Ô∏è Suporte R√°pido</button>
            <button class="btn" data-go="triage">üö¶ Triagem</button>
            <button class="btn" data-go="quiz">üß† Quiz</button>
            <button class="btn" data-go="cases">üìã Casos Cl√≠nicos</button>
            <button class="btn" data-go="checklists">‚úÖ Checklists</button>
            <button class="btn" data-go="games">üéÆ Jogos</button>
            <button class="btn" data-go="path">üß© Patologias</button>
          </div>
        </div>

        <div class="block">
          <div style="font-weight:900; font-size:18px;">üìå Regras do treino</div>
          <div class="small muted" style="margin-top:8px;">
            ‚Ä¢ Ao clicar em alternativa: bot√£o fica <b>verde</b> (selecionado) e aparece <b>correto/errado</b>.<br/>
            ‚Ä¢ No Quiz: ap√≥s resposta, passa para a pr√≥xima em <b>5 segundos</b> (e existe bot√£o Pr√≥xima).<br/>
            ‚Ä¢ Dicas existem, mas <b>n√£o entregam</b> a resposta.<br/>
            ‚Ä¢ Use ‚ÄúCopiar link do passo‚Äù para alunos abrirem no mesmo ponto (modo aula sem backend).
          </div>

          <div class="hr"></div>

          <div class="btnRow">
            <button class="btn btnSmall" style="width:auto;" id="btnDashCopy">üîó Copiar link do passo atual</button>
            <button class="btn btnSmall" style="width:auto;" id="btnDashInstr">‚ÑπÔ∏è Instru√ß√µes</button>
          </div>
        </div>
      </div>
    `;
    const c = viewCard("üßë‚Äç‚öïÔ∏è Painel", "Centro de Treinamento Avan√ßado ‚Äî ambiente tecnol√≥gico e din√¢mico.", html);
    container.appendChild(c);

    c.querySelectorAll("[data-go]").forEach(b=>{
      b.addEventListener("click", ()=> go(b.dataset.go));
    });
    $("btnDashCopy").addEventListener("click", copyStepLink);
    $("btnDashInstr").addEventListener("click", () => openInstructions());
  }

  function openInstructions(){
    openModal(
      "‚ÑπÔ∏è Instru√ß√µes (Aluno)",
      "Objetivo: treino de tomada de decis√£o e rotinas.",
      `
      <div class="block small">
        <b>Como usar:</b><br/>
        1) Escolha um m√≥dulo no menu.<br/>
        2) Leia o cen√°rio e selecione a melhor op√ß√£o.<br/>
        3) Veja o feedback e a justificativa (base conceitual/diretrizes).<br/><br/>
        <b>Modo Aula:</b><br/>
        ‚Ä¢ Defina o <b>C√≥digo da Aula</b> (o mesmo para todos).<br/>
        ‚Ä¢ Para todos ficarem no mesmo ponto, o professor usa <b>Copiar link do passo atual</b> e envia no grupo (ou projeta QR).<br/><br/>
        <b>Importante:</b> esta plataforma √© educacional; na pr√°tica real valem protocolos e avalia√ß√£o cl√≠nica.
      </div>
      `
    );
  }

  // TRIAGE view
  function renderTriage(container){
    const banks = getOrderedBanks();
    const items = banks.triage;

    const idx = state.idx.triage % items.length;
    const item = items[idx];

    const html = `
      <div class="grid">
        <div class="block">
          <div class="tiny">C√≥digo da aula: <b>${escapeHtml(state.classCode)}</b> ‚Ä¢ Passo: <b>${idx}</b></div>
          <div style="font-weight:900; font-size:20px; margin-top:8px;">${escapeHtml(item.q)}</div>

          <div class="hr"></div>

          <div class="grid" id="triOpts"></div>

          <div class="hr"></div>

          <div class="btnRow">
            <button class="btn btnSmall" style="width:auto;" id="triHint">üí° Dica</button>
            <button class="btn btnPrimary btnSmall" style="width:auto;" id="triNext">‚û°Ô∏è Pr√≥xima</button>
          </div>

          <div id="triFb" class="block small" style="margin-top:12px; display:none;"></div>
        </div>
      </div>
    `;
    const c = viewCard("üö¶ Triagem", "Quest√µes rotativas (Pr√≥xima para avan√ßar).", html);
    container.appendChild(c);

    const triOpts = $("triOpts");
    const fb = $("triFb");
    let locked = false;

    item.opts.forEach((opt, i)=>{
      const b = document.createElement("button");
      b.className = "optBtn";
      b.type = "button";
      b.textContent = opt;

      b.addEventListener("click", ()=>{
        if(locked) return;
        locked = true;

        b.classList.add("selected");
        const ok = (i === item.ans);

        // show correct/wrong immediately
        if(ok){
          b.classList.add("correct");
          state.correct += 1;
          addScore(6, "Triagem correta");
          mascot("Correto", "+6 pontos");
        }else{
          b.classList.add("wrong");
          state.wrong += 1;
          mascot("Revisar", "Veja a justificativa");
        }

        logReview("triage", `${ok?"OK":"ERRO"} ‚Äî ${item.id}`);
        saveState();

        fb.style.display = "block";
        fb.innerHTML = `
          <div style="font-weight:900; font-size:16px;">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
          <div class="muted" style="margin-top:8px;">${escapeHtml(item.why)}</div>
          <div class="tiny" style="margin-top:8px;"><b>Base:</b> ${escapeHtml(item.src)}</div>
        `;
      });

      triOpts.appendChild(b);
    });

    $("triHint").addEventListener("click", ()=>{
      openModal("üí° Dica (Triagem)", "Sem entregar a resposta.", `
        <div class="block small">
          ${escapeHtml(item.hint)}
        </div>
      `);
    });

    $("triNext").addEventListener("click", ()=>{
      state.idx.triage += 1;
      saveState();
      render("triage");
    });
  }

  // QUIZ view (auto-next 5s + next button)
  function renderQuiz(container){
    const banks = getOrderedBanks();
    const items = banks.quiz;

    const idx = state.idx.quiz % items.length;
    const item = items[idx];

    const html = `
      <div class="block">
        <div class="tiny">C√≥digo da aula: <b>${escapeHtml(state.classCode)}</b> ‚Ä¢ Passo: <b>${idx}</b> ‚Ä¢ Tema: <b>${escapeHtml(item.topic)}</b> ‚Ä¢ N√≠vel: <b>${item.lvl}</b></div>
        <div style="font-weight:900; font-size:20px; margin-top:8px;">${escapeHtml(item.q)}</div>

        <div class="hr"></div>

        <div class="grid" id="quizOpts"></div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn btnSmall" style="width:auto;" id="quizHint">üí° Dica</button>
          <button class="btn btnPrimary btnSmall" style="width:auto;" id="quizNext">‚û°Ô∏è Pr√≥xima</button>
        </div>

        <div class="small muted" style="margin-top:10px;">
          Auto-pr√≥xima ap√≥s resposta: <b>5s</b> (caso n√£o clique em Pr√≥xima).
        </div>

        <div id="quizFb" class="block small" style="margin-top:12px; display:none;"></div>
      </div>
    `;
    const c = viewCard("üß† Quiz", "Sele√ß√£o verde + feedback imediato + auto-pr√≥xima.", html);
    container.appendChild(c);

    const wrap = $("quizOpts");
    const fb = $("quizFb");
    let locked = false;
    let timer = null;

    function pts(lvl){
      if(lvl >= 2) return 7;
      return 5;
    }

    item.opts.forEach((opt, i)=>{
      const b = document.createElement("button");
      b.className = "optBtn";
      b.type = "button";
      b.textContent = opt;

      b.addEventListener("click", ()=>{
        if(locked) return;
        locked = true;

        b.classList.add("selected");
        const ok = (i === item.ans);

        if(ok){
          b.classList.add("correct");
          state.correct += 1;
          addScore(pts(item.lvl), `Quiz correto (${item.topic})`);
          mascot("Correto", `+${pts(item.lvl)} pontos`);
        }else{
          b.classList.add("wrong");
          state.wrong += 1;
          mascot("Errado", "Veja a justificativa");
        }

        logReview("quiz", `${ok?"OK":"ERRO"} ‚Äî ${item.id}`);
        saveState();

        fb.style.display = "block";
        fb.innerHTML = `
          <div style="font-weight:900; font-size:16px;">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
          <div class="muted" style="margin-top:8px;">${escapeHtml(item.why)}</div>
          <div class="tiny" style="margin-top:8px;"><b>Base:</b> ${escapeHtml(item.src)}</div>
        `;

        // disable other options
        wrap.querySelectorAll("button").forEach(x=> x.disabled = true);
        b.disabled = false;

        timer = setTimeout(()=>{
          state.idx.quiz += 1;
          saveState();
          render("quiz");
        }, 5000);
      });

      wrap.appendChild(b);
    });

    $("quizHint").addEventListener("click", ()=>{
      openModal("üí° Dica (Quiz)", "Sem entregar a resposta.", `
        <div class="block small">${escapeHtml(item.hint)}</div>
      `);
    });

    $("quizNext").addEventListener("click", ()=>{
      if(timer) clearTimeout(timer);
      state.idx.quiz += 1;
      saveState();
      render("quiz");
    });
  }

  // CASES view
  function renderCases(container){
    const banks = getOrderedBanks();
    const items = banks.cases;

    const idx = state.idx.cases % items.length;
    const item = items[idx];

    const html = `
      <div class="block">
        <div class="tiny">C√≥digo da aula: <b>${escapeHtml(state.classCode)}</b> ‚Ä¢ Passo: <b>${idx}</b></div>
        <div style="font-weight:900; font-size:22px; margin-top:8px;">üìã ${escapeHtml(item.title)}</div>
        <div class="small muted" style="margin-top:8px;">${escapeHtml(item.stem)}</div>

        <div class="hr"></div>

        <div style="font-weight:900; font-size:18px;">${escapeHtml(item.q)}</div>
        <div class="grid" style="margin-top:12px;" id="caseOpts"></div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn btnSmall" style="width:auto;" id="caseHint">üí° Dica</button>
          <button class="btn btnPrimary btnSmall" style="width:auto;" id="caseNext">‚û°Ô∏è Pr√≥ximo caso</button>
        </div>

        <div id="caseFb" class="block small" style="margin-top:12px; display:none;"></div>
      </div>
    `;
    const c = viewCard("üìã Casos Cl√≠nicos", "20 casos rotativos pelo C√≥digo da Aula.", html);
    container.appendChild(c);

    const wrap = $("caseOpts");
    const fb = $("caseFb");
    let locked = false;

    item.opts.forEach((o, i)=>{
      const b = document.createElement("button");
      b.className = "optBtn";
      b.type = "button";
      b.textContent = o.t;

      b.addEventListener("click", ()=>{
        if(locked) return;
        locked = true;

        b.classList.add("selected");
        const ok = !!o.ok;

        if(ok){
          b.classList.add("correct");
          state.correct += 1;
          addScore(item.pts || 10, `Caso correto (${item.title})`);
          mascot("Correto", `+${item.pts||10} pontos`);
        }else{
          b.classList.add("wrong");
          state.wrong += 1;
          mascot("Errado", "Veja a justificativa");
        }

        logReview("case", `${ok?"OK":"ERRO"} ‚Äî ${item.id}`);
        saveState();

        fb.style.display = "block";
        fb.innerHTML = `
          <div style="font-weight:900; font-size:16px;">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
          <div class="muted" style="margin-top:8px;">${escapeHtml(item.why)}</div>
          <div class="tiny" style="margin-top:8px;"><b>Base:</b> ${escapeHtml(item.src)}</div>
        `;

        wrap.querySelectorAll("button").forEach(x=> x.disabled = true);
        b.disabled = false;
      });

      wrap.appendChild(b);
    });

    $("caseHint").addEventListener("click", ()=>{
      openModal("üí° Dica (Caso)", "Sem entregar a resposta.", `
        <div class="block small">${escapeHtml(item.hint)}</div>
      `);
    });

    $("caseNext").addEventListener("click", ()=>{
      state.idx.cases += 1;
      saveState();
      render("cases");
    });
  }

  // CHECKLISTS view
  function renderChecklists(container){
    const banks = getOrderedBanks();
    const items = banks.checklists;

    const idx = state.idx.checklists % items.length;
    const item = items[idx];

    const html = `
      <div class="block">
        <div class="tiny">C√≥digo da aula: <b>${escapeHtml(state.classCode)}</b> ‚Ä¢ Passo: <b>${idx}</b></div>
        <div style="font-weight:900; font-size:22px; margin-top:8px;">‚úÖ ${escapeHtml(item.title)}</div>
        <div class="small muted" style="margin-top:8px;">${escapeHtml(item.intro)}</div>

        <div class="hr"></div>

        <div class="grid" id="clItems"></div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn btnOk btnSmall" style="width:auto;" id="clCheck">‚úÖ Corrigir</button>
          <button class="btn btnSmall btnSmall" style="width:auto;" id="clClear">‚ôªÔ∏è Limpar</button>
          <button class="btn btnPrimary btnSmall" style="width:auto;" id="clNext">‚û°Ô∏è Pr√≥ximo checklist</button>
        </div>

        <div id="clFb" class="block small" style="margin-top:12px; display:none;"></div>
      </div>
    `;
    const c = viewCard("‚úÖ Checklists", "Banco por situa√ß√£o (5 cen√°rios), cada um com itens V/F.", html);
    container.appendChild(c);

    const itemsWrap = $("clItems");
    const fb = $("clFb");

    // render checkboxes
    item.items.forEach((it, i)=>{
      const row = document.createElement("label");
      row.className = "block";
      row.style.display = "flex";
      row.style.gap = "12px";
      row.style.alignItems = "flex-start";
      row.style.cursor = "pointer";

      row.innerHTML = `
        <input type="checkbox" id="cl_${i}" style="width:22px; height:22px; margin-top:2px; accent-color: ${it.truth ? "#22C55E" : "#F59E0B"};">
        <div style="flex:1;">
          <div style="font-weight:900;">${escapeHtml(it.t)}</div>
          <div class="tiny" style="margin-top:6px; color: rgba(234,242,255,0.62);">${escapeHtml(it.why)}</div>
        </div>
      `;
      itemsWrap.appendChild(row);
    });

    $("clClear").addEventListener("click", ()=>{
      item.items.forEach((_,i)=> { const cb = $("cl_"+i); if(cb) cb.checked = false; });
      fb.style.display = "none";
      fb.innerHTML = "";
      toast("Limpo", "Sele√ß√µes removidas.");
    });

    $("clCheck").addEventListener("click", ()=>{
      let correctCount = 0;
      const total = item.items.length;
      const details = [];

      item.items.forEach((it, i)=>{
        const cb = $("cl_"+i);
        const checked = !!cb?.checked;
        const ok = (checked === it.truth);
        if(ok) correctCount++;

        details.push(`
          <div class="block small" style="margin-top:10px;">
            <div style="font-weight:900;">${ok ? "‚úÖ" : "‚ùå"} ${escapeHtml(it.t)}</div>
            <div class="tiny" style="margin-top:6px;"><b>Gabarito:</b> ${it.truth ? "Verdadeiro" : "Falso"}</div>
          </div>
        `);
      });

      const pct = Math.round((correctCount/total)*100);
      const gained = pct >= 80 ? (item.pts||14) : pct >= 60 ? 6 : 2;

      fb.style.display = "block";
      fb.innerHTML = `
        <div style="font-weight:900; font-size:18px;">Resultado: ${pct}% (${correctCount}/${total})</div>
        <div class="tiny" style="margin-top:8px;"><b>Base:</b> ${escapeHtml(item.src)}</div>
        <div class="muted small" style="margin-top:10px;">+${gained} pontos (educacional)</div>
        ${details.join("")}
      `;

      addScore(gained, `Checklist (${item.title})`);
      if(pct >= 80){ state.correct += 1; mascot("√ìtimo", `+${gained} pontos`); }
      else if(pct >= 60){ mascot("Quase", "Refine os itens"); }
      else { state.wrong += 1; mascot("Refor√ßo", "Reveja o gabarito"); }
      logReview("checklist", `${pct}% ‚Äî ${item.id}`);
      saveState();
    });

    $("clNext").addEventListener("click", ()=>{
      state.idx.checklists += 1;
      saveState();
      render("checklists");
    });
  }

  // Pathologies view
  function renderPath(container){
    const html = `
      <div class="block">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
          <div>
            <div style="font-weight:900; font-size:20px;">üß© Patologias & Interven√ß√µes (educacional)</div>
            <div class="small muted" style="margin-top:6px;">Busca r√°pida para estudo. Conte√∫do conceitual.</div>
          </div>
          <div style="min-width: 280px; flex: 1;">
            <input id="pathSearch" placeholder="Buscar: sepse, avc, iam, choque..." />
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2" id="pathList"></div>
      </div>
    `;
    const c = viewCard("üß© Patologias", "Lista ampliada (voc√™ pode adicionar mais facilmente).", html);
    container.appendChild(c);

    const list = $("pathList");
    const search = $("pathSearch");

    function renderList(){
      const q = (search.value||"").trim().toLowerCase();
      const items = PATHOLOGIES.filter(p=>{
        if(!q) return true;
        return p.name.toLowerCase().includes(q) || (p.tags||[]).some(t=>t.toLowerCase().includes(q));
      });

      list.innerHTML = items.map(p=>`
        <div class="block">
          <div style="font-weight:900; font-size:18px;">${escapeHtml(p.name)}</div>
          <div class="tiny" style="margin-top:8px; color: rgba(234,242,255,0.60);">
            Tags: ${escapeHtml((p.tags||[]).join(", "))}
          </div>
          <div class="hr"></div>
          <div class="small muted"><b>Interven√ß√µes iniciais (conceitos):</b></div>
          <ul class="small muted" style="margin-top:10px; padding-left: 18px;">
            ${(p.actions||[]).map(x=>`<li style="margin-top:6px;">${escapeHtml(x)}</li>`).join("")}
          </ul>
          <div class="tiny" style="margin-top:12px;"><b>Base:</b> ${escapeHtml(p.src)}</div>
        </div>
      `).join("") || `<div class="muted small">Nenhum resultado.</div>`;
    }

    search.addEventListener("input", renderList);
    renderList();
  }

  // EPIs view
  function renderEPIs(container){
    const html = `
      <div class="grid2">
        ${EPIS.map(section=>`
          <div class="block">
            <div style="font-weight:900; font-size:18px;">${escapeHtml(section.title)}</div>
            <div class="hr"></div>
            <ul class="small muted" style="padding-left:18px;">
              ${section.items.map(i=>`<li style="margin-top:8px;">${escapeHtml(i)}</li>`).join("")}
            </ul>
          </div>
        `).join("")}
      </div>
    `;
    container.appendChild(viewCard("üß§ EPIs", "Somente o nome EPIs, com conte√∫do essencial.", html));
  }

  // ER view: select scenario then tasks (sequence)
  function renderER(container){
    const banks = getOrderedBanks();
    const scenarios = banks.er;

    const idx = state.idx.er % scenarios.length;
    const current = scenarios[idx];

    const html = `
      <div class="grid2">
        <div class="block">
          <div class="tiny">C√≥digo da aula: <b>${escapeHtml(state.classCode)}</b> ‚Ä¢ Passo: <b>${idx}</b></div>
          <div style="font-weight:900; font-size:20px; margin-top:8px;">üöë Situa√ß√£o selecionada</div>

          <div class="hr"></div>

          <label class="small muted"><b>Escolha a situa√ß√£o:</b></label>
          <select id="erSelect" style="margin-top:10px;">
            ${scenarios.map((s,i)=>`<option value="${i}" ${i===idx?"selected":""}>${escapeHtml(s.title)}</option>`).join("")}
          </select>

          <div class="hr"></div>

          <div style="font-weight:900; font-size:18px;">${escapeHtml(current.title)}</div>
          <div class="small muted" style="margin-top:8px;">${escapeHtml(current.intro)}</div>

          <div class="hr"></div>

          <div class="small muted"><b>Sequ√™ncia (educacional):</b></div>
          <ol class="small muted" style="margin-top:10px; padding-left: 18px;">
            ${current.steps.map(s=>`<li style="margin-top:6px;">${escapeHtml(s)}</li>`).join("")}
          </ol>

          <div class="hr"></div>

          <div class="btnRow">
            <button class="btn btnSmall" style="width:auto;" id="erHint">üí° Dica</button>
            <button class="btn btnPrimary btnSmall" style="width:auto;" id="erNextScenario">‚û°Ô∏è Pr√≥xima situa√ß√£o</button>
          </div>

          <div class="tiny" style="margin-top:10px;"><b>Base:</b> ${escapeHtml(current.src)}</div>
        </div>

        <div class="block">
          <div style="font-weight:900; font-size:20px;">üß© Etapas para marcar</div>
          <div class="small muted" style="margin-top:8px;">Responda as 3 etapas. Ao clicar, a op√ß√£o fica verde e mostra certo/errado.</div>

          <div class="hr"></div>

          <div class="grid" id="erTasks"></div>

          <div id="erFb" class="block small" style="margin-top
