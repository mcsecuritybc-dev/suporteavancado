<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Centro de Treinamento Avan√ßado</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .glass { background: rgba(15, 23, 42, 0.55); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.18); }
    .card  { background: rgba(2, 6, 23, 0.62); border: 1px solid rgba(148, 163, 184, 0.16); }
    .mono { font-feature-settings: "tnum" 1, "lnum" 1; font-variant-numeric: tabular-nums; }

    .btn { border-radius: 18px; padding: 14px 16px; font-weight: 800; letter-spacing: 0.2px; }
    .btn-ghost { background: rgba(30, 41, 59, 0.55); border: 1px solid rgba(148, 163, 184, 0.18); }
    .btn-ghost:hover { background: rgba(51, 65, 85, 0.6); }
    .btn-primary { background: linear-gradient(135deg, rgba(34, 211, 238, 0.92), rgba(99, 102, 241, 0.92)); }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-danger { background: linear-gradient(135deg, rgba(248, 113, 113, 0.95), rgba(244, 63, 94, 0.95)); }
    .btn-ok { background: linear-gradient(135deg, rgba(74, 222, 128, 0.95), rgba(16, 185, 129, 0.95)); }
    .btn-warn { background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95)); }

    /* Sidebar nav: fix icon width so labels never squeeze */
    .navbtn { width: 100%; display:flex; align-items:center; justify-content:space-between; gap:12px; text-align:left; }
    .navleft { display:flex; align-items:center; gap:12px; min-width: 0; }
    .navicon { width: 34px; height: 34px; display:flex; align-items:center; justify-content:center; flex: 0 0 34px; font-size: 20px; }
    .navlabel { font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .navarrow { opacity: .85; }

    /* Toast */
    #toastArea { position: fixed; inset: auto 0 18px 0; display:flex; justify-content:center; z-index: 60; pointer-events:none; }
    .toast { max-width: 980px; width: calc(100% - 24px); border-radius: 18px; padding: 12px 14px; pointer-events:none; }

    /* Mascote feedback */
    #popCenter { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index: 70; pointer-events:none; }
    #popCenter.show { display:flex; }
    #popCard { border-radius: 26px; padding: 18px 22px; background: rgba(2, 6, 23, 0.78);
      border: 1px solid rgba(148, 163, 184, 0.18); box-shadow: 0 30px 120px rgba(0,0,0,.55); }

    /* Modal */
    #modal { display:none; }
    #modal.show { display:block; }

    /* Ensure clicks always work (no accidental overlays) */
    .clickable { pointer-events:auto; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-slate-900"></div>
    <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full blur-3xl opacity-30 bg-cyan-400"></div>
    <div class="absolute top-40 -right-24 h-80 w-80 rounded-full blur-3xl opacity-25 bg-indigo-500"></div>
    <div class="absolute bottom-0 left-1/3 h-72 w-72 rounded-full blur-3xl opacity-20 bg-emerald-500"></div>
  </div>

  <!-- Mobile top bar -->
  <header class="lg:hidden sticky top-0 z-40 glass clickable">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <button id="btnToggleSidebar" class="btn btn-ghost flex items-center gap-3 clickable" type="button">
        <span class="text-xl">üß≠</span><span class="text-base font-extrabold">Menu</span>
      </button>

      <div class="flex items-center gap-3">
        <div class="px-3 py-2 rounded-2xl card mono">
          <div class="text-xs text-slate-300">Score</div>
          <div class="text-lg font-extrabold" id="scoreHeader">0</div>
        </div>
        <button id="btnQuickReset" class="btn btn-danger flex items-center gap-2 clickable" type="button">
          ‚ôªÔ∏è <span>Reset</span>
        </button>
      </div>
    </div>
  </header>

  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-[360px] shrink-0 hidden lg:flex flex-col gap-3 p-4 glass border-r border-slate-700/30 sticky top-0 h-screen clickable">
      <div class="card rounded-3xl p-4">
        <div class="text-center">
          <div class="text-xs text-slate-300">CENTRO DE TREINAMENTO AVAN√áADO</div>
          <div class="text-2xl font-extrabold tracking-tight mt-1">üè• CTA ‚Äî Emerg√™ncia</div>
          <div class="text-slate-300 text-sm mt-1">Simula√ß√µes e treino multiprofissional</div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-4">
          <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3 mono">
            <div class="text-xs text-slate-300">Score</div>
            <div class="text-2xl font-extrabold" id="scoreSidebar">0</div>
          </div>
          <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3 mono">
            <div class="text-xs text-slate-300">Acerto</div>
            <div class="text-2xl font-extrabold" id="accuracySidebar">0%</div>
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between gap-3">
          <div>
            <div class="text-xs text-slate-300">Aluno</div>
            <div class="text-lg font-extrabold" id="userNameLabel">Aluno</div>
          </div>
          <button id="btnChangeName" class="btn btn-ghost clickable" type="button">‚úèÔ∏è Nome</button>
        </div>

        <div class="mt-3 text-xs text-slate-400">
          Criador: <b class="text-slate-200">Dr. Moacir Carrion ‚Äî Fisioterapeuta</b>
        </div>
      </div>

      <nav class="card rounded-3xl p-3 clickable">
        <div class="text-xs text-slate-300 px-2 pb-2">Menu</div>

        <div class="grid gap-2">
          <button class="btn navbtn btn-primary clickable" data-view="dashboard" type="button">
            <span class="navleft">
              <span class="navicon">üßë‚Äç‚öïÔ∏è</span><span class="navlabel">Painel</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="er" type="button">
            <span class="navleft">
              <span class="navicon">üöë</span><span class="navlabel">Sala de Emerg√™ncia</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="triage" type="button">
            <span class="navleft">
              <span class="navicon">üö¶</span><span class="navlabel">Triagem (ABCDE)</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="cases" type="button">
            <span class="navleft">
              <span class="navicon">üìã</span><span class="navlabel">Casos Cl√≠nicos</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="quiz" type="button">
            <span class="navleft">
              <span class="navicon">üß†</span><span class="navlabel">Quiz</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="checklists" type="button">
            <span class="navleft">
              <span class="navicon">‚úÖ</span><span class="navlabel">Checklists (V/F)</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="epis" type="button">
            <span class="navleft">
              <span class="navicon">üß§</span><span class="navlabel">EPIs</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="path" type="button">
            <span class="navleft">
              <span class="navicon">üß©</span><span class="navlabel">Patologias & Interven√ß√µes</span>
            </span><span class="navarrow">‚Üí</span>
          </button>

          <button class="btn navbtn btn-ghost clickable" data-view="review" type="button">
            <span class="navleft">
              <span class="navicon">üìö</span><span class="navlabel">Revis√£o</span>
            </span><span class="navarrow">‚Üí</span>
          </button>
        </div>
      </nav>

      <div class="card rounded-3xl p-3 clickable">
        <div class="grid grid-cols-2 gap-2">
          <button id="btnSound" class="btn btn-ghost clickable" type="button">üîä Som</button>
          <button id="btnResetAll" class="btn btn-danger clickable" type="button">üßπ Limpar</button>
        </div>
      </div>

      <div class="text-xs text-slate-400 px-1">
        Progresso fica salvo neste navegador.
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-4 lg:p-8 clickable">
      <div class="hidden lg:block mb-6">
        <div class="glass rounded-3xl p-5 clickable">
          <div class="text-center">
            <div class="text-xs text-slate-300">CENTRO DE TREINAMENTO AVAN√áADO</div>
            <div class="text-3xl font-extrabold tracking-tight mt-1" id="pageTitle">Painel</div>
            <div class="text-slate-300 text-sm mt-2" id="pageSubtitle">Treine decis√µes e rotinas com feedback imediato.</div>
          </div>

          <div class="mt-4 flex flex-wrap justify-center gap-3">
            <div class="card rounded-3xl p-4 mono min-w-[160px] text-center">
              <div class="text-xs text-slate-300">Score</div>
              <div class="text-3xl font-extrabold" id="scoreTop">0</div>
            </div>
            <div class="card rounded-3xl p-4 mono min-w-[160px] text-center">
              <div class="text-xs text-slate-300">Acerto</div>
              <div class="text-3xl font-extrabold" id="accuracyTop">0%</div>
            </div>
          </div>
        </div>
      </div>

      <section id="viewContainer" class="space-y-6 clickable"></section>

      <footer class="mt-10 text-xs text-slate-400">
        <div class="card rounded-3xl p-4 clickable">
          <div class="font-extrabold text-slate-200">üß∑ Aviso</div>
          <div class="mt-2">
            Material educacional para simula√ß√£o. Condutas reais dependem de protocolo institucional e avalia√ß√£o cl√≠nica.
          </div>
          <div class="mt-2">
            Criador: <b class="text-slate-200">Dr. Moacir Carrion ‚Äî Fisioterapeuta</b>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Toast -->
  <div id="toastArea" aria-live="polite" aria-atomic="true"></div>

  <!-- Mascote -->
  <div id="popCenter" aria-hidden="true">
    <div id="popCard">
      <div class="flex items-center gap-4">
        <div class="text-6xl">üßë‚Äçüöí</div>
        <div>
          <div class="text-2xl font-extrabold" id="popTitle">Boa!</div>
          <div class="text-slate-300" id="popText">Voc√™ ganhou pontos.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-50 clickable" aria-hidden="true">
    <div class="absolute inset-0 bg-black/60 clickable" id="modalBackdrop"></div>
    <div class="relative min-h-full flex items-center justify-center p-4 clickable">
      <div class="card rounded-3xl w-full max-w-2xl p-5 clickable">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold" id="modalTitle">T√≠tulo</div>
            <div class="text-slate-300 mt-1" id="modalSubtitle">Texto</div>
          </div>
          <button id="modalClose" class="btn btn-ghost clickable" type="button">‚úñÔ∏è Fechar</button>
        </div>
        <div class="mt-4" id="modalBody"></div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const LS_KEY = "cta_emergencia_v3";

  const stateDefault = {
    userName: "Aluno",
    score: 0,
    correct: 0,
    wrong: 0,
    sound: true,
    reviewLog: [],
    seenQuestionIds: [],
    seenCaseIds: [],
    seenChecklistIds: [],
    seenErSeqIds: [],
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(stateDefault);
      const parsed = JSON.parse(raw);
      return { ...structuredClone(stateDefault), ...parsed };
    } catch(e){
      return structuredClone(stateDefault);
    }
  }

  let appState = loadState();

  const el = (id) => document.getElementById(id);

  // Sound
  const audioCtx = { ctx: null };
  function beep(freq=660, ms=80){
    if(!appState.sound) return;
    try{
      if(!audioCtx.ctx) audioCtx.ctx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioCtx.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = freq;
      g.gain.value = 0.06;
      o.start();
      setTimeout(()=>o.stop(), ms);
    } catch(e){}
  }

  function escapeHtml(str){
    return (""+str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function toast(type, title, message){
    const area = el("toastArea");
    const box = document.createElement("div");
    box.className = "toast glass";
    const icon = type === "ok" ? "‚úÖ" : type === "warn" ? "‚ö†Ô∏è" : type === "bad" ? "‚ùå" : "‚ÑπÔ∏è";
    box.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="text-2xl">${icon}</div>
        <div class="flex-1">
          <div class="font-extrabold">${escapeHtml(title)}</div>
          <div class="text-slate-200/90 text-sm mt-1 leading-relaxed">${escapeHtml(message)}</div>
        </div>
      </div>`;
    area.appendChild(box);
    setTimeout(()=>{ box.style.opacity="0"; box.style.transform="translateY(6px)"; box.style.transition="all .18s ease"; }, 2600);
    setTimeout(()=>box.remove(), 3000);
  }

  function popCenter(title, text, ms=5000){
    el("popTitle").textContent = title;
    el("popText").textContent = text;
    const pc = el("popCenter");
    pc.classList.add("show");
    pc.setAttribute("aria-hidden","false");
    setTimeout(()=>{
      pc.classList.remove("show");
      pc.setAttribute("aria-hidden","true");
    }, ms);
  }

  function accuracy(){
    const total = appState.correct + appState.wrong;
    if(total === 0) return 0;
    return Math.round((appState.correct / total) * 100);
  }

  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(appState));
    renderScoreWidgets();
  }

  function addReview(entry){
    appState.reviewLog.unshift({ t: new Date().toISOString(), ...entry });
    if(appState.reviewLog.length > 300) appState.reviewLog.pop();
  }

  function addScore(delta, why){
    appState.score = Math.max(0, appState.score + delta);
    addReview({ type:"score", delta, why });
    saveState();
  }

  function resetProgress(){
    const keepName = appState.userName || "Aluno";
    appState = structuredClone(stateDefault);
    appState.userName = keepName;
    saveState();
    toast("warn","Progresso apagado","Score e hist√≥rico foram reiniciados neste navegador.");
    go("dashboard");
  }

  function renderScoreWidgets(){
    const s = appState.score;
    const acc = accuracy();
    ["scoreHeader","scoreSidebar","scoreTop"].forEach(id => { if(el(id)) el(id).textContent = s; });
    ["accuracySidebar","accuracyTop"].forEach(id => { if(el(id)) el(id).textContent = `${acc}%`; });
    if(el("userNameLabel")) el("userNameLabel").textContent = appState.userName || "Aluno";
  }

  // Modal
  function openModal(title, subtitle, bodyHtml){
    el("modalTitle").textContent = title;
    el("modalSubtitle").textContent = subtitle || "";
    el("modalBody").innerHTML = bodyHtml || "";
    el("modal").classList.add("show");
    el("modal").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    el("modal").classList.remove("show");
    el("modal").setAttribute("aria-hidden","true");
  }
  el("modalClose").addEventListener("click", closeModal);
  el("modalBackdrop").addEventListener("click", closeModal);

  // DATA (compacta; voc√™ pode ampliar depois mantendo o padr√£o)
  const QUESTION_BANK = [
    {id:"q1", topic:"ABCDE", level:1, q:"No ABCDE, a prioridade inicial (A) √©:", options:[
      "Avaliar perfus√£o","Garantir via a√©rea e prote√ß√£o cervical quando indicado","Avaliar Glasgow"
    ], answerIndex:1,
    rationale:"A = Airway. Via a√©rea amea√ßada tem prioridade antes de B/C/D/E.",
    source:"Conceitos de avalia√ß√£o prim√°ria/ABCDE."},

    {id:"q2", topic:"RCP/ACLS", level:1, q:"Em FV/TV sem pulso, conduta inicial:", options:[
      "Desfibrilar e retomar RCP imediatamente","Atropina","Aguardar monitoriza√ß√£o"
    ], answerIndex:0,
    rationale:"Ritmo choc√°vel: desfibrila√ß√£o precoce + RCP de alta qualidade.",
    source:"Diretrizes AHA/ACLS (conceitos)."},

    {id:"q3", topic:"Sepse", level:2, q:"Em suspeita de sepse, uma a√ß√£o cr√≠tica nas primeiras horas:", options:[
      "Aguardar cultura por 24h","Iniciar antibi√≥tico oportuno e bundle conforme protocolo","Suspender monitoriza√ß√£o"
    ], answerIndex:1,
    rationale:"Sepse √© tempo-dependente: interven√ß√£o precoce melhora desfecho.",
    source:"Surviving Sepsis Campaign (conceitos de bundle)."},
  ];

  const CASE_BANK = [
    { id:"c1", title:"üöë Caso: Sepse prov√°vel", intro:"67a com febre, confus√£o, pele fria.", vitals:{FR:"30",SpO2:"88% AA",FC:"118",PA:"86/54"}, question:"Prioridade imediata no in√≠cio do atendimento:",
      options:[
        {text:"Iniciar oxig√™nio e avalia√ß√£o ventilat√≥ria + monitoriza√ß√£o", ok:true},
        {text:"Aguardar RX antes de qualquer interven√ß√£o", ok:false},
        {text:"Oferecer √°gua e observar", ok:false},
      ],
      rationale:"Hipoxemia/taquipneia exigem interven√ß√£o no B (Breathing) imediatamente; bundle de sepse segue fluxo.",
      source:"ABCDE + Surviving Sepsis (conceitos).", points:10
    },
    { id:"c2", title:"‚ö° Caso: PCR com FV", intro:"Colapso s√∫bito; monitor mostra FV.", vitals:{Ritmo:"FV",Pulso:"Ausente"}, question:"A√ß√£o imediata mais efetiva:",
      options:[
        {text:"Desfibrilar e retomar RCP", ok:true},
        {text:"Checar pupilas por 2 min", ok:false},
        {text:"Atropina como 1¬™ medida", ok:false},
      ],
      rationale:"RCP de alta qualidade e desfibrila√ß√£o precoce em ritmos choc√°veis.",
      source:"AHA/ACLS (conceitos).", points:10
    },
  ];

  const CHECKLIST_BANK = [
    { id:"cl1", title:"‚úÖ Medica√ß√£o segura", intro:"Marque as afirma√ß√µes VERDADEIRAS (boas pr√°ticas).",
      items:[
        {text:"Confirmar identifica√ß√£o ativa do paciente.", truth:true, why:"Barreira contra erro de paciente."},
        {text:"Administrar sem checar alergias.", truth:false, why:"Alergias devem ser verificadas."},
        {text:"Rotular seringas/solu√ß√µes preparadas.", truth:true, why:"Reduz troca e erro de droga/dose."},
      ],
      source:"Boas pr√°ticas de seguran√ßa do paciente (conceitos).", points:12
    }
  ];

  const EPIS = [
    {title:"üß§ EPIs essenciais (base)", items:["Higieniza√ß√£o de m√£os","Luvas quando indicado","M√°scara conforme risco","Prote√ß√£o ocular quando respingos","Avental quando contato com fluidos"]},
    {title:"üßº Boas pr√°ticas", items:["Troca de luvas entre pacientes","Descarte correto","N√£o tocar face/m√°scara","Limpeza de superf√≠cies conforme protocolo"]},
  ];

  const PATH_DB = [
    { name:"Sepse/Choque s√©ptico", tags:["infec√ß√£o","hipotens√£o","lactato"], initial:[
      "Reconhecer sinais de hipoperfus√£o e iniciar monitoriza√ß√£o.",
      "Coletar exames conforme protocolo e iniciar antibi√≥tico oportuno.",
      "Reposi√ß√£o vol√™mica e vasopressor quando indicado (protocolo).",
      "Reavalia√ß√£o seriada (perfus√£o, diurese, lactato)."
    ], source:"Surviving Sepsis (conceitos)."},
    { name:"PCR (FV/TV sem pulso)", tags:["acls","choque"], initial:[
      "RCP de alta qualidade, minimizar pausas.",
      "Desfibrilar precocemente quando indicado.",
      "Organizar equipe e ciclos conforme protocolo.",
      "P√≥s-ROSC: otimizar ventila√ß√£o/perfus√£o e investigar causa."
    ], source:"AHA/ACLS (conceitos)."},
  ];

  // Sala de emerg√™ncia: sequ√™ncias + ‚Äúligar no paciente‚Äù
  const ER_SEQUENCES = [
    {
      id:"er_pcr",
      title:"üöë Sequ√™ncia: PCR (adulto) ‚Äî base educacional",
      steps:[
        "Avaliar responsividade e respira√ß√£o/pulso rapidamente",
        "Acionar ajuda e iniciar RCP de alta qualidade",
        "Desfibrilar se ritmo choc√°vel (FV/TVsp) e retomar RCP",
        "Reavaliar ritmos em ciclos e tratar causas revers√≠veis",
        "P√≥s-ROSC: otimizar ventila√ß√£o/perfus√£o e investigar causa"
      ],
      source:"AHA/ACLS (conceitos)."
    },
    {
      id:"er_sepse",
      title:"ü©∏ Sequ√™ncia: Sepse prov√°vel ‚Äî base educacional",
      steps:[
        "Reconhecer sinais de gravidade e iniciar monitoriza√ß√£o",
        "Oxigenar/ventilar se necess√°rio (ABCDE)",
        "Coletar exames/culturas conforme protocolo e iniciar antibi√≥tico oportuno",
        "Reposi√ß√£o vol√™mica e reavalia√ß√£o de perfus√£o",
        "Escalonar suporte (vasopressor/UTI) quando indicado pelo protocolo"
      ],
      source:"Surviving Sepsis (conceitos)."
    },
  ];

  // Atividade ‚Äúligar no paciente‚Äù (n√∫meros no corpo)
  // O aluno escolhe qual etapa (em ordem) corresponde a cada n√∫mero.
  // Aqui usamos a sequ√™ncia de RCP como default (voc√™ pode trocar/duplicar depois).
  const ER_LINK_GAME = {
    title:"üß© Atividade: Ligar sequ√™ncia no paciente (dec√∫bito dorsal)",
    description:"Para cada n√∫mero no corpo, selecione a etapa correta da sequ√™ncia (ordem).",
    sequenceId:"er_pcr",
    spots:[
      { n:1, label:"Cabe√ßa/Consci√™ncia" },
      { n:2, label:"T√≥rax (compress√µes)" },
      { n:3, label:"Desfibrilador/choque" },
      { n:4, label:"Acesso/medica√ß√µes (conceito)" },
      { n:5, label:"Monitor/ritmo" },
      { n:6, label:"P√≥s-ROSC (cuidados)" },
    ],
    // gabarito por n√∫mero -> √≠ndice da etapa (1..steps.length)
    answerBySpot: { 1:1, 2:2, 3:3, 4:4, 5:4, 6:5 }, // 4 e 5 podem ‚Äúconvergir‚Äù na etapa 4 (ciclos/ritmo/causas)
    points: 20
  };

  // Helpers: rotation
  function pickRotating(arr, seenKey){
    const seen = new Set(appState[seenKey] || []);
    let unseen = arr.filter(x => !seen.has(x.id));
    if(unseen.length === 0) unseen = arr;
    const item = unseen[Math.floor(Math.random() * unseen.length)];
    if(item && !seen.has(item.id)){
      appState[seenKey].push(item.id);
      if(appState[seenKey].length > 500) appState[seenKey].shift();
      saveState();
    }
    return item;
  }

  // Views
  const VIEW_META = {
    dashboard: { title:"Painel", subtitle:"Escolha um m√≥dulo e treine com feedback imediato." },
    er: { title:"Sala de Emerg√™ncia", subtitle:"Sequ√™ncias de procedimentos + atividade pr√°tica." },
    triage: { title:"Triagem (ABCDE)", subtitle:"Decida prioridades e receba corre√ß√£o." },
    cases: { title:"Casos Cl√≠nicos", subtitle:"Casos rotativos com resposta e justificativa." },
    quiz: { title:"Quiz", subtitle:"Responda e avance automaticamente em 5 segundos." },
    checklists: { title:"Checklists (V/F)", subtitle:"Marque itens corretos e finalize para ver o resultado." },
    epis: { title:"EPIs", subtitle:"Resumo educacional de EPIs e boas pr√°ticas." },
    path: { title:"Patologias & Interven√ß√µes", subtitle:"Consulta r√°pida para estudo (educacional)." },
    review: { title:"Revis√£o", subtitle:"Hist√≥rico e plano r√°pido de refor√ßo." },
  };

  const viewContainer = el("viewContainer");

  function setHeader(view){
    const m = VIEW_META[view] || VIEW_META.dashboard;
    el("pageTitle").textContent = m.title;
    el("pageSubtitle").textContent = m.subtitle;
    document.title = `Centro de Treinamento Avan√ßado ‚Äî ${m.title}`;
  }

  function sectionCard(title, subtitle, innerHtml){
    const wrap = document.createElement("div");
    wrap.className = "card rounded-3xl p-5 clickable";
    wrap.innerHTML = `
      <div>
        <div class="text-2xl font-extrabold">${escapeHtml(title)}</div>
        ${subtitle ? `<div class="text-slate-300 mt-1">${escapeHtml(subtitle)}</div>` : ""}
      </div>
      <div class="mt-4">${innerHtml}</div>
    `;
    return wrap;
  }

  function go(view){
    setHeader(view);

    // highlight nav
    document.querySelectorAll("[data-view]").forEach(b=>{
      if(b.dataset.view === view){
        b.classList.remove("btn-ghost");
        b.classList.add("btn-primary");
      } else {
        b.classList.remove("btn-primary");
        b.classList.add("btn-ghost");
      }
    });

    renderView(view);

    // close sidebar on mobile
    if(window.innerWidth < 1024){
      el("sidebar").classList.add("hidden");
    }
  }

  function renderView(view){
    viewContainer.innerHTML = "";
    if(view === "dashboard") return renderDashboard();
    if(view === "er") return renderER();
    if(view === "triage") return renderTriage();
    if(view === "cases") return renderCases();
    if(view === "quiz") return renderQuiz();
    if(view === "checklists") return renderChecklists();
    if(view === "epis") return renderEPIs();
    if(view === "path") return renderPath();
    if(view === "review") return renderReview();
    return renderDashboard();
  }

  // Dashboard
  function renderDashboard(){
    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-xl font-extrabold">üöÄ Iniciar</div>
          <div class="text-slate-300 mt-2">Escolha um m√≥dulo e treine.</div>

          <div class="grid sm:grid-cols-2 gap-3 mt-4">
            <button class="btn btn-primary clickable" data-go="er">üöë Sala de Emerg√™ncia</button>
            <button class="btn btn-primary clickable" data-go="triage">üö¶ Triagem ABCDE</button>
            <button class="btn btn-ghost clickable" data-go="cases">üìã Casos Cl√≠nicos</button>
            <button class="btn btn-ghost clickable" data-go="quiz">üß† Quiz</button>
            <button class="btn btn-ghost clickable" data-go="checklists">‚úÖ Checklists</button>
            <button class="btn btn-ghost clickable" data-go="epis">üß§ EPIs</button>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-xl font-extrabold">üìå Como funciona</div>
          <div class="mt-3 grid gap-3 text-slate-300 text-sm">
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">‚úÖ Sele√ß√£o</div>
              <div class="mt-1">Ao clicar, a op√ß√£o fica <b>verde</b> e aparece <b>Correto/Errado</b>.</div>
            </div>
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">‚è±Ô∏è Quiz autom√°tico</div>
              <div class="mt-1">Ap√≥s responder, a pr√≥xima quest√£o aparece em <b>5 segundos</b>.</div>
            </div>
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">üìö Embasamento</div>
              <div class="mt-1">Cada item traz justificativa baseada em diretrizes/boas pr√°ticas (conceitos).</div>
            </div>
          </div>
        </div>
      </div>
    `;
    const card = sectionCard("üßë‚Äç‚öïÔ∏è Painel", "Centro de Treinamento Avan√ßado.", html);
    viewContainer.appendChild(card);
    card.querySelectorAll("[data-go]").forEach(btn => btn.addEventListener("click", () => go(btn.dataset.go)));
  }

  // Sala de Emerg√™ncia
  function renderER(){
    const seqCards = ER_SEQUENCES.map(seq => `
      <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
        <div class="text-xl font-extrabold">${escapeHtml(seq.title)}</div>
        <ol class="mt-3 list-decimal pl-6 space-y-1 text-slate-300 text-sm">
          ${seq.steps.map(s => `<li>${escapeHtml(s)}</li>`).join("")}
        </ol>
        <div class="text-slate-400 text-xs mt-3"><b>Base:</b> ${escapeHtml(seq.source)}</div>
      </div>
    `).join("");

    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">üöë Sequ√™ncias de Procedimentos</div>
              <div class="text-slate-300 mt-2">Fluxos educacionais para treino mental.</div>
            </div>
            <button id="btnErHelp" class="btn btn-ghost clickable" type="button">‚ùì Ajuda</button>
          </div>

          <div class="mt-4 grid gap-4">
            ${seqCards}
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">${escapeHtml(ER_LINK_GAME.title)}</div>
              <div class="text-slate-300 mt-2">${escapeHtml(ER_LINK_GAME.description)}</div>
            </div>
            <button id="btnErReset" class="btn btn-danger clickable" type="button">‚ôªÔ∏è Limpar</button>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              ${renderPatientSVG()}
              <div class="text-xs text-slate-400 mt-2">Paciente em dec√∫bito dorsal (visual educacional).</div>
            </div>

            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="text-sm text-slate-300 font-extrabold">Selecione a etapa para cada n√∫mero</div>
              <div id="erSelectors" class="mt-3 grid gap-3"></div>

              <div class="mt-4 flex gap-3">
                <button id="btnErCheck" class="btn btn-ok clickable" type="button">‚úÖ Corrigir</button>
                <button id="btnErNext" class="btn btn-primary clickable" type="button">üîÑ Novo treino</button>
              </div>

              <div id="erFeedback" class="mt-4 hidden rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4"></div>
            </div>
          </div>
        </div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("üöë Sala de Emerg√™ncia", "Procedimentos + atividade pr√°tica.", html));

    const seq = ER_SEQUENCES.find(s => s.id === ER_LINK_GAME.sequenceId) || ER_SEQUENCES[0];
    const steps = seq.steps;

    const selectors = el("erSelectors");
    const feedback = el("erFeedback");

    function renderSelectors(){
      selectors.innerHTML = ER_LINK_GAME.spots.map(spot => {
        const opts = steps.map((s, idx) => `<option value="${idx+1}">${idx+1}. ${escapeHtml(s)}</option>`).join("");
        return `
          <div class="rounded-3xl bg-slate-900/55 border border-slate-700/30 p-3">
            <div class="text-xs text-slate-400">N√∫mero ${spot.n} ‚Äî ${escapeHtml(spot.label)}</div>
            <select id="er_sel_${spot.n}" class="mt-2 w-full rounded-2xl bg-slate-900/60 border border-slate-700/30 px-3 py-3 font-extrabold">
              <option value="">Selecione‚Ä¶</option>
              ${opts}
            </select>
          </div>
        `;
      }).join("");
      feedback.classList.add("hidden");
      feedback.innerHTML = "";
    }

    function clearSelections(){
      ER_LINK_GAME.spots.forEach(s => {
        const sel = el(`er_sel_${s.n}`);
        if(sel) sel.value = "";
      });
      feedback.classList.add("hidden");
      feedback.innerHTML = "";
    }

    function checkGame(){
      let filled = 0;
      let correct = 0;
      const lines = [];

      ER_LINK_GAME.spots.forEach(spot => {
        const sel = el(`er_sel_${spot.n}`);
        const v = sel ? Number(sel.value || 0) : 0;
        if(v) filled++;
        const ans = ER_LINK_GAME.answerBySpot[spot.n];
        const ok = v && (v === ans);
        if(ok) correct++;

        lines.push(`
          <div class="rounded-2xl bg-slate-950/40 border border-slate-700/30 p-3">
            <div class="font-extrabold">${ok ? "‚úÖ" : "‚ùå"} N¬∫ ${spot.n} ‚Äî ${escapeHtml(spot.label)}</div>
            <div class="text-slate-300 text-sm mt-1">
              Voc√™: ${v ? `<b>${v}</b>` : "<b>n√£o selecionado</b>"} ‚Ä¢ Correto: <b>${ans}</b>
            </div>
          </div>
        `);
      });

      if(filled < ER_LINK_GAME.spots.length){
        toast("warn","Faltou selecionar","Selecione uma etapa para todos os n√∫meros antes de corrigir.");
        return;
      }

      const pct = Math.round((correct / ER_LINK_GAME.spots.length) * 100);
      const gained = pct >= 85 ? ER_LINK_GAME.points : pct >= 60 ? 10 : 4;

      if(pct >= 85){
        appState.correct += 1;
        addScore(gained, "Sala de Emerg√™ncia (sequ√™ncia no paciente) ‚Äî alto desempenho");
        beep(880, 90);
        popCenter("Excelente!", `+${gained} pontos.`, 5000);
      } else if(pct >= 60){
        addScore(gained, "Sala de Emerg√™ncia (sequ√™ncia no paciente) ‚Äî parcial");
        beep(520, 90);
        toast("warn","Quase l√°","Revise a sequ√™ncia e tente novamente.");
      } else {
        appState.wrong += 1;
        addScore(gained, "Sala de Emerg√™ncia (sequ√™ncia no paciente) ‚Äî refor√ßo");
        beep(220, 120);
        toast("bad","Refor√ßo necess√°rio","Revise a sequ√™ncia e repita o treino.");
      }

      addReview({type:"er_link", pct, correct});
      saveState();

      feedback.classList.remove("hidden");
      feedback.innerHTML = `
        <div class="text-lg font-extrabold">Resultado: ${pct}% (${correct}/${ER_LINK_GAME.spots.length})</div>
        <div class="text-slate-300 mt-2">Sequ√™ncia usada: <b>${escapeHtml(seq.title)}</b></div>
        <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(seq.source)}</div>
        <div class="mt-4 grid gap-2">${lines.join("")}</div>
      `;
    }

    el("btnErCheck").addEventListener("click", checkGame);
    el("btnErReset").addEventListener("click", clearSelections);
    el("btnErNext").addEventListener("click", () => {
      // Alterna a sequ√™ncia para variar o treino
      const other = ER_SEQUENCES.find(s => s.id !== seq.id) || ER_SEQUENCES[0];
      ER_LINK_GAME.sequenceId = other.id;
      go("er");
    });

    el("btnErHelp").addEventListener("click", () => {
      openModal("‚ùì Ajuda ‚Äî Sala de Emerg√™ncia", "Dica curta (sem entregar respostas)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Pense em <b>prioridade</b> (ABCDE), <b>tempo-depend√™ncia</b> (PCR/sepse/AVC/trauma) e <b>seguran√ßa</b> (monitoriza√ß√£o e barreiras).
        </div>
      `);
    });

    renderSelectors();
  }

  function renderPatientSVG(){
    // Desenho vetorial simples (sem imagens externas) + n√∫meros em regi√µes
    return `
      <svg viewBox="0 0 340 520" class="w-full h-auto">
        <defs>
          <linearGradient id="g1" x1="0" x2="1">
            <stop offset="0" stop-color="rgba(34,211,238,0.22)"/>
            <stop offset="1" stop-color="rgba(99,102,241,0.18)"/>
          </linearGradient>
        </defs>

        <rect x="10" y="10" width="320" height="500" rx="28" fill="url(#g1)" stroke="rgba(148,163,184,0.28)"/>

        <!-- Cabe√ßa -->
        <ellipse cx="170" cy="80" rx="48" ry="55" fill="rgba(15,23,42,0.55)" stroke="rgba(148,163,184,0.32)"/>
        <!-- Pesco√ßo -->
        <rect x="148" y="125" width="44" height="25" rx="12" fill="rgba(15,23,42,0.55)" stroke="rgba(148,163,184,0.32)"/>
        <!-- Tronco -->
        <rect x="110" y="150" width="120" height="190" rx="36" fill="rgba(15,23,42,0.55)" stroke="rgba(148,163,184,0.32)"/>
        <!-- Abd√¥men -->
        <rect x="118" y="285" width="104" height="90" rx="28" fill="rgba(15,23,42,0.45)" stroke="rgba(148,163,184,0.24)"/>
        <!-- Bra√ßos -->
        <rect x="55" y="170" width="50" height="210" rx="22" fill="rgba(15,23,42,0.45)" stroke="rgba(148,163,184,0.24)"/>
        <rect x="235" y="170" width="50" height="210" rx="22" fill="rgba(15,23,42,0.45)" stroke="rgba(148,163,184,0.24)"/>
        <!-- Pernas -->
        <rect x="128" y="375" width="72" height="120" rx="26" fill="rgba(15,23,42,0.45)" stroke="rgba(148,163,184,0.24)"/>
        <rect x="205" y="375" width="72" height="120" rx="26" fill="rgba(15,23,42,0.45)" stroke="rgba(148,163,184,0.24)"/>

        <!-- N√∫meros / Spots -->
        ${spot(1, 170, 60)}
        ${spot(2, 170, 220)}
        ${spot(3, 240, 240)}
        ${spot(4, 70, 250)}
        ${spot(5, 170, 305)}
        ${spot(6, 170, 430)}

        <text x="170" y="505" text-anchor="middle" font-size="12" fill="rgba(226,232,240,0.75)">
          Treino educacional ‚Äî CTA
        </text>
      </svg>
    `;

    function spot(n, x, y){
      return `
        <circle cx="${x}" cy="${y}" r="18" fill="rgba(74,222,128,0.85)" stroke="rgba(15,23,42,0.65)" stroke-width="2"/>
        <text x="${x}" y="${y+5}" text-anchor="middle" font-size="14" font-weight="800" fill="rgba(2,6,23,0.95)">${n}</text>
      `;
    }
  }

  // Triagem (simples)
  function renderTriage(){
    const s = {
      title:"Estridor + fala comprometida",
      text:"Ru√≠do inspirat√≥rio agudo e dificuldade para falar.",
      vitals:{ FR:"34", SpO2:"90% AA", FC:"124", PA:"118/72" },
      correctIndex:0,
      options:[
        "A ‚Äî Priorizar via a√©rea (A) e preparo de suporte conforme protocolo",
        "C ‚Äî Iniciar volume e aguardar",
        "D ‚Äî Exame neurol√≥gico completo antes de A/B"
      ],
      rationale:"Estridor sugere risco de obstru√ß√£o de via a√©rea (A).",
      source:"Conceitos ABCDE."
    };

    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üö¶ Triagem ABCDE</div>
            <div class="text-slate-300 mt-2">Escolha a prioridade imediata.</div>
          </div>
          <button id="btnTriageHelp" class="btn btn-ghost clickable" type="button">‚ùì Ajuda</button>
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
          <div class="text-sm text-slate-400">Cen√°rio</div>
          <div class="text-xl font-extrabold mt-1">${escapeHtml(s.title)}</div>
          <div class="text-slate-300 mt-2">${escapeHtml(s.text)}</div>

          <div class="grid sm:grid-cols-2 gap-3 mt-3 text-sm">
            ${Object.entries(s.vitals).map(([k,v])=>`
              <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3">
                <div class="text-xs text-slate-400">${escapeHtml(k)}</div>
                <div class="font-extrabold mono">${escapeHtml(v)}</div>
              </div>
            `).join("")}
          </div>
        </div>

        <div class="mt-4 grid gap-3" id="triOptions"></div>
        <div class="mt-4 hidden rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="triFeedback"></div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("üö¶ Triagem", "Corre√ß√£o imediata.", html));

    const optWrap = el("triOptions");
    const fb = el("triFeedback");
    let locked = false;

    s.options.forEach((label, i)=>{
      const b = document.createElement("button");
      b.className = "btn btn-ghost clickable w-full text-left";
      b.type = "button";
      b.textContent = label;

      b.addEventListener("click", ()=>{
        if(locked) return;
        locked = true;

        b.classList.remove("btn-ghost");
        b.classList.add("btn-ok");

        const ok = i === s.correctIndex;
        if(ok){
          appState.correct += 1;
          addScore(6, "Triagem correta");
          beep(880, 90);
          popCenter("Correto!", "+6 pontos (Triagem).", 5000);
        } else {
          appState.wrong += 1;
          beep(220, 120);
        }

        addReview({type:"triage", ok, scenario:s.title, choice:label});
        saveState();

        fb.classList.remove("hidden");
        fb.innerHTML = `
          <div class="text-lg font-extrabold">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
          <div class="text-slate-300 mt-2">${escapeHtml(s.rationale)}</div>
          <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(s.source)}</div>
        `;
      });

      optWrap.appendChild(b);
    });

    el("btnTriageHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî Triagem", "Dica curta (sem resposta)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Priorize amea√ßa imediata √† vida. Se houver risco de via a√©rea/ventila√ß√£o, isso vem antes.
        </div>
      `);
    });
  }

  // Casos
  function renderCases(){
    const c = pickRotating(CASE_BANK, "seenCaseIds");
    const vitalsHtml = Object.entries(c.vitals || {}).map(([k,v])=>`
      <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3">
        <div class="text-xs text-slate-400">${escapeHtml(k)}</div>
        <div class="font-extrabold mono">${escapeHtml(v)}</div>
      </div>
    `).join("");

    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üìã Casos Cl√≠nicos</div>
            <div class="text-slate-300 mt-2">Selecione uma conduta e veja justificativa.</div>
          </div>
          <button id="btnCaseNext" class="btn btn-primary clickable" type="button">üîÑ Pr√≥ximo</button>
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
          <div class="text-sm text-slate-400">Caso</div>
          <div class="text-2xl font-extrabold mt-1">${escapeHtml(c.title)}</div>
          <div class="text-slate-300 mt-2">${escapeHtml(c.intro)}</div>

          <div class="grid sm:grid-cols-3 gap-3 mt-4 text-sm">${vitalsHtml}</div>

          <div class="mt-4 rounded-3xl bg-slate-900/50 border border-slate-700/30 p-4">
            <div class="font-extrabold text-lg">Pergunta</div>
            <div class="text-slate-200 mt-1 text-lg font-extrabold">${escapeHtml(c.question)}</div>
          </div>

          <div class="mt-4 grid gap-3" id="caseOptions"></div>
          <div class="mt-4 hidden rounded-3xl bg-slate-900/50 border border-slate-700/30 p-4" id="caseFeedback"></div>
        </div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("üìã Casos Cl√≠nicos", "Feedback imediato.", html));

    const optWrap = el("caseOptions");
    const fb = el("caseFeedback");
    let locked = false;

    c.options.forEach((o, i)=>{
      const b = document.createElement("button");
      b.className = "btn btn-ghost clickable w-full text-left";
      b.type="button";
      b.innerHTML = `<span class="font-extrabold">${String.fromCharCode(65+i)}.</span> ${escapeHtml(o.text)}`;

      b.addEventListener("click", ()=>{
        if(locked) return;
        locked = true;

        b.classList.remove("btn-ghost");
        b.classList.add("btn-ok");

        const ok = !!o.ok;
        if(ok){
          appState.correct += 1;
          addScore(c.points || 10, `Caso correto (${c.title})`);
          beep(880, 90);
          popCenter("Correto!", `+${c.points||10} pontos (Caso).`, 5000);
        } else {
          appState.wrong += 1;
          beep(220, 120);
        }
        addReview({type:"case", ok, title:c.title, selected:o.text});
        saveState();

        fb.classList.remove("hidden");
        fb.innerHTML = `
          <div class="text-lg font-extrabold">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
          <div class="text-slate-300 mt-2">${escapeHtml(c.rationale)}</div>
          <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(c.source)}</div>
        `;
      });

      optWrap.appendChild(b);
    });

    el("btnCaseNext").addEventListener("click", ()=> go("cases"));
  }

  // Quiz (auto-next 5s)
  function renderQuiz(){
    const q = pickRotating(QUESTION_BANK, "seenQuestionIds");

    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üß† Quiz</div>
            <div class="text-slate-300 mt-2">Ap√≥s responder, a pr√≥xima aparece automaticamente em <b>5s</b>.</div>
          </div>
          <div class="flex gap-2">
            <button id="btnQuizHelp" class="btn btn-ghost clickable" type="button">‚ùì Ajuda</button>
            <button id="btnQuizNext" class="btn btn-primary clickable" type="button">‚û°Ô∏è Pr√≥xima</button>
          </div>
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
          <div class="text-sm text-slate-400">Tema: ${escapeHtml(q.topic)} ‚Ä¢ N√≠vel ${q.level}</div>
          <div class="text-2xl font-extrabold mt-2">${escapeHtml(q.q)}</div>

          <div class="grid gap-3 mt-4" id="quizOptions"></div>
          <div class="mt-4 hidden rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4" id="quizFeedback"></div>

          <div class="mt-4 text-sm text-slate-300">
            <b>Auto-pr√≥xima:</b> <span id="autoNextLabel">‚Äî</span>
          </div>
        </div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("üß† Quiz", "Sele√ß√£o verde + corre√ß√£o + auto-pr√≥xima.", html));

    const optWrap = el("quizOptions");
    const fb = el("quizFeedback");
    const autoNextLabel = el("autoNextLabel");

    let answered = false;
    let timer = null;
    let countdown = null;

    function clearTimers(){
      if(timer) clearTimeout(timer);
      if(countdown) clearInterval(countdown);
      timer = null; countdown = null;
      autoNextLabel.textContent = "‚Äî";
    }

    function ptsFor(level){
      if(level === 3) return 9;
      if(level === 2) return 7;
      return 5;
    }

    q.options.forEach((opt, idx)=>{
      const b = document.createElement("button");
      b.className = "btn btn-ghost clickable w-full text-left";
      b.type="button";
      b.innerHTML = `<span class="font-extrabold">${String.fromCharCode(65+idx)}.</span> ${escapeHtml(opt)}`;

      b.addEventListener("click", ()=>{
        if(answered) return;
        answered = true;

        b.classList.remove("btn-ghost");
        b.classList.add("btn-ok");

        const ok = idx === q.answerIndex;
        if(ok){
          const pts = ptsFor(q.level);
          appState.correct += 1;
          addScore(pts, `Quiz correto (${q.topic})`);
          beep(880, 90);
          popCenter("Correto!", `+${pts} pontos (Quiz).`, 5000);
        } else {
          appState.wrong += 1;
          beep(220, 120);
        }

        addReview({type:"quiz", ok, topic:q.topic, level:q.level});
        saveState();

        fb.classList.remove("hidden");
        fb.innerHTML = `
          <div class="text-lg font-extrabold">${ok ? "‚úÖ Correto" : "‚ùå Incorreto"}</div>
          <div class="text-slate-300 mt-2">${escapeHtml(q.rationale)}</div>
          <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(q.source)}</div>
        `;

        // auto next 5s
        clearTimers();
        let secondsLeft = 5;
        autoNextLabel.textContent = `Pr√≥xima em ${secondsLeft}s‚Ä¶`;
        countdown = setInterval(()=>{
          secondsLeft--;
          if(secondsLeft <= 0){
            clearTimers();
            return;
          }
          autoNextLabel.textContent = `Pr√≥xima em ${secondsLeft}s‚Ä¶`;
        }, 1000);

        timer = setTimeout(()=>{
          clearTimers();
          go("quiz");
        }, 5000);

        // lock others
        optWrap.querySelectorAll("button").forEach(x=>x.disabled = true);
        b.disabled = false;
      });

      optWrap.appendChild(b);
    });

    el("btnQuizNext").addEventListener("click", ()=>{ clearTimers(); go("quiz"); });
    el("btnQuizHelp").addEventListener("click", ()=>{
      openModal("‚ùì Ajuda ‚Äî Quiz", "Dica curta (sem resposta)", `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-300">
          Identifique prioridade (ABCDE) e tempo-depend√™ncia (PCR/sepse/AVC/trauma). Foque em seguran√ßa e monitoriza√ß√£o.
        </div>
      `);
    });
  }

  // Checklists
  function renderChecklists(){
    const cl = pickRotating(CHECKLIST_BANK, "seenChecklistIds");

    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">‚úÖ Checklists (V/F)</div>
            <div class="text-slate-300 mt-2">${escapeHtml(cl.intro)}</div>
          </div>
          <button id="btnClNext" class="btn btn-primary clickable" type="button">üîÑ Pr√≥ximo</button>
        </div>

        <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">${escapeHtml(cl.title)}</div>

          <div class="mt-4 grid gap-2" id="clItems">
            ${cl.items.map((it, i)=>`
              <label class="flex items-start gap-3 rounded-3xl bg-slate-900/55 border border-slate-700/30 p-4 cursor-pointer">
                <input type="checkbox" class="mt-1 h-6 w-6 accent-emerald-400" id="cl_it_${i}">
                <span class="font-extrabold">${escapeHtml(it.text)}</span>
              </label>
            `).join("")}
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnClFinish" class="btn btn-ok clickable" type="button">‚úÖ Finalizar e corrigir</button>
            <button id="btnClClear" class="btn btn-ghost clickable" type="button">‚ôªÔ∏è Limpar sele√ß√£o</button>
          </div>

          <div class="mt-4 hidden rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4" id="clFeedback"></div>
        </div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("‚úÖ Checklists", "Marque verdadeiras e corrija.", html));

    const fb = el("clFeedback");

    el("btnClClear").addEventListener("click", ()=>{
      cl.items.forEach((_, i)=> el(`cl_it_${i}`).checked = false);
      fb.classList.add("hidden");
      fb.innerHTML = "";
    });

    el("btnClFinish").addEventListener("click", ()=>{
      let correctCount = 0;
      const lines = [];

      cl.items.forEach((it, i)=>{
        const checked = el(`cl_it_${i}`).checked;
        const ok = (checked === it.truth);
        if(ok) correctCount++;

        lines.push(`
          <div class="rounded-2xl bg-slate-950/40 border border-slate-700/30 p-3">
            <div class="font-extrabold">${ok ? "‚úÖ" : "‚ùå"} ${escapeHtml(it.text)}</div>
            <div class="text-slate-300 text-sm mt-1">${escapeHtml(it.why)}</div>
            <div class="text-slate-400 text-xs mt-1"><b>Gabarito:</b> ${it.truth ? "Verdadeiro" : "Falso"}</div>
          </div>
        `);
      });

      const pct = Math.round((correctCount / cl.items.length) * 100);
      fb.classList.remove("hidden");
      fb.innerHTML = `
        <div class="text-lg font-extrabold">Resultado: ${pct}%</div>
        <div class="text-slate-300 mt-2">Acertos: ${correctCount}/${cl.items.length}</div>
        <div class="text-slate-400 text-sm mt-2"><b>Base:</b> ${escapeHtml(cl.source)}</div>
        <div class="mt-4 grid gap-2">${lines.join("")}</div>
      `;

      const gained = pct >= 80 ? (cl.points||12) : pct >= 60 ? 6 : 2;
      addScore(gained, `Checklist (${cl.title})`);
      if(pct >= 80){ beep(880, 90); popCenter("√ìtimo!", `+${gained} pontos.`, 5000); appState.correct += 1; }
      else if(pct >= 60){ beep(520, 90); toast("warn","Ajuste fino","Revise itens errados e tente outro checklist."); }
      else { beep(220, 120); toast("bad","Refor√ßo","Reveja justificativas e repita."); appState.wrong += 1; }
      addReview({type:"checklist", title:cl.title, pct});
      saveState();
    });

    el("btnClNext").addEventListener("click", ()=> go("checklists"));
  }

  // EPIs
  function renderEPIs(){
    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        ${EPIS.map(p=>`
          <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
            <div class="text-xl font-extrabold">${escapeHtml(p.title)}</div>
            <ul class="mt-3 text-slate-300 text-sm list-disc pl-5 space-y-1">
              ${p.items.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
            </ul>
          </div>
        `).join("")}
      </div>
    `;
    viewContainer.appendChild(sectionCard("üß§ EPIs", "Resumo educacional de EPIs e boas pr√°ticas.", html));
  }

  // Patologias
  function renderPath(){
    const html = `
      <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">üß© Patologias & Interven√ß√µes</div>
            <div class="text-slate-300 mt-2">Busque uma condi√ß√£o para estudo.</div>
          </div>
          <input id="pathSearch" class="w-[300px] rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold clickable"
            placeholder="Buscar: sepse, PCR..." />
        </div>

        <div class="mt-4 grid lg:grid-cols-2 gap-4" id="pathList"></div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üß© Patologias", "Consulta r√°pida.", html));

    const list = el("pathList");
    const search = el("pathSearch");

    function renderList(){
      const q = (search.value || "").trim().toLowerCase();
      const items = PATH_DB.filter(p=>{
        if(!q) return true;
        return p.name.toLowerCase().includes(q) || (p.tags||[]).some(t=>t.toLowerCase().includes(q));
      });

      list.innerHTML = items.map(p=>`
        <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5">
          <div class="text-xl font-extrabold">${escapeHtml(p.name)}</div>
          <div class="mt-3 text-slate-300 text-sm">
            <div class="font-extrabold mb-1">Interven√ß√µes iniciais (educacional)</div>
            <ul class="list-disc pl-5 space-y-1">
              ${p.initial.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
            </ul>
          </div>
          <div class="text-slate-400 text-xs mt-3"><b>Base:</b> ${escapeHtml(p.source)}</div>
        </div>
      `).join("") || `<div class="text-slate-300">Nenhum resultado.</div>`;
    }

    search.addEventListener("input", renderList);
    renderList();
  }

  // Revis√£o
  function renderReview(){
    const logs = appState.reviewLog || [];
    const top = logs.slice(0, 40);

    const html = `
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">üìö Revis√£o</div>
              <div class="text-slate-300 mt-2">Hist√≥rico recente.</div>
            </div>
            <button id="btnClearReview" class="btn btn-danger clickable" type="button">üßπ Limpar</button>
          </div>

          <div class="mt-4 grid gap-3" id="reviewList"></div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üéØ Plano r√°pido</div>
          <div class="text-slate-300 mt-2">Foque onde errou mais.</div>
          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="studyPlan"></div>
        </div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("üìö Revis√£o", "Hist√≥rico e refor√ßo.", html));

    const list = el("reviewList");
    if(top.length === 0){
      list.innerHTML = `<div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4 text-slate-300">Sem hist√≥rico ainda.</div>`;
    } else {
      list.innerHTML = top.map(item => {
        const d = new Date(item.t);
        const stamp = isNaN(d.getTime()) ? "" : d.toLocaleString("pt-BR");
        const title = item.type === "score" ? `Score ${item.delta>0?"+":""}${item.delta}` : (item.type || "Registro");
        const body = item.why || item.topic || item.title || item.scenario || "";
        return `
          <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="flex items-center justify-between gap-2">
              <div class="font-extrabold">${escapeHtml(title)}</div>
              <div class="text-xs text-slate-400">${escapeHtml(stamp)}</div>
            </div>
            <div class="text-slate-300 text-sm mt-1">${escapeHtml(body)}</div>
          </div>
        `;
      }).join("");
    }

    const wrongQuiz = logs.filter(x => x.type === "quiz" && x.ok === false);
    const counts = {};
    wrongQuiz.forEach(w => counts[w.topic] = (counts[w.topic]||0) + 1);
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const plan = el("studyPlan");

    if(sorted.length === 0){
      plan.innerHTML = `<div class="font-extrabold">‚úÖ Sem erros recentes em quiz</div><div class="text-slate-300 mt-2">Aumente variedade de m√≥dulos.</div>`;
    } else {
      const [t, n] = sorted[0];
      plan.innerHTML = `
        <div class="font-extrabold">Tema priorit√°rio: ${escapeHtml(t)}</div>
        <div class="text-slate-300 mt-2">Erros recentes: <b>${n}</b></div>
        <div class="text-slate-300 text-sm mt-3">Fa√ßa 5 quest√µes desse tema e 1 caso cl√≠nico relacionado.</div>
      `;
    }

    el("btnClearReview").addEventListener("click", ()=>{
      appState.reviewLog = [];
      saveState();
      toast("warn","Revis√£o apagada","Hist√≥rico removido (score mantido).");
      go("review");
    });
  }

  // Sidebar controls / navigation
  el("btnToggleSidebar")?.addEventListener("click", () => el("sidebar").classList.toggle("hidden"));
  el("btnResetAll")?.addEventListener("click", resetProgress);
  el("btnQuickReset")?.addEventListener("click", resetProgress);

  el("btnSound")?.addEventListener("click", ()=>{
    appState.sound = !appState.sound;
    saveState();
    toast("info","Som", appState.sound ? "Ativado." : "Desativado.");
    beep(740, 60);
  });

  el("btnChangeName")?.addEventListener("click", ()=>{
    openModal("‚úèÔ∏è Nome do aluno","Digite como aparecer√° no painel.", `
      <div class="space-y-3">
        <input id="nameInput" class="w-full rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold clickable"
          value="${escapeHtml(appState.userName||"Aluno")}"/>
        <button id="btnSaveName" class="btn btn-ok w-full clickable" type="button">üíæ Salvar</button>
      </div>
    `);
    setTimeout(()=> el("nameInput")?.focus(), 30);
    el("btnSaveName").addEventListener("click", ()=>{
      const v = (el("nameInput").value || "").trim();
      appState.userName = v || "Aluno";
      saveState();
      closeModal();
      toast("ok","Atualizado","Nome salvo.");
    });
  });

  // Nav click
  document.querySelectorAll("[data-view]").forEach(btn => {
    btn.addEventListener("click", () => go(btn.dataset.view));
  });

  // Start
  renderScoreWidgets();
  go("dashboard");
});
</script>
</body>
</html>
