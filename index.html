<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hospital de Emerg√™ncia ‚Äî Plataforma Interativa (Treino)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .glass { background: rgba(15, 23, 42, 0.55); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.18); }
    .card { background: rgba(2, 6, 23, 0.62); border: 1px solid rgba(148, 163, 184, 0.16); }
    .btn-big { padding: 16px 18px; border-radius: 16px; font-weight: 800; letter-spacing: 0.2px; }
    .btn-ghost { background: rgba(30, 41, 59, 0.55); border: 1px solid rgba(148, 163, 184, 0.18); }
    .btn-ghost:hover { background: rgba(51, 65, 85, 0.6); }
    .btn-primary { background: linear-gradient(135deg, rgba(34, 211, 238, 0.92), rgba(99, 102, 241, 0.92)); }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-danger { background: linear-gradient(135deg, rgba(248, 113, 113, 0.95), rgba(244, 63, 94, 0.95)); }
    .btn-warning { background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(245, 158, 11, 0.95)); }
    .btn-ok { background: linear-gradient(135deg, rgba(74, 222, 128, 0.95), rgba(16, 185, 129, 0.95)); }
    .ring-soft { box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.18), 0 0 0 8px rgba(99, 102, 241, 0.10); }
    .kbd { border: 1px solid rgba(148, 163, 184, 0.25); background: rgba(15, 23, 42, 0.6); padding: 2px 8px; border-radius: 10px; font-weight: 700; }
    .mono { font-feature-settings: "tnum" 1, "lnum" 1; font-variant-numeric: tabular-nums; }

    /* Toast / Mascote */
    #toastArea { position: fixed; inset: auto 0 22px 0; display: flex; justify-content: center; pointer-events: none; z-index: 60; }
    .toast { pointer-events: none; max-width: 820px; width: calc(100% - 24px); border-radius: 18px; padding: 14px 16px; }
    .pop-center {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      z-index: 70; pointer-events: none;
    }
    .pop-card {
      transform: translateY(10px) scale(0.98);
      opacity: 0;
      transition: transform .22s ease, opacity .22s ease;
      border-radius: 26px;
      padding: 18px 22px;
      background: rgba(2, 6, 23, 0.72);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
    }
    .pop-center.show { display: flex; }
    .pop-center.show .pop-card { transform: translateY(0) scale(1); opacity: 1; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.25); border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.35); }

    /* Print */
    @media print {
      .no-print { display:none !important; }
      body { background: white !important; color: black !important; }
      .card, .glass { background: white !important; border: 1px solid #e5e7eb !important; }
    }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-slate-900"></div>
    <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full blur-3xl opacity-30 bg-cyan-400"></div>
    <div class="absolute top-40 -right-24 h-80 w-80 rounded-full blur-3xl opacity-25 bg-indigo-500"></div>
    <div class="absolute bottom-0 left-1/3 h-72 w-72 rounded-full blur-3xl opacity-20 bg-emerald-500"></div>
  </div>

  <!-- Mobile top bar -->
  <header class="no-print lg:hidden sticky top-0 z-40 glass">
    <div class="px-4 py-3 flex items-center justify-between">
      <button id="btnToggleSidebar" class="btn-big btn-ghost ring-soft flex items-center gap-3" type="button" aria-label="Abrir menu">
        <span class="text-xl">üß≠</span>
        <span class="text-base font-extrabold">Menu</span>
      </button>
      <div class="flex items-center gap-3">
        <div class="px-3 py-2 rounded-2xl card mono">
          <div class="text-xs text-slate-300">Score</div>
          <div class="text-lg font-extrabold" id="scoreHeader">0</div>
        </div>
        <button id="btnQuickReset" class="btn-big btn-danger flex items-center gap-2" type="button">
          ‚ôªÔ∏è <span>Reset</span>
        </button>
      </div>
    </div>
  </header>

  <div class="h-full flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="no-print w-[320px] shrink-0 hidden lg:flex flex-col gap-3 p-4 glass border-r border-slate-700/30">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-2xl font-extrabold tracking-tight">üè• Emerg√™ncia Simulada</div>
          <div class="text-slate-300 text-sm leading-snug mt-1">
            Plataforma de treino para <b>Enfermagem</b>, <b>Fisioterapia</b>, <b>T√©cnicos</b> e equipe.
          </div>
        </div>
        <button id="btnResetAll" class="btn-big btn-danger flex items-center gap-2" type="button" title="Apagar progresso">
          üßπ <span>Limpar</span>
        </button>
      </div>

      <!-- Profile -->
      <div class="card rounded-3xl p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm text-slate-300">Usu√°rio</div>
            <div class="text-lg font-extrabold" id="userNameLabel">Aluno</div>
          </div>
          <button id="btnChangeName" class="btn-big btn-ghost" type="button">‚úèÔ∏è Nome</button>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-4">
          <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3 mono">
            <div class="text-xs text-slate-300">Score</div>
            <div class="text-2xl font-extrabold" id="scoreSidebar">0</div>
          </div>
          <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3 mono">
            <div class="text-xs text-slate-300">N√≠vel</div>
            <div class="text-2xl font-extrabold" id="levelLabel">1</div>
          </div>
        </div>

        <div class="mt-3 text-xs text-slate-300 leading-relaxed">
          Dica: use <span class="kbd">Ctrl</span> + <span class="kbd">P</span> para imprimir revis√£o.
        </div>
      </div>

      <!-- Navigation -->
      <nav class="card rounded-3xl p-3">
        <div class="text-xs text-slate-300 px-2 pb-2">√Åreas do Hospital</div>
        <div class="grid gap-2">
          <button class="navBtn btn-big btn-primary flex items-center justify-between" data-view="dashboard" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üßë‚Äç‚öïÔ∏è</span> Painel</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="triage" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üö¶</span> Triagem (ABCDE)</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="cases" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üìã</span> Casos Cl√≠nicos</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="quiz" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üß†</span> Quizzes</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="simulators" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üõ†Ô∏è</span> Simuladores</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="jury" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">‚öñÔ∏è</span> J√∫ri Cl√≠nico</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="review" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üìö</span> Revis√£o & Feedback</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="references" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üîé</span> Literatura (Sug.)</span><span>‚Üí</span>
          </button>
          <button class="navBtn btn-big btn-ghost flex items-center justify-between" data-view="prof" type="button">
            <span class="flex items-center gap-3"><span class="text-xl">üßë‚Äçüè´</span> Modo Professor</span><span>‚Üí</span>
          </button>
        </div>
      </nav>

      <!-- Quick actions -->
      <div class="card rounded-3xl p-3">
        <div class="grid grid-cols-2 gap-2">
          <button id="btnDailyChallenge" class="btn-big btn-ok flex items-center justify-center gap-2" type="button">
            üéØ <span>Desafio</span>
          </button>
          <button id="btnExportReview" class="btn-big btn-warning flex items-center justify-center gap-2" type="button">
            üßæ <span>Resumo</span>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="btnSound" class="btn-big btn-ghost flex items-center justify-center gap-2" type="button">
            üîä <span>Som</span>
          </button>
          <button id="btnTheme" class="btn-big btn-ghost flex items-center justify-center gap-2" type="button">
            ‚ú® <span>Foco</span>
          </button>
        </div>
      </div>

      <div class="text-xs text-slate-400 leading-relaxed px-1">
        <b>Uso em sala:</b> compartilhe o link/arquivo. Sem cadastro, com progresso salvo no navegador (localStorage).
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-4 lg:p-8 overflow-y-auto">
      <!-- Desktop header -->
      <div class="no-print hidden lg:flex items-center justify-between gap-3 mb-6">
        <div class="glass rounded-3xl p-5 w-full">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-sm text-slate-300">Simula√ß√£o ‚Äî Hospital de Emerg√™ncia</div>
              <div class="text-3xl font-extrabold tracking-tight leading-tight" id="pageTitle">Painel</div>
              <div class="text-slate-300 text-sm mt-2 max-w-3xl" id="pageSubtitle">
                Selecione uma √°rea √† esquerda. Bot√µes grandes, textos claros, treino rotativo.
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="card rounded-3xl p-4 mono min-w-[150px]">
                <div class="text-xs text-slate-300">Score</div>
                <div class="text-3xl font-extrabold" id="scoreTop">0</div>
              </div>
              <div class="card rounded-3xl p-4 mono min-w-[150px]">
                <div class="text-xs text-slate-300">Acertos</div>
                <div class="text-3xl font-extrabold" id="accuracyTop">0%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content container -->
      <section id="viewContainer" class="space-y-6"></section>

      <footer class="mt-10 text-xs text-slate-400 leading-relaxed">
        <div class="card rounded-3xl p-4">
          <div class="font-extrabold text-slate-200">üß∑ Aviso</div>
          <div class="mt-2">
            Plataforma educacional para simula√ß√£o. Adeque a realidade do seu servi√ßo, protocolos locais e escopo profissional.
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Toasts -->
  <div id="toastArea" aria-live="polite" aria-atomic="true"></div>

  <!-- Mascote central -->
  <div id="popCenter" class="pop-center" aria-hidden="true">
    <div class="pop-card">
      <div class="flex items-center gap-4">
        <div class="text-6xl" id="popIcon">üò∫</div>
        <div>
          <div class="text-2xl font-extrabold" id="popTitle">Boa!</div>
          <div class="text-slate-300" id="popText">Voc√™ ganhou pontos.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative h-full flex items-center justify-center p-4">
      <div class="card rounded-3xl w-full max-w-2xl p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold" id="modalTitle">T√≠tulo</div>
            <div class="text-slate-300 mt-1" id="modalSubtitle">Texto</div>
          </div>
          <button id="modalClose" class="btn-big btn-ghost" type="button">‚úñÔ∏è Fechar</button>
        </div>
        <div class="mt-4" id="modalBody"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Emerg√™ncia Simulada (Single File)
   - Progresso localStorage
   - Banco de quest√µes rotativo por tema/dificuldade
   - Casos cl√≠nicos com conduta guiada
   - Simuladores (ABCDE, Sepse, VM, Infus√£o)
   - J√∫ri cl√≠nico
   - Revis√£o/feedback e impress√£o
========================= */

(function(){
  const LS_KEY = "emergencia_simulada_v1";
  const nowISO = () => new Date().toISOString();

  const stateDefault = {
    userName: "Aluno",
    score: 0,
    correct: 0,
    wrong: 0,
    sound: true,
    focusMode: false,
    seenQuestionIds: [],        // para rota√ß√£o
    seenCaseIds: [],
    reviewLog: [],              // hist√≥rico (acertos, erros, decis√µes)
    lastDaily: null,            // YYYY-MM-DD
    dailyDone: false,
  };

  function loadState(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(stateDefault);
      const parsed = JSON.parse(raw);
      return { ...structuredClone(stateDefault), ...parsed };
    } catch(e){
      return structuredClone(stateDefault);
    }
  }

  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(appState));
    renderScoreWidgets();
  }

  let appState = loadState();

  const el = (id) => document.getElementById(id);

  // Sound (simple beep)
  const audioCtx = { ctx: null };
  function beep(freq=660, ms=90){
    if(!appState.sound) return;
    try{
      if(!audioCtx.ctx) audioCtx.ctx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioCtx.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = freq;
      g.gain.value = 0.06;
      o.start();
      setTimeout(()=>{ o.stop(); }, ms);
    } catch(e){}
  }

  function toast(type, title, message){
    const area = el("toastArea");
    const box = document.createElement("div");
    box.className = "toast glass";
    const icon = type === "ok" ? "‚úÖ" : type === "warn" ? "‚ö†Ô∏è" : type === "bad" ? "‚ùå" : "‚ÑπÔ∏è";
    box.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="text-2xl">${icon}</div>
        <div class="flex-1">
          <div class="font-extrabold">${escapeHtml(title)}</div>
          <div class="text-slate-200/90 text-sm mt-1 leading-relaxed">${escapeHtml(message)}</div>
        </div>
      </div>
    `;
    area.appendChild(box);
    setTimeout(()=>{ box.style.opacity = "0"; box.style.transform = "translateY(6px)"; box.style.transition = "all .18s ease"; }, 2600);
    setTimeout(()=>{ box.remove(); }, 3000);
  }

  function popCenter(icon, title, text, ms=5000){
    const pc = el("popCenter");
    el("popIcon").textContent = icon;
    el("popTitle").textContent = title;
    el("popText").textContent = text;
    pc.classList.add("show");
    pc.setAttribute("aria-hidden", "false");
    setTimeout(()=>{
      pc.classList.remove("show");
      pc.setAttribute("aria-hidden", "true");
    }, ms);
  }

  function escapeHtml(str){
    return (""+str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Data: question bank ----------
  // Estrutura: {id, topic, level (1-3), q, options[], answerIndex, rationale, extra?}
  const QUESTION_BANK = [
    // TRIAGEM/ABCDE
    {id:"q_abcd_01", topic:"ABCDE", level:1, q:"No ABCDE, qual √© a prioridade inicial (A)?", options:["Avaliar perfus√£o", "Garantir via a√©rea e prote√ß√£o cervical", "Avaliar Glasgow", "Checar temperatura"], answerIndex:1,
      rationale:"A = Airway. Primeiro garantir via a√©rea e prote√ß√£o da coluna cervical quando aplic√°vel."},
    {id:"q_abcd_02", topic:"ABCDE", level:1, q:"Sinal de obstru√ß√£o iminente de via a√©rea em adulto:", options:["Poli√∫ria", "Estridor", "Edema em MMII", "Sopro card√≠aco"], answerIndex:1,
      rationale:"Estridor sugere obstru√ß√£o alta e risco de fal√™ncia ventilat√≥ria."},
    {id:"q_abcd_03", topic:"ABCDE", level:2, q:"No 'B' do ABCDE, a melhor a√ß√£o imediata diante de SpO‚ÇÇ 84% em ar ambiente e esfor√ßo respirat√≥rio:", options:["Solicitar TC de t√≥rax", "Iniciar oxig√™nio e avaliar ventila√ß√£o/ausculta", "Prescrever antibi√≥tico e aguardar", "Dar analg√©sico e observar"], answerIndex:1,
      rationale:"No B, suporte ventilat√≥rio/oxig√™nio e avalia√ß√£o r√°pida (FR, uso de musculatura acess√≥ria, ausculta) √© prioridade."},

    // SEPSE
    {id:"q_sepse_01", topic:"SEPSE", level:1, q:"Em suspeita de sepse, uma a√ß√£o de primeira hora √©:", options:["Suspender fluidos", "Coletar lactato e iniciar antibi√≥tico conforme protocolo", "Aguardar culturas por 24h", "Evitar acesso venoso"], answerIndex:1,
      rationale:"Conforme bundles de sepse: lactato, culturas (sem atrasar ATB), antibi√≥tico precoce e ressuscita√ß√£o conforme necessidade."},
    {id:"q_sepse_02", topic:"SEPSE", level:2, q:"Ap√≥s 30 mL/kg de cristal√≥ide, o paciente mant√©m PAM baixa. Pr√≥ximo passo mais prov√°vel:", options:["Vasopressor (ex.: noradrenalina) para manter PAM adequada", "Diur√©tico de al√ßa", "Suspender monitoriza√ß√£o", "Alta imediata"], answerIndex:0,
      rationale:"Choque s√©ptico: ap√≥s volume inicial, considerar vasopressor para alvo de PAM (conforme protocolo institucional)."},
    {id:"q_sepse_03", topic:"SEPSE", level:3, q:"Qual achado indica hipoperfus√£o tecidual e pior progn√≥stico em sepse?", options:["Lactato elevado", "S√≥dio normal", "Temperatura 36,5¬∞C", "Hemat√≥crito est√°vel"], answerIndex:0,
      rationale:"Lactato elevado √© marcador de hipoperfus√£o e associado a maior gravidade."},

    // CARDIO/ACLS
    {id:"q_acls_01", topic:"ACLS", level:1, q:"Em PCR presenciada, a prioridade √©:", options:["Epinefrina antes de compress√µes", "RCP de alta qualidade e desfibrila√ß√£o precoce quando indicada", "Intubar antes de iniciar compress√µes", "Fazer exame neurol√≥gico"], answerIndex:1,
      rationale:"RCP de alta qualidade + desfibrila√ß√£o precoce em ritmos choc√°veis s√£o essenciais."},
    {id:"q_acls_02", topic:"ACLS", level:2, q:"Ritmo FV/TV sem pulso: conduta inicial:", options:["Desfibrilar e retomar RCP imediatamente", "Atropina", "Cardiovers√£o sincronizada", "Aguardar monitor"], answerIndex:0,
      rationale:"Ritmo choc√°vel: desfibrilar e reiniciar compress√µes sem checar pulso prolongadamente."},
    {id:"q_acls_03", topic:"ACLS", level:3, q:"Ap√≥s ROSC, objetivo priorit√°rio nas primeiras horas inclui:", options:["Manter hipotens√£o para reduzir sangramento", "Otimizar oxigena√ß√£o/ventila√ß√£o e perfus√£o, investigar causa", "Suspender monitoriza√ß√£o", "Evitar glicemia capilar"], answerIndex:1,
      rationale:"Cuidados p√≥s-PCR: ventila√ß√£o/oxigena√ß√£o, hemodin√¢mica, temperatura conforme protocolo e investiga√ß√£o da causa."},

    // VENTILA√á√ÉO MEC√ÇNICA (b√°sico)
    {id:"q_vm_01", topic:"VM", level:1, q:"Em ventila√ß√£o protetora, um alvo cl√°ssico √©:", options:["VC alto (10-12 mL/kg)", "VC baixo (‚âà6 mL/kg de peso predito) quando indicado", "PEEP zero sempre", "FR sempre < 10"], answerIndex:1,
      rationale:"Princ√≠pios de ventila√ß√£o protetora incluem volumes correntes menores (peso predito) quando apropriado, evitando volutrauma."},
    {id:"q_vm_02", topic:"VM", level:2, q:"Sinal de auto-PEEP prov√°vel no ventilador:", options:["Expira√ß√£o incompleta e tempo expirat√≥rio curto", "Press√£o de pico baixa", "ETCO‚ÇÇ sempre normal", "Alarme de O‚ÇÇ alto"], answerIndex:0,
      rationale:"Auto-PEEP ocorre com expira√ß√£o incompleta, comum em obstru√ß√£o e FR alta/TE curto."},
    {id:"q_vm_03", topic:"VM", level:3, q:"Conduta inicial para paciente com broncoespasmo grave em VM e auto-PEEP:", options:["Aumentar FR e reduzir tempo expirat√≥rio", "Reduzir FR, aumentar tempo expirat√≥rio e tratar broncoespasmo", "Zerar seda√ß√£o", "Suspender broncodilatadores"], answerIndex:1,
      rationale:"Para reduzir air trapping: reduzir FR, aumentar TE, ajustar fluxo, e tratar broncoespasmo conforme protocolo."},

    // TRAUMA/ATLS (no√ß√µes)
    {id:"q_trauma_01", topic:"TRAUMA", level:1, q:"No trauma, a prote√ß√£o da coluna cervical √© mais cr√≠tica:", options:["Em qualquer dor abdominal", "Quando h√° mecanismo sugestivo/altera√ß√£o neurol√≥gica at√© prova em contr√°rio", "Apenas em idosos", "Somente se houver fratura exposta"], answerIndex:1,
      rationale:"Princ√≠pio do atendimento inicial: proteger coluna cervical quando risco √© plaus√≠vel."},
    {id:"q_trauma_02", topic:"TRAUMA", level:2, q:"Sinais que sugerem choque hemorr√°gico no trauma:", options:["Pele quente e corada", "Taquicardia, hipotens√£o, extremidades frias", "Bradicardia com hipertens√£o", "Sonol√™ncia com glicemia alta"], answerIndex:1,
      rationale:"Choque hemorr√°gico costuma cursar com taquicardia, hipotens√£o e perfus√£o perif√©rica ruim."},

    // FISIOTERAPIA RESP / OXIGENOTERAPIA
    {id:"q_resp_01", topic:"RESP", level:1, q:"Objetivo imediato da oxigenoterapia na emerg√™ncia:", options:["Normalizar sempre para SpO‚ÇÇ 100%", "Melhorar oxigena√ß√£o com alvo seguro, evitando hiper√≥xia quando relevante", "Substituir ventila√ß√£o", "Aumentar sempre o trabalho respirat√≥rio"], answerIndex:1,
      rationale:"Alvo depende do quadro (ex.: risco de reten√ß√£o de CO‚ÇÇ). O objetivo √© oxigena√ß√£o adequada, com seguran√ßa."},
    {id:"q_resp_02", topic:"RESP", level:2, q:"Crit√©rio cl√≠nico que sugere fal√™ncia ventilat√≥ria iminente:", options:["FR 14 e fala frases completas", "Uso intenso de musculatura acess√≥ria + rebaixamento progressivo", "Tosse produtiva leve", "Temperatura 37,1¬∞C"], answerIndex:1,
      rationale:"Esfor√ßo acentuado e rebaixamento indicam fadiga/risco de fal√™ncia ventilat√≥ria."},
  ];

  // ---------- Data: case bank ----------
  // Estrutura: {id, title, tags[], intro, vitals{}, findings[], tasks[], bestActions[], pitfalls[], debrief}
  const CASE_BANK = [
    {
      id:"c_sepse_01",
      title:"üöë Sepse prov√°vel ‚Äî Pneumonia comunit√°ria",
      tags:["SEPSE","RESP","ENF","FISIO","TEC"],
      intro:"Paciente 67a, febre h√° 2 dias, tosse produtiva, prostra√ß√£o. Chega confuso, pele fria.",
      vitals:{ "FR":"30 irpm", "SpO‚ÇÇ":"88% AA", "FC":"118 bpm", "PA":"86/54", "T":"38,9¬∞C", "Glic":"142 mg/dL" },
      findings:[
        "Ausculta: crepita√ß√µes em base direita",
        "Tempo de enchimento capilar prolongado",
        "Diurese reduzida referida pela fam√≠lia"
      ],
      tasks:[
        "Aplicar ABCDE e priorizar interven√ß√µes",
        "Iniciar bundle de sepse (a√ß√µes iniciais)",
        "Definir quando considerar vasopressor"
      ],
      bestActions:[
        "Oxig√™nio suplementar + monitoriza√ß√£o cont√≠nua (B)",
        "Dois acessos venosos calibrosos + coleta de lactato/culturas sem atrasar antibi√≥tico",
        "Cristal√≥ide inicial conforme protocolo institucional; reavaliar perfus√£o e PAM",
        "Se hipotens√£o persistente ap√≥s volume, considerar vasopressor e UTI"
      ],
      pitfalls:[
        "Aguardar exames para iniciar antibi√≥tico",
        "Subestimar rebaixamento/hipoperfus√£o",
        "N√£o reavaliar resposta ao volume"
      ],
      debrief:"Sepse √© tempo-dependente. Foque em oxigena√ß√£o, perfus√£o, antibi√≥tico precoce e reavalia√ß√£o seriada."
    },
    {
      id:"c_acls_01",
      title:"‚ö° PCR ‚Äî FV/TV sem pulso (simula√ß√£o)",
      tags:["ACLS","ENF","TEC"],
      intro:"Paciente 58a colapsa na sala. Sem resposta, sem respira√ß√£o normal.",
      vitals:{ "Ritmo":"FV", "Pulso":"Ausente", "SpO‚ÇÇ":"--", "PA":"--", "T":"--", "Glic":"--" },
      findings:[
        "Monitor mostra fibrila√ß√£o ventricular",
        "Equipe dispon√≠vel"
      ],
      tasks:[
        "Iniciar RCP de alta qualidade",
        "Realizar desfibrila√ß√£o e ciclos",
        "Registrar eventos no time"
      ],
      bestActions:[
        "Compress√µes imediatas (100‚Äì120/min) + minimizar pausas",
        "Desfibrilar assim que poss√≠vel; retomar compress√µes imediatamente",
        "Organizar fun√ß√µes: compressor, via a√©rea, drogas, desfibrilador, registro",
        "Reavaliar ritmo/pulso conforme ciclos e protocolo"
      ],
      pitfalls:[
        "Pausas longas para checar pulso",
        "Focar em via a√©rea antes de compress√µes",
        "Desorganiza√ß√£o de equipe"
      ],
      debrief:"Qualidade da RCP e desfibrila√ß√£o precoce mudam desfechos. Use comunica√ß√£o fechada e pap√©is claros."
    },
    {
      id:"c_trauma_01",
      title:"ü©∏ Trauma ‚Äî suspeita de choque hemorr√°gico",
      tags:["TRAUMA","ENF","TEC"],
      intro:"Motociclista 24a, colis√£o. Dor abdominal e palidez. Mecanismo de alta energia.",
      vitals:{ "FR":"26", "SpO‚ÇÇ":"95% O‚ÇÇ", "FC":"132", "PA":"90/60", "T":"36,0", "Glic":"118" },
      findings:[
        "Extremidades frias, sudorese",
        "Abdome doloroso difusamente",
        "Poss√≠vel instabilidade p√©lvica (dor intensa)"
      ],
      tasks:[
        "ABCDE no trauma com prote√ß√£o cervical",
        "Suspeitar/identificar choque",
        "A√ß√µes iniciais e acionamento de time"
      ],
      bestActions:[
        "Prote√ß√£o cervical + via a√©rea conforme necessidade",
        "Acesso venoso e reposi√ß√£o conforme protocolo do trauma; aquecer paciente",
        "Reconhecer choque e acionar time/fast/centro cir√∫rgico conforme fluxo",
        "Reavalia√ß√£o cont√≠nua e controle de hemorragia"
      ],
      pitfalls:[
        "Atrasar reconhecimento de choque",
        "N√£o aquecer (hipotermia agrava coagulopatia)",
        "Falta de comunica√ß√£o com equipe"
      ],
      debrief:"No trauma, choque hemorr√°gico √© diagn√≥stico e tratamento r√°pidos. Pense no trip√© letal e no controle de sangramento."
    },
    {
      id:"c_vm_01",
      title:"ü´Å Dispneia grave ‚Äî broncoespasmo e auto-PEEP (VM)",
      tags:["VM","RESP","FISIO","ENF"],
      intro:"Paciente 62a com DPOC, intubado por fadiga. No ventilador, picos altos e expira√ß√£o curta.",
      vitals:{ "FR":"Ventilada", "SpO‚ÇÇ":"92% O‚ÇÇ", "FC":"110", "PA":"102/68", "T":"36,8", "EtCO‚ÇÇ":"elevado" },
      findings:[
        "Ausculta: sibilos difusos",
        "Alarme: press√£o de pico alta",
        "Curva sugere expira√ß√£o incompleta"
      ],
      tasks:[
        "Reconhecer auto-PEEP",
        "Ajustes iniciais seguros (conceito)",
        "Cuidados fisioterap√™uticos/broncoespasmo"
      ],
      bestActions:[
        "Reduzir FR/permitir maior tempo expirat√≥rio",
        "Ajustar fluxo/tempo inspirat√≥rio conforme objetivo de TE",
        "Tratar broncoespasmo (broncodilatadores, seda√ß√£o adequada conforme prescri√ß√£o)",
        "Monitorar hemodin√¢mica (auto-PEEP pode reduzir retorno venoso)"
      ],
      pitfalls:[
        "Aumentar FR (piora air trapping)",
        "Ignorar hemodin√¢mica",
        "Aspira√ß√£o inadequada sem necessidade/sem t√©cnica"
      ],
      debrief:"Em obstru√ß√£o, o tempo expirat√≥rio √© ouro. Ajuste ventilador para evitar hiperinsufla√ß√£o din√¢mica."
    }
  ];

  // ---------- Utilities ----------
  function calcLevel(score){
    // simples: 1 a 20 -> 1; 21 a 60 -> 2; 61+ -> 3
    if(score >= 61) return 3;
    if(score >= 21) return 2;
    return 1;
  }

  function accuracy(){
    const total = appState.correct + appState.wrong;
    if(total === 0) return 0;
    return Math.round((appState.correct / total) * 100);
  }

  function addReview(entry){
    appState.reviewLog.unshift({ t: nowISO(), ...entry });
    if(appState.reviewLog.length > 200) appState.reviewLog.pop();
    saveState();
  }

  function addScore(delta, why){
    appState.score = Math.max(0, appState.score + delta);
    addReview({ type:"score", delta, why });
    saveState();
  }

  function resetProgress(){
    const keepName = appState.userName;
    appState = structuredClone(stateDefault);
    appState.userName = keepName || "Aluno";
    saveState();
    toast("warn","Progresso apagado","Score e hist√≥rico foram reiniciados neste navegador.");
    go("dashboard");
  }

  function ensureDaily(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const key = `${y}-${m}-${day}`;
    if(appState.lastDaily !== key){
      appState.lastDaily = key;
      appState.dailyDone = false;
      saveState();
    }
  }

  function renderScoreWidgets(){
    const s = appState.score;
    const lvl = calcLevel(s);
    const acc = accuracy();

    const ids = ["scoreHeader","scoreSidebar","scoreTop"];
    ids.forEach(id => { if(el(id)) el(id).textContent = s; });
    if(el("levelLabel")) el("levelLabel").textContent = String(lvl);
    if(el("accuracyTop")) el("accuracyTop").textContent = `${acc}%`;
    if(el("userNameLabel")) el("userNameLabel").textContent = appState.userName || "Aluno";
  }

  // ---------- Routing ----------
  const viewContainer = el("viewContainer");
  const pageTitle = el("pageTitle");
  const pageSubtitle = el("pageSubtitle");

  const VIEW_META = {
    dashboard: { title:"Painel", subtitle:"Vis√£o geral do plant√£o simulado. Acesse m√≥dulos, acompanhe desempenho e fa√ßa desafios." },
    triage: { title:"Triagem (ABCDE)", subtitle:"Treino guiado de prioridades. Tome decis√µes e receba feedback e score." },
    cases: { title:"Casos Cl√≠nicos", subtitle:"Casos rotativos por tema. Decida condutas iniciais e registre racioc√≠nio." },
    quiz: { title:"Quizzes", subtitle:"Banco de quest√µes com rota√ß√£o por tema e n√≠vel. Feedback com justificativa." },
    simulators: { title:"Simuladores", subtitle:"Ferramentas r√°pidas: Sepse, VM b√°sica, Infus√£o e calculadoras simples." },
    jury: { title:"J√∫ri Cl√≠nico", subtitle:"Discuss√£o estruturada. Pro/contra, riscos, seguran√ßa e justificativas." },
    review: { title:"Revis√£o & Feedback", subtitle:"Seu hist√≥rico: erros, acertos, decis√µes e sugest√µes de estudo." },
    references: { title:"Literatura (Sugest√µes)", subtitle:"Fontes cl√°ssicas e guias usados como base conceitual para simula√ß√£o." },
    prof: { title:"Modo Professor", subtitle:"Configura√ß√µes, impress√£o, banco, din√¢mica em sala e reset controlado." },
  };

  function setHeader(view){
    const m = VIEW_META[view] || VIEW_META.dashboard;
    if(pageTitle) pageTitle.textContent = m.title;
    if(pageSubtitle) pageSubtitle.textContent = m.subtitle;
    document.title = `Emerg√™ncia Simulada ‚Äî ${m.title}`;
  }

  function go(view){
    setHeader(view);
    renderView(view);
    // highlight nav
    document.querySelectorAll(".navBtn").forEach(b=>{
      if(b.dataset.view === view){
        b.classList.remove("btn-ghost");
        b.classList.add("btn-primary");
      } else {
        b.classList.remove("btn-primary");
        b.classList.add("btn-ghost");
      }
    });
    // close mobile sidebar if open
    if(window.innerWidth < 1024){
      el("sidebar").classList.add("hidden");
    }
  }

  // ---------- View rendering ----------
  function renderView(view){
    viewContainer.innerHTML = "";
    if(view === "dashboard") return renderDashboard();
    if(view === "triage") return renderTriage();
    if(view === "cases") return renderCases();
    if(view === "quiz") return renderQuiz();
    if(view === "simulators") return renderSimulators();
    if(view === "jury") return renderJury();
    if(view === "review") return renderReview();
    if(view === "references") return renderReferences();
    if(view === "prof") return renderProf();
    return renderDashboard();
  }

  function sectionCard(title, subtitle, innerHtml){
    const wrap = document.createElement("div");
    wrap.className = "card rounded-3xl p-5";
    wrap.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-2xl font-extrabold">${title}</div>
          ${subtitle ? `<div class="text-slate-300 mt-1">${subtitle}</div>` : ""}
        </div>
      </div>
      <div class="mt-4">${innerHtml}</div>
    `;
    return wrap;
  }

  // ---------- Dashboard ----------
  function renderDashboard(){
    ensureDaily();
    const lvl = calcLevel(appState.score);
    const acc = accuracy();

    const kpis = `
      <div class="grid md:grid-cols-3 gap-4">
        <div class="rounded-3xl p-5 bg-slate-900/60 border border-slate-700/30">
          <div class="text-sm text-slate-300">N√≠vel atual</div>
          <div class="text-4xl font-extrabold mono mt-1">${lvl}</div>
          <div class="text-slate-300 text-sm mt-2">Aumenta com score e consist√™ncia.</div>
        </div>
        <div class="rounded-3xl p-5 bg-slate-900/60 border border-slate-700/30">
          <div class="text-sm text-slate-300">Taxa de acerto</div>
          <div class="text-4xl font-extrabold mono mt-1">${acc}%</div>
          <div class="text-slate-300 text-sm mt-2">Baseado em quizzes respondidos.</div>
        </div>
        <div class="rounded-3xl p-5 bg-slate-900/60 border border-slate-700/30">
          <div class="text-sm text-slate-300">Plant√£o</div>
          <div class="text-4xl font-extrabold mono mt-1">üïí</div>
          <div class="text-slate-300 text-sm mt-2">Treine com ciclos curtos (5‚Äì12 min).</div>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-4 mt-4">
        <div class="rounded-3xl p-5 bg-slate-900/60 border border-slate-700/30">
          <div class="text-xl font-extrabold">üöÄ Acesso r√°pido</div>
          <div class="grid sm:grid-cols-2 gap-3 mt-4">
            <button class="btn-big btn-primary w-full" data-go="triage">üö¶ Triagem ABCDE</button>
            <button class="btn-big btn-primary w-full" data-go="cases">üìã Caso cl√≠nico</button>
            <button class="btn-big btn-ghost w-full" data-go="quiz">üß† Quiz rotativo</button>
            <button class="btn-big btn-ghost w-full" data-go="simulators">üõ†Ô∏è Simuladores</button>
          </div>
          <div class="text-slate-300 text-sm mt-4">
            <b>Dica de sala:</b> projete o painel e pe√ßa que cada aluno fa√ßa 1 rodada (caso + quiz).
          </div>
        </div>

        <div class="rounded-3xl p-5 bg-slate-900/60 border border-slate-700/30">
          <div class="text-xl font-extrabold">üéØ Desafio do dia</div>
          <div class="text-slate-300 mt-2">
            Um mini-desafio di√°rio (1 caso r√°pido + 3 quest√µes). Recompensa em score.
          </div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnStartDaily" class="btn-big btn-ok">Iniciar desafio</button>
            <button id="btnDailyStatus" class="btn-big btn-ghost" disabled>
              ${appState.dailyDone ? "‚úÖ Conclu√≠do hoje" : "‚è≥ Ainda n√£o feito"}
            </button>
          </div>
          <div class="mt-4 text-xs text-slate-300 leading-relaxed">
            Se o aluno errar, ganha dicas e vai para revis√£o automaticamente.
          </div>
        </div>
      </div>
    `;

    const card = sectionCard("üßë‚Äç‚öïÔ∏è Painel do Plant√£o", "Vis√£o geral e rotas r√°pidas.", kpis);
    viewContainer.appendChild(card);

    // events
    card.querySelectorAll("[data-go]").forEach(btn=>{
      btn.addEventListener("click", ()=> go(btn.getAttribute("data-go")));
    });

    const btnDaily = card.querySelector("#btnStartDaily");
    btnDaily.addEventListener("click", ()=>{
      runDailyChallenge();
    });
  }

  function pickRotatingQuestion({topic=null, level=null}){
    // filtra
    let pool = QUESTION_BANK.slice();
    if(topic) pool = pool.filter(q=>q.topic === topic);
    if(level) pool = pool.filter(q=>q.level === level);

    // remove j√° vistas
    const seen = new Set(appState.seenQuestionIds || []);
    let unseen = pool.filter(q=>!seen.has(q.id));
    if(unseen.length === 0){
      // reset parcial apenas para o filtro atual (mant√©m hist√≥rico global, mas permite repetir)
      unseen = pool;
    }
    // random
    const q = unseen[Math.floor(Math.random() * unseen.length)];
    // marca como vista
    if(q && !seen.has(q.id)){
      appState.seenQuestionIds.push(q.id);
      if(appState.seenQuestionIds.length > 500) appState.seenQuestionIds.shift();
      saveState();
    }
    return q;
  }

  function pickRotatingCase(){
    const seen = new Set(appState.seenCaseIds || []);
    let unseen = CASE_BANK.filter(c=>!seen.has(c.id));
    if(unseen.length === 0) unseen = CASE_BANK;
    const c = unseen[Math.floor(Math.random() * unseen.length)];
    if(c && !seen.has(c.id)){
      appState.seenCaseIds.push(c.id);
      if(appState.seenCaseIds.length > 200) appState.seenCaseIds.shift();
      saveState();
    }
    return c;
  }

  function runDailyChallenge(){
    ensureDaily();
    if(appState.dailyDone){
      toast("info","Desafio do dia","Voc√™ j√° concluiu o desafio hoje. Amanh√£ ter√° outro.");
      return;
    }

    const c = pickRotatingCase();
    const lvl = calcLevel(appState.score);
    const qs = [
      pickRotatingQuestion({level: Math.max(1, Math.min(3, lvl))}),
      pickRotatingQuestion({level: Math.max(1, Math.min(3, lvl))}),
      pickRotatingQuestion({level: Math.max(1, Math.min(3, lvl))}),
    ].filter(Boolean);

    openModal(
      "üéØ Desafio do Dia",
      "1 caso r√°pido + 3 quest√µes. Conclua para ganhar b√¥nus.",
      `
        <div class="space-y-4">
          <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4">
            <div class="text-lg font-extrabold">Caso: ${escapeHtml(c.title)}</div>
            <div class="text-slate-300 mt-2">${escapeHtml(c.intro)}</div>
            <div class="mt-3 grid sm:grid-cols-3 gap-3 text-sm">
              ${Object.entries(c.vitals).map(([k,v])=>`
                <div class="rounded-2xl bg-slate-950/40 border border-slate-700/30 p-3">
                  <div class="text-xs text-slate-400">${escapeHtml(k)}</div>
                  <div class="font-extrabold mono">${escapeHtml(v)}</div>
                </div>
              `).join("")}
            </div>
            <div class="mt-3 text-slate-300 text-sm">
              <b>Meta:</b> Liste mentalmente 3 prioridades imediatas (ABCDE + seguran√ßa).
            </div>
          </div>

          <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4">
            <div class="text-lg font-extrabold">Quest√µes (3)</div>
            <div class="text-slate-300 text-sm mt-1">Responda agora (uma a uma).</div>
            <div class="mt-3 grid gap-3" id="dailyQs"></div>
          </div>

          <div class="flex flex-wrap gap-3">
            <button id="btnFinishDaily" class="btn-big btn-ok" type="button">‚úÖ Finalizar desafio</button>
            <button id="btnCancelDaily" class="btn-big btn-ghost" type="button">Voltar</button>
          </div>
        </div>
      `
    );

    // render Qs
    const qWrap = document.getElementById("dailyQs");
    const answers = new Map();

    qs.forEach((q, idx)=>{
      const box = document.createElement("div");
      box.className = "rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4";
      box.innerHTML = `
        <div class="text-sm text-slate-400">Q${idx+1} ‚Ä¢ ${escapeHtml(q.topic)} ‚Ä¢ N√≠vel ${q.level}</div>
        <div class="text-xl font-extrabold mt-1">${escapeHtml(q.q)}</div>
        <div class="grid gap-2 mt-3">
          ${q.options.map((opt,i)=>`
            <button class="optDaily btn-big btn-ghost w-full text-left" data-qid="${q.id}" data-idx="${i}" type="button">
              ${String.fromCharCode(65+i)}. ${escapeHtml(opt)}
            </button>
          `).join("")}
        </div>
        <div class="mt-3 hidden text-sm rounded-2xl p-3 border border-slate-700/30 bg-slate-900/60" id="dailyFb_${q.id}"></div>
      `;
      qWrap.appendChild(box);

      box.querySelectorAll(".optDaily").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const qid = btn.dataset.qid;
          const choice = Number(btn.dataset.idx);
          answers.set(qid, choice);

          // UI select
          box.querySelectorAll(".optDaily").forEach(b=>b.classList.remove("ring-soft"));
          btn.classList.add("ring-soft");

          // feedback immediate
          const fb = box.querySelector(`#dailyFb_${qid}`);
          const correct = choice === q.answerIndex;
          fb.classList.remove("hidden");
          fb.innerHTML = correct
            ? `<div class="font-extrabold">‚úÖ Correto</div><div class="text-slate-300 mt-1">${escapeHtml(q.rationale)}</div>`
            : `<div class="font-extrabold">‚ùå Incorreto</div><div class="text-slate-300 mt-1">${escapeHtml(q.rationale)}</div>`;
        });
      });
    });

    document.getElementById("btnCancelDaily").addEventListener("click", closeModal);

    document.getElementById("btnFinishDaily").addEventListener("click", ()=>{
      // scoring: +5 por quest√£o correta, +10 b√¥nus se >=2 corretas
      let correctCount = 0;
      qs.forEach(q=>{
        const a = answers.get(q.id);
        if(a === q.answerIndex) correctCount++;
        // log
        if(a !== undefined){
          addReview({
            type:"daily_q",
            qid:q.id,
            topic:q.topic,
            level:q.level,
            correct: a === q.answerIndex,
            chosen: a,
            answer: q.answerIndex
          });
        }
      });

      const base = correctCount * 5;
      const bonus = correctCount >= 2 ? 10 : 0;
      addScore(base + bonus, `Desafio do dia: ${correctCount}/3 corretas (+${base} +${bonus})`);

      appState.dailyDone = true;
      saveState();

      if(correctCount >= 2){
        beep(880, 110);
        popCenter("üò∫","Desafio conclu√≠do!", `Voc√™ acertou ${correctCount}/3 e ganhou +${base+bonus} pontos.`, 5000);
      } else {
        beep(260, 140);
        toast("warn","Quase l√°", `Voc√™ acertou ${correctCount}/3. Refa√ßa quizzes e revis√£o para subir.`);
      }

      closeModal();
      go("review");
    });
  }

  // ---------- Triagem ----------
  function renderTriage(){
    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üö¶ Treino ABCDE</div>
          <div class="text-slate-300 mt-2">
            Voc√™ ver√° um cen√°rio breve. Escolha a <b>prioridade imediata</b>. O sistema d√° feedback e score.
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="text-sm text-slate-400">Cen√°rio</div>
            <div class="text-xl font-extrabold mt-1" id="triScenarioTitle"></div>
            <div class="text-slate-300 mt-2" id="triScenarioText"></div>
            <div class="grid sm:grid-cols-3 gap-3 mt-3 text-sm" id="triVitals"></div>
          </div>

          <div class="mt-4 grid gap-3" id="triOptions"></div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnTriNext" class="btn-big btn-primary">üîÑ Novo cen√°rio</button>
            <button id="btnTriHint" class="btn-big btn-ghost">üí° Dica</button>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üßæ Mini-checklist (para o aluno)</div>
          <div class="text-slate-300 mt-2">Use como guia mental durante a simula√ß√£o:</div>

          <div class="mt-4 grid gap-3">
            ${triChecklistCard("A ‚Äî Via a√©rea", ["Fala? Estridor? Obstru√ß√£o? Prote√ß√£o cervical?", "Aspira√ß√£o, c√¢nula, posicionamento, via a√©rea avan√ßada conforme equipe/protocolo."])}
            ${triChecklistCard("B ‚Äî Respira√ß√£o", ["FR, padr√£o, uso de musculatura, ausculta, SpO‚ÇÇ.", "Oxig√™nio, ventila√ß√£o assistida se necess√°rio, considerar broncoespasmo/pneumo/edema."])}
            ${triChecklistCard("C ‚Äî Circula√ß√£o", ["PA, FC, perfus√£o, sangramento.", "Acesso venoso, volume conforme protocolo, controle de hemorragia, vasopressor se choque refrat√°rio."])}
            ${triChecklistCard("D ‚Äî Neurol√≥gico", ["GCS, pupilas, glicemia.", "Hipoglicemia? Convuls√£o? AVC? Rebaixamento exige reavaliar A/B."])}
            ${triChecklistCard("E ‚Äî Exposi√ß√£o", ["Temperatura, les√µes ocultas, dor, hipotermia.", "Aquecer, examinar completamente, prevenir perda de calor."])}
          </div>

          <div class="mt-4 text-xs text-slate-300 leading-relaxed">
            Pontua√ß√£o premia <b>prioriza√ß√£o</b> e <b>seguran√ßa</b>. Evite ‚Äúpular‚Äù etapas sem justificativa.
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üö¶ Triagem", "Cen√°rios r√°pidos e decis√µes de prioridade.", html));

    // Scenarios
    const scenarios = [
      {
        title:"Adulto com ru√≠do respirat√≥rio agudo",
        text:"Chega com ansiedade, fala entrecortada e ru√≠do inspirat√≥rio. Hist√≥ria de alergia recente.",
        vitals:{ "FR":"34", "SpO‚ÇÇ":"90% AA", "FC":"124", "PA":"118/72", "Glic":"--", "T":"36,7" },
        options:[
          {label:"A ‚Äî Garantir via a√©rea e preparar suporte avan√ßado", correct:true, why:"Estridor e fala comprometida sugerem via a√©rea amea√ßada (A)."},
          {label:"C ‚Äî Iniciar soro e aguardar m√©dico", correct:false, why:"Circula√ß√£o pode ser necess√°ria, mas A √© prioridade aqui."},
          {label:"D ‚Äî Checar Glasgow e pupilas", correct:false, why:"Neurol√≥gico vem ap√≥s estabilizar A/B/C quando h√° risco imediato."},
          {label:"E ‚Äî Expor paciente e procurar les√µes", correct:false, why:"Exposi√ß√£o n√£o precede via a√©rea em amea√ßa evidente."},
        ],
        hint:"Se h√° risco de obstru√ß√£o, priorize A. Ru√≠do inspirat√≥rio + fala prejudicada = alerta."
      },
      {
        title:"Idoso confuso e hipotenso com febre",
        text:"Chega let√°rgico, pele fria, febre e tosse produtiva. Perfus√£o perif√©rica ruim.",
        vitals:{ "FR":"30", "SpO‚ÇÇ":"88% AA", "FC":"118", "PA":"86/54", "Glic":"142", "T":"38,9" },
        options:[
          {label:"B ‚Äî Oxig√™nio e avalia√ß√£o ventilat√≥ria imediata", correct:true, why:"Hipoxemia e FR alta exigem suporte imediato no B; em paralelo iniciar sepse."},
          {label:"E ‚Äî Aguardar exame de imagem para confirmar pneumonia", correct:false, why:"Tempo-dependente. Interven√ß√µes de suporte e bundle n√£o devem esperar imagem."},
          {label:"D ‚Äî Fazer teste neurol√≥gico completo antes de agir", correct:false, why:"Rebaixamento pode ser hipoperfus√£o/hipoxemia. Trate causas imediatas."},
          {label:"A ‚Äî Intubar imediatamente sem avalia√ß√£o", correct:false, why:"Via a√©rea pode ser necess√°ria, mas sem sinais claros, priorize suporte B e reavalia√ß√£o."},
        ],
        hint:"FR alta + SpO‚ÇÇ baixa = B. Choque/sepse: agir em paralelo com C e bundle."
      },
      {
        title:"Trauma com sinais de choque",
        text:"Motociclista ap√≥s colis√£o. Palidez intensa, extremidades frias, dor abdominal.",
        vitals:{ "FR":"26", "SpO‚ÇÇ":"95% O‚ÇÇ", "FC":"132", "PA":"90/60", "Glic":"118", "T":"36,0" },
        options:[
          {label:"C ‚Äî Suspeitar choque e iniciar medidas de circula√ß√£o + controle de hemorragia", correct:true, why:"Taquicardia, hipotens√£o e perfus√£o ruim sugerem choque (C)."},
          {label:"D ‚Äî Checar apenas glicemia e aguardar", correct:false, why:"Circula√ß√£o √© prioridade em choque."},
          {label:"E ‚Äî Exposi√ß√£o completa antes de qualquer a√ß√£o", correct:false, why:"Expor √© importante, mas n√£o antes de C quando h√° choque."},
          {label:"B ‚Äî Nebuliza√ß√£o e fisioterapia respirat√≥ria", correct:false, why:"Sem prioridade respirat√≥ria imediata; choque √© mais cr√≠tico."},
        ],
        hint:"Em choque, a prioridade √© C. No trauma, pense em hemorragia at√© prova em contr√°rio."
      }
    ];

    let idx = Math.floor(Math.random()*scenarios.length);

    function renderScenario(){
      const s = scenarios[idx];
      document.getElementById("triScenarioTitle").textContent = s.title;
      document.getElementById("triScenarioText").textContent = s.text;

      const vitalsWrap = document.getElementById("triVitals");
      vitalsWrap.innerHTML = Object.entries(s.vitals).map(([k,v])=>`
        <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3">
          <div class="text-xs text-slate-400">${escapeHtml(k)}</div>
          <div class="font-extrabold mono">${escapeHtml(v)}</div>
        </div>
      `).join("");

      const optWrap = document.getElementById("triOptions");
      optWrap.innerHTML = "";
      s.options.forEach((o)=>{
        const b = document.createElement("button");
        b.className = "btn-big btn-ghost w-full text-left";
        b.type = "button";
        b.textContent = o.label;
        b.addEventListener("click", ()=>{
          if(o.correct){
            appState.correct += 1;
            addScore(6, "Triagem: decis√£o correta");
            beep(880, 90);
            popCenter("üò∫","Prioridade correta!", "+6 pontos (triagem).", 5000);
            addReview({type:"triage", ok:true, scenario:s.title, choice:o.label});
          } else {
            appState.wrong += 1;
            addScore(0, "Triagem: decis√£o incorreta (sem b√¥nus)");
            beep(220, 120);
            toast("bad","Decis√£o a ajustar", o.why);
            addReview({type:"triage", ok:false, scenario:s.title, choice:o.label, why:o.why});
          }
          saveState();
        });
        optWrap.appendChild(b);
      });
    }

    document.getElementById("btnTriNext").addEventListener("click", ()=>{
      idx = (idx + 1 + Math.floor(Math.random()*2)) % scenarios.length;
      renderScenario();
      toast("info","Novo cen√°rio","Escolha a prioridade imediata.");
    });

    document.getElementById("btnTriHint").addEventListener("click", ()=>{
      const s = scenarios[idx];
      toast("info","Dica ABCDE", s.hint);
    });

    renderScenario();
  }

  function triChecklistCard(title, bullets){
    return `
      <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
        <div class="font-extrabold">${escapeHtml(title)}</div>
        <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
          ${bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}
        </ul>
      </div>
    `;
  }

  // ---------- Cases ----------
  function renderCases(){
    const c = pickRotatingCase();
    const tags = c.tags.map(t=>`<span class="px-3 py-1 rounded-full text-xs font-extrabold bg-slate-900/60 border border-slate-700/30">${escapeHtml(t)}</span>`).join("");

    const html = `
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">${escapeHtml(c.title)}</div>
              <div class="text-slate-300 mt-2">${escapeHtml(c.intro)}</div>
            </div>
            <div class="flex flex-wrap gap-2">${tags}</div>
          </div>

          <div class="grid sm:grid-cols-3 gap-3 mt-4 text-sm">
            ${Object.entries(c.vitals).map(([k,v])=>`
              <div class="rounded-2xl bg-slate-950/40 border border-slate-700/30 p-3">
                <div class="text-xs text-slate-400">${escapeHtml(k)}</div>
                <div class="font-extrabold mono">${escapeHtml(v)}</div>
              </div>
            `).join("")}
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold text-lg">üîç Achados</div>
              <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
                ${c.findings.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>

            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold text-lg">‚úÖ Tarefas do aluno</div>
              <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
                ${c.tasks.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold text-lg">üß† Sua decis√£o (registro r√°pido)</div>
            <div class="text-slate-300 text-sm mt-1">Escreva as 3 prioridades iniciais e por qu√™ (para revis√£o).</div>
            <textarea id="caseNotes" class="mt-3 w-full min-h-[120px] rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-400/30" placeholder="Ex.: 1) B: O2 + avalia√ß√£o ventilat√≥ria... 2) C: acesso venoso e ressuscita√ß√£o... 3) antibi√≥tico/bundle..."></textarea>
            <div class="flex flex-wrap gap-3 mt-3">
              <button id="btnCaseSubmit" class="btn-big btn-primary">üìå Registrar decis√£o</button>
              <button id="btnCaseReveal" class="btn-big btn-ghost">üîé Ver debrief (gabarito)</button>
              <button id="btnCaseNext" class="btn-big btn-ok">üîÑ Novo caso</button>
            </div>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üéõÔ∏è Feedback do Sistema</div>
          <div class="text-slate-300 mt-2">Ap√≥s registrar sua decis√£o, compare com o debrief e ajuste racioc√≠nio.</div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold">‚úÖ Boas a√ß√µes (esperadas)</div>
            <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
              ${c.bestActions.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
            </ul>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold">üß® Armadilhas comuns</div>
            <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
              ${c.pitfalls.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
            </ul>
          </div>

          <div class="mt-4 text-xs text-slate-300 leading-relaxed">
            <b>Score:</b> registrar decis√£o d√° pontos (consist√™ncia). Compare com debrief para aprendizagem.
          </div>
        </div>
      </div>
    `;

    viewContainer.appendChild(sectionCard("üìã Casos Cl√≠nicos", "Rotativos, prontos para din√¢mica em sala.", html));

    const ta = document.getElementById("caseNotes");
    const btnSubmit = document.getElementById("btnCaseSubmit");
    const btnReveal = document.getElementById("btnCaseReveal");
    const btnNext = document.getElementById("btnCaseNext");

    btnSubmit.addEventListener("click", ()=>{
      const notes = (ta.value || "").trim();
      if(notes.length < 10){
        toast("warn","Registre melhor","Escreva ao menos algumas linhas (3 prioridades) para validar o treino.");
        return;
      }
      addScore(8, "Caso cl√≠nico: decis√£o registrada");
      appState.correct += 1; // conta como participa√ß√£o correta (n√£o √© quiz)
      addReview({type:"case", caseId:c.id, title:c.title, notes});
      beep(740, 90);
      popCenter("ü©∫","Decis√£o registrada!", "+8 pontos (caso).", 5000);
      saveState();
    });

    btnReveal.addEventListener("click", ()=>{
      openModal(
        "üîé Debrief do Caso",
        "Compare com sua decis√£o e ajuste o racioc√≠nio.",
        `
          <div class="space-y-4">
            <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4">
              <div class="text-xl font-extrabold">${escapeHtml(c.title)}</div>
              <div class="text-slate-300 mt-2">${escapeHtml(c.debrief)}</div>
            </div>
            <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4">
              <div class="font-extrabold">‚úÖ A√ß√µes esperadas</div>
              <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
                ${c.bestActions.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>
            <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4">
              <div class="font-extrabold">üß® Armadilhas</div>
              <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
                ${c.pitfalls.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>
          </div>
        `
      );
    });

    btnNext.addEventListener("click", ()=>{
      go("cases"); // re-render picks next rotating
    });
  }

  // ---------- Quiz ----------
  function renderQuiz(){
    const lvl = calcLevel(appState.score);
    const html = `
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">üß† Quiz Rotativo</div>
              <div class="text-slate-300 mt-2">
                Quest√µes por tema e n√≠vel. O sistema evita repetir at√© esgotar o banco.
              </div>
            </div>
            <div class="flex flex-wrap gap-2">
              <select id="quizTopic" class="rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold">
                <option value="">üåê Todos os temas</option>
                ${[...new Set(QUESTION_BANK.map(q=>q.topic))].map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("")}
              </select>
              <select id="quizLevel" class="rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold">
                <option value="">üéöÔ∏è Todos n√≠veis</option>
                <option value="1">N√≠vel 1 (base)</option>
                <option value="2">N√≠vel 2 (intermedi√°rio)</option>
                <option value="3">N√≠vel 3 (avan√ßado)</option>
              </select>
            </div>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-5" id="quizBox">
            <div class="text-sm text-slate-400" id="quizMeta">‚Äî</div>
            <div class="text-2xl font-extrabold mt-2" id="quizQuestion">‚Äî</div>
            <div class="grid gap-3 mt-4" id="quizOptions"></div>

            <div class="mt-4 hidden rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4" id="quizFeedback"></div>

            <div class="mt-4 flex flex-wrap gap-3">
              <button id="btnQuizNext" class="btn-big btn-primary">‚û°Ô∏è Pr√≥xima</button>
              <button id="btnQuizExplain" class="btn-big btn-ghost">üßæ Explicar</button>
              <button id="btnQuizToReview" class="btn-big btn-warning">üìö Mandar para revis√£o</button>
            </div>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üìà Regras de Score</div>
          <div class="mt-3 grid gap-3 text-slate-300 text-sm">
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">‚úÖ Acerto</div>
              <div class="mt-1">+5 pontos (n√≠vel 1), +7 (n√≠vel 2), +9 (n√≠vel 3).</div>
            </div>
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">‚ùå Erro</div>
              <div class="mt-1">Sem b√¥nus. A quest√£o vai para revis√£o com justificativa.</div>
            </div>
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">üîÅ Rota√ß√£o</div>
              <div class="mt-1">Evita repeti√ß√£o at√© esgotar o banco do filtro atual.</div>
            </div>
          </div>

          <div class="mt-4 text-xs text-slate-300 leading-relaxed">
            Seu n√≠vel atual sugerido: <b>${lvl}</b>. Voc√™ pode treinar acima para acelerar.
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üß† Quizzes", "Quest√µes rotativas com justificativas.", html));

    const selTopic = document.getElementById("quizTopic");
    const selLevel = document.getElementById("quizLevel");
    const qMeta = document.getElementById("quizMeta");
    const qText = document.getElementById("quizQuestion");
    const qOpts = document.getElementById("quizOptions");
    const fb = document.getElementById("quizFeedback");
    let currentQ = null;
    let answered = false;

    function scoreForLevel(level){
      if(level === 3) return 9;
      if(level === 2) return 7;
      return 5;
    }

    function loadQ(){
      const topic = selTopic.value || null;
      const level = selLevel.value ? Number(selLevel.value) : null;
      currentQ = pickRotatingQuestion({topic, level});
      answered = false;
      fb.classList.add("hidden");
      fb.innerHTML = "";
      qOpts.innerHTML = "";

      if(!currentQ){
        qMeta.textContent = "Sem quest√µes para este filtro.";
        qText.textContent = "Ajuste o tema/n√≠vel.";
        return;
      }

      qMeta.textContent = `Tema: ${currentQ.topic} ‚Ä¢ N√≠vel ${currentQ.level}`;
      qText.textContent = currentQ.q;

      currentQ.options.forEach((opt, idx)=>{
        const b = document.createElement("button");
        b.className = "btn-big btn-ghost w-full text-left";
        b.type = "button";
        b.innerHTML = `<span class="font-extrabold">${String.fromCharCode(65+idx)}.</span> ${escapeHtml(opt)}`;
        b.addEventListener("click", ()=>{
          if(answered) return;
          answered = true;

          const ok = idx === currentQ.answerIndex;
          if(ok){
            const pts = scoreForLevel(currentQ.level);
            appState.correct += 1;
            addScore(pts, `Quiz correto (${currentQ.topic}, N${currentQ.level})`);
            beep(900, 90);
            popCenter("üò∫","Acertou!", `+${pts} pontos.`, 5000);
            fb.classList.remove("hidden");
            fb.innerHTML = `
              <div class="font-extrabold text-lg">‚úÖ Correto</div>
              <div class="text-slate-300 mt-2">${escapeHtml(currentQ.rationale)}</div>
            `;
            addReview({type:"quiz", qid: currentQ.id, ok:true, topic: currentQ.topic, level: currentQ.level});
          } else {
            appState.wrong += 1;
            beep(220, 120);
            fb.classList.remove("hidden");
            fb.innerHTML = `
              <div class="font-extrabold text-lg">‚ùå Incorreto</div>
              <div class="text-slate-300 mt-2">${escapeHtml(currentQ.rationale)}</div>
              <div class="text-slate-300 mt-2"><b>Resposta correta:</b> ${escapeHtml(currentQ.options[currentQ.answerIndex])}</div>
            `;
            toast("warn","Vai para revis√£o","Revise o racional e tente novamente em outra rodada.");
            addReview({
              type:"quiz",
              qid: currentQ.id,
              ok:false,
              topic: currentQ.topic,
              level: currentQ.level,
              chosen: idx,
              answer: currentQ.answerIndex
            });
          }
          saveState();
        });
        qOpts.appendChild(b);
      });
    }

    document.getElementById("btnQuizNext").addEventListener("click", loadQ);
    document.getElementById("btnQuizExplain").addEventListener("click", ()=>{
      if(!currentQ) return;
      openModal("üßæ Justificativa", `Tema: ${currentQ.topic} ‚Ä¢ N√≠vel ${currentQ.level}`, `
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4">
          <div class="text-xl font-extrabold">${escapeHtml(currentQ.q)}</div>
          <div class="text-slate-300 mt-3">${escapeHtml(currentQ.rationale)}</div>
          <div class="mt-3 text-slate-300 text-sm">
            <b>Aplica√ß√£o pr√°tica:</b> transforme isso em uma regra simples de plant√£o (prioridade/alerta/conduta).
          </div>
        </div>
      `);
    });
    document.getElementById("btnQuizToReview").addEventListener("click", ()=>{
      go("review");
    });

    selTopic.addEventListener("change", loadQ);
    selLevel.addEventListener("change", loadQ);

    loadQ();
  }

  // ---------- Simulators ----------
  function renderSimulators(){
    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üß™ Sepse ‚Äî Checklist de 1¬™ hora (simula√ß√£o)</div>
          <div class="text-slate-300 mt-2">Marque a√ß√µes realizadas. O sistema sugere melhorias e gera resumo para revis√£o.</div>

          <div class="mt-4 grid gap-2" id="sepseChecklist">
            ${checkItem("sep_lact","ü©∏ Coletar lactato")}
            ${checkItem("sep_cult","üß´ Coletar culturas (sem atrasar antibi√≥tico)")}
            ${checkItem("sep_atb","üíä Iniciar antibi√≥tico conforme protocolo")}
            ${checkItem("sep_fluid","üíß Iniciar ressuscita√ß√£o vol√™mica se indicado")}
            ${checkItem("sep_press","üß≠ Monitorar PAM/perfus√£o e reavaliar")}
            ${checkItem("sep_uti","üè• Considerar UTI/vasopressor se choque persistente")}
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnSepseScore" class="btn-big btn-ok">‚úÖ Avaliar checklist</button>
            <button id="btnSepseClear" class="btn-big btn-ghost">‚ôªÔ∏è Limpar</button>
          </div>

          <div class="mt-4 hidden rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="sepseOut"></div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">ü´Å VM B√°sica ‚Äî Ajustes de tempo (conceito)</div>
          <div class="text-slate-300 mt-2">Simule ajustes para reduzir auto-PEEP (educacional).</div>

          <div class="mt-4 grid sm:grid-cols-2 gap-3">
            ${numInput("vm_fr","FR (irpm)", 18, 6, 40)}
            ${numInput("vm_ti","Ti (s)", 1.0, 0.5, 2.5, 0.1)}
            ${numInput("vm_ie","I:E (E relativo)", 2.0, 1.0, 5.0, 0.5)}
            ${numInput("vm_peep","PEEP (cmH‚ÇÇO)", 5, 0, 18)}
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnVmCalc" class="btn-big btn-primary">üßÆ Analisar risco de auto-PEEP</button>
            <button id="btnVmSuggest" class="btn-big btn-ghost">üí° Sugerir ajuste</button>
          </div>

          <div class="mt-4 hidden rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="vmOut"></div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üíâ Infus√£o ‚Äî Calculadora simples</div>
          <div class="text-slate-300 mt-2">Ajuda para treino de dose/volume (simula√ß√£o). Use protocolo local na pr√°tica real.</div>

          <div class="mt-4 grid sm:grid-cols-2 gap-3">
            ${numInput("inf_dose","Dose prescrita (mg)", 50, 0, 100000, 0.1)}
            ${numInput("inf_conc","Concentra√ß√£o (mg/mL)", 1, 0.0001, 100000, 0.1)}
            ${numInput("inf_time","Tempo (min)", 30, 1, 600, 1)}
            ${numInput("inf_vol","Volume dispon√≠vel (mL)", 100, 1, 2000, 1)}
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnInfCalc" class="btn-big btn-primary">üßÆ Calcular (mL e mL/h)</button>
            <button id="btnInfLog" class="btn-big btn-ok">üìå Enviar para revis√£o</button>
          </div>

          <div class="mt-4 hidden rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="infOut"></div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üßØ Seguran√ßa ‚Äî ‚ÄúN√£o esquecer‚Äù</div>
          <div class="text-slate-300 mt-2">Use como lembrete para simula√ß√µes e OSCE.</div>

          <div class="mt-4 grid gap-3">
            ${miniNote("ü™™ Identifica√ß√£o","Nome/data/risco alergia, pulseira, checagem ativa.")}
            ${miniNote("üßº Infec√ß√£o","Higieniza√ß√£o de m√£os, EPI, isolamento quando indicado.")}
            ${miniNote("üßæ Comunica√ß√£o","SBAR, comunica√ß√£o fechada, registro de tempo.")}
            ${miniNote("üßä Hipotermia","Aquecer no trauma/choque; evitar queda de temperatura.")}
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="btnSafetyPts" class="btn-big btn-ok">‚úÖ Marcar ‚Äúfeito‚Äù</button>
            <button id="btnSafetyPrint" class="btn-big btn-ghost">üñ®Ô∏è Imprimir</button>
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üõ†Ô∏è Simuladores", "Ferramentas r√°pidas para treino em sala.", html));

    // Sepse checklist
    const sepOut = document.getElementById("sepseOut");
    document.getElementById("btnSepseScore").addEventListener("click", ()=>{
      const ids = ["sep_lact","sep_cult","sep_atb","sep_fluid","sep_press","sep_uti"];
      const checked = ids.filter(id => document.getElementById(id).checked);
      const pct = Math.round((checked.length / ids.length) * 100);

      sepOut.classList.remove("hidden");
      sepOut.innerHTML = `
        <div class="text-lg font-extrabold">Resultado: ${pct}%</div>
        <div class="text-slate-300 mt-2">A√ß√µes marcadas: ${checked.length}/${ids.length}</div>
        <div class="text-slate-300 mt-2">
          ${pct >= 84 ? "‚úÖ Bom. Agora simule reavalia√ß√£o seriada e documenta√ß√£o." :
            pct >= 50 ? "‚ö†Ô∏è Parcial. Identifique o que faltou e por que." :
            "‚ùå Insuficiente. Refa√ßa pensando em tempo-depend√™ncia e perfus√£o."}
        </div>
      `;

      addReview({type:"sim_sepse", pct, checked});
      if(pct >= 84){
        addScore(10, "Simulador: sepse checklist >=84%");
        popCenter("üò∫","Checklist forte!", "+10 pontos.", 5000);
        beep(880, 90);
      } else if(pct >= 50){
        addScore(4, "Simulador: sepse checklist parcial");
        toast("warn","Ajuste de bundle","Complete os itens faltantes e repita.");
        beep(440, 90);
      } else {
        toast("bad","Rever sepse","Refa√ßa o checklist com foco em 1¬™ hora.");
        beep(220, 120);
      }
      saveState();
    });

    document.getElementById("btnSepseClear").addEventListener("click", ()=>{
      ["sep_lact","sep_cult","sep_atb","sep_fluid","sep_press","sep_uti"].forEach(id => document.getElementById(id).checked = false);
      sepOut.classList.add("hidden");
      sepOut.innerHTML = "";
    });

    // VM
    const vmOut = document.getElementById("vmOut");
    function vmRead(){
      return {
        fr: Number(document.getElementById("vm_fr").value),
        ti: Number(document.getElementById("vm_ti").value),
        eRel: Number(document.getElementById("vm_ie").value), // E relativo
        peep: Number(document.getElementById("vm_peep").value),
      };
    }

    function vmAnalyze(v){
      // Modelo educacional: ciclo total = 60/fr; Te = ciclo - Ti;
      // Se I:E est√° desfavor√°vel (E baixo) e Te muito curto, risco aumenta.
      const cycle = 60 / Math.max(1, v.fr);
      const te = Math.max(0, cycle - v.ti);
      const riskTe = te < 1.5 ? "alto" : te < 2.2 ? "moderado" : "baixo";
      const risk = (riskTe === "alto") ? "ALTO" : (riskTe === "moderado" ? "MODERADO" : "BAIXO");
      return { cycle: cycle.toFixed(2), te: te.toFixed(2), risk, note: riskTe };
    }

    document.getElementById("btnVmCalc").addEventListener("click", ()=>{
      const v = vmRead();
      const a = vmAnalyze(v);
      vmOut.classList.remove("hidden");
      vmOut.innerHTML = `
        <div class="text-lg font-extrabold">An√°lise (educacional)</div>
        <div class="grid sm:grid-cols-3 gap-3 mt-3 text-sm">
          ${miniKpi("Ciclo total (s)", a.cycle)}
          ${miniKpi("Tempo expirat√≥rio (s)", a.te)}
          ${miniKpi("Risco auto-PEEP", a.risk)}
        </div>
        <div class="text-slate-300 mt-3">
          Se h√° obstru√ß√£o/broncoespasmo, <b>Te curto</b> aumenta air trapping. Ajuste FR e Ti para permitir expira√ß√£o.
        </div>
      `;
      addReview({type:"sim_vm", v, a});
      saveState();
    });

    document.getElementById("btnVmSuggest").addEventListener("click", ()=>{
      const v = vmRead();
      // sugest√£o simples
      let sug = [];
      if(v.fr > 14) sug.push("Reduzir FR para aumentar Te (se clinicamente permitido).");
      if(v.ti > 1.0) sug.push("Reduzir Ti (mantendo conforto/ventila√ß√£o adequada).");
      sug.push("Tratar broncoespasmo e reavaliar curvas/press√µes.");
      sug.push("Monitorar hemodin√¢mica: auto-PEEP pode reduzir retorno venoso.");
      toast("info","Sugest√£o VM", sug.join(" "));
    });

    // Infus√£o
    const infOut = document.getElementById("infOut");
    function readInf(){
      return {
        dose: Number(document.getElementById("inf_dose").value),
        conc: Number(document.getElementById("inf_conc").value),
        time: Number(document.getElementById("inf_time").value),
        vol: Number(document.getElementById("inf_vol").value),
      };
    }
    document.getElementById("btnInfCalc").addEventListener("click", ()=>{
      const v = readInf();
      if(v.conc <= 0 || v.time <= 0){
        toast("bad","Valores inv√°lidos","Concentra√ß√£o e tempo devem ser maiores que zero.");
        return;
      }
      const ml = v.dose / v.conc;
      const mlph = (ml / v.time) * 60;
      const okVol = ml <= v.vol;
      infOut.classList.remove("hidden");
      infOut.innerHTML = `
        <div class="text-lg font-extrabold">Resultado (treino)</div>
        <div class="grid sm:grid-cols-3 gap-3 mt-3 text-sm">
          ${miniKpi("Volume (mL)", ml.toFixed(2))}
          ${miniKpi("Taxa (mL/h)", mlph.toFixed(2))}
          ${miniKpi("Volume dispon√≠vel", okVol ? "OK" : "INSUFICIENTE")}
        </div>
        <div class="text-slate-300 mt-3 text-sm">
          Use protocolo local e dupla checagem na pr√°tica real.
        </div>
      `;
      addReview({type:"sim_infusion", v, ml, mlph, okVol});
      saveState();
    });
    document.getElementById("btnInfLog").addEventListener("click", ()=>{
      const v = readInf();
      addScore(3, "Simulador: infus√£o registrada");
      toast("ok","Enviado para revis√£o","Abra Revis√£o & Feedback para ver o registro.");
      saveState();
    });

    // Safety
    document.getElementById("btnSafetyPts").addEventListener("click", ()=>{
      addScore(2, "Seguran√ßa: checklist marcado");
      beep(740, 70);
      toast("ok","Seguran√ßa","Boa pr√°tica: comunica√ß√£o, EPI e checagens reduzem eventos adversos.");
      saveState();
    });
    document.getElementById("btnSafetyPrint").addEventListener("click", ()=> window.print());
  }

  function checkItem(id, label){
    return `
      <label class="flex items-center gap-3 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4 cursor-pointer">
        <input id="${escapeHtml(id)}" type="checkbox" class="h-6 w-6 accent-cyan-400">
        <span class="font-extrabold">${label}</span>
      </label>
    `;
  }

  function numInput(id, label, val, min, max, step=1){
    return `
      <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
        <div class="text-sm text-slate-400">${escapeHtml(label)}</div>
        <input id="${escapeHtml(id)}" type="number" value="${val}" min="${min}" max="${max}" step="${step}"
          class="mt-2 w-full rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold mono focus:outline-none focus:ring-2 focus:ring-cyan-400/30">
      </div>
    `;
  }

  function miniKpi(label, value){
    return `
      <div class="rounded-2xl bg-slate-900/60 border border-slate-700/30 p-3">
        <div class="text-xs text-slate-400">${escapeHtml(label)}</div>
        <div class="font-extrabold mono text-lg">${escapeHtml(value)}</div>
      </div>
    `;
  }

  function miniNote(title, text){
    return `
      <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
        <div class="font-extrabold">${escapeHtml(title)}</div>
        <div class="text-slate-300 text-sm mt-1">${escapeHtml(text)}</div>
      </div>
    `;
  }

  // ---------- Jury ----------
  function renderJury(){
    const prompts = [
      {
        title:"‚öñÔ∏è J√∫ri: Sepse ‚Äî antibi√≥tico antes ou depois?",
        scenario:"Paciente com suspeita de sepse. Culturas s√£o desej√°veis, mas h√° risco de atraso. Como equilibrar tempo vs. diagn√≥stico?",
        axes:["Seguran√ßa do paciente", "Tempo-depend√™ncia", "Conformidade com bundle/protocolo", "Recursos do servi√ßo"]
      },
      {
        title:"‚öñÔ∏è J√∫ri: Intuba√ß√£o precoce vs. suporte n√£o invasivo",
        scenario:"Dispneia grave com esfor√ßo. Quando insistir em suporte e quando intubar por fadiga iminente?",
        axes:["Sinais de fal√™ncia ventilat√≥ria", "Risco de aspira√ß√£o", "Equipe dispon√≠vel", "Monitoriza√ß√£o e reavalia√ß√£o"]
      },
      {
        title:"‚öñÔ∏è J√∫ri: Choque no trauma ‚Äî volume liberal vs. estrat√©gia controlada",
        scenario:"Suspeita de hemorragia. Qual estrat√©gia inicial de reposi√ß√£o e controle de sangramento faz sentido na sua realidade?",
        axes:["Perfus√£o vs. sangramento", "Hipotermia/coagulopatia", "Tempo para cirurgia", "Protocolos locais"]
      }
    ];
    const p = prompts[Math.floor(Math.random()*prompts.length)];

    const html = `
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">${escapeHtml(p.title)}</div>
          <div class="text-slate-300 mt-2">${escapeHtml(p.scenario)}</div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold">üß© Eixos de argumenta√ß√£o</div>
            <ul class="mt-2 text-slate-300 text-sm list-disc pl-5 space-y-1">
              ${p.axes.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}
            </ul>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold text-lg">‚úÖ Argumento A (a favor)</div>
              <textarea id="juryA" class="mt-2 w-full min-h-[160px] rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-400/30" placeholder="Estruture: premissa ‚Üí evid√™ncia ‚Üí risco ‚Üí mitiga√ß√£o."></textarea>
            </div>
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold text-lg">‚ùå Argumento B (contra)</div>
              <textarea id="juryB" class="mt-2 w-full min-h-[160px] rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-400/30" placeholder="Estruture: risco ‚Üí cen√°rio cr√≠tico ‚Üí custo ‚Üí alternativa."></textarea>
            </div>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold text-lg">üßæ Decis√£o final (consenso)</div>
            <textarea id="juryFinal" class="mt-2 w-full min-h-[120px] rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-400/30" placeholder="Defina: quando fazer X, quando fazer Y, e quais gatilhos de reavalia√ß√£o."></textarea>
            <div class="mt-3 flex flex-wrap gap-3">
              <button id="btnJurySave" class="btn-big btn-ok">üìå Salvar no hist√≥rico</button>
              <button id="btnJuryNew" class="btn-big btn-primary">üîÑ Novo j√∫ri</button>
            </div>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üé§ Como usar em sala</div>
          <div class="text-slate-300 mt-2">Sugest√£o de din√¢mica (10‚Äì15 min):</div>

          <div class="mt-4 grid gap-3 text-slate-300 text-sm">
            ${miniNote("1) Pap√©is","1 grupo defende, 1 grupo refuta, 1 grupo faz auditoria (seguran√ßa/tempo).")}
            ${miniNote("2) Crit√©rios","Pontue por: clareza, risco/benef√≠cio, evid√™ncia, aplicabilidade no servi√ßo.")}
            ${miniNote("3) Fechamento","Criar protocolo local simplificado (gatilhos de reavalia√ß√£o).")}
          </div>

          <div class="mt-4 text-xs text-slate-300 leading-relaxed">
            O objetivo n√£o √© ‚Äúvencer‚Äù, √© reduzir risco e melhorar decis√£o sob press√£o.
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("‚öñÔ∏è J√∫ri Cl√≠nico", "Discuss√£o estruturada e registr√°vel.", html));

    document.getElementById("btnJurySave").addEventListener("click", ()=>{
      const A = (document.getElementById("juryA").value || "").trim();
      const B = (document.getElementById("juryB").value || "").trim();
      const F = (document.getElementById("juryFinal").value || "").trim();
      if(A.length < 10 || B.length < 10 || F.length < 10){
        toast("warn","Faltou conte√∫do","Preencha A, B e decis√£o final com estrutura m√≠nima.");
        return;
      }
      addReview({type:"jury", title:p.title, A, B, F});
      addScore(10, "J√∫ri cl√≠nico: registro completo");
      beep(840, 90);
      popCenter("üò∫","J√∫ri registrado!", "+10 pontos.", 5000);
      saveState();
    });

    document.getElementById("btnJuryNew").addEventListener("click", ()=> go("jury"));
  }

  // ---------- Review ----------
  function renderReview(){
    const logs = appState.reviewLog || [];
    const top = logs.slice(0, 30);

    const html = `
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-2xl font-extrabold">üìö Revis√£o</div>
              <div class="text-slate-300 mt-2">Hist√≥rico recente (at√© 30 itens). Imprim√≠vel.</div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="btnPrintReview" class="btn-big btn-ghost">üñ®Ô∏è Imprimir</button>
              <button id="btnClearReview" class="btn-big btn-danger">üßπ Limpar revis√£o</button>
            </div>
          </div>

          <div class="mt-4 grid gap-3" id="reviewList"></div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üß≠ Plano de estudo (autom√°tico)</div>
          <div class="text-slate-300 mt-2">Baseado nos seus erros/temas.</div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4" id="studyPlan"></div>

          <div class="mt-4 text-xs text-slate-300 leading-relaxed">
            Sugest√£o: refa√ßa 5 quizzes do tema mais fraco e 1 caso correlato.
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üìö Revis√£o & Feedback", "Registros, impress√£o e plano de estudo.", html));

    const list = document.getElementById("reviewList");
    if(top.length === 0){
      list.innerHTML = `<div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4 text-slate-300">Sem hist√≥rico ainda. Fa√ßa um quiz/caso para gerar revis√£o.</div>`;
    } else {
      list.innerHTML = top.map(item => reviewCard(item)).join("");
    }

    // Study plan: count wrong topics
    const wrongs = logs.filter(x=>x.type==="quiz" && x.ok===false);
    const counts = {};
    wrongs.forEach(w=>{
      counts[w.topic] = (counts[w.topic]||0)+1;
    });
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const plan = document.getElementById("studyPlan");
    if(sorted.length === 0){
      plan.innerHTML = `
        <div class="font-extrabold">‚úÖ Sem erros recentes em quiz</div>
        <div class="text-slate-300 mt-2">Suba o n√≠vel para acelerar (treine N2/N3).</div>
      `;
    } else {
      const [t, n] = sorted[0];
      plan.innerHTML = `
        <div class="font-extrabold">Tema priorit√°rio: ${escapeHtml(t)}</div>
        <div class="text-slate-300 mt-2">Erros recentes: <b>${n}</b></div>
        <div class="mt-3 grid gap-2 text-slate-300 text-sm">
          <div>1) Fa√ßa <b>5 quizzes</b> de ${escapeHtml(t)} (n√≠vel igual/maior).</div>
          <div>2) Fa√ßa <b>1 caso cl√≠nico</b> relacionado e registre 3 prioridades.</div>
          <div>3) Escreva 3 ‚Äúgatilhos‚Äù de gravidade (ex.: sinais de fal√™ncia/choque).</div>
        </div>
      `;
    }

    document.getElementById("btnPrintReview").addEventListener("click", ()=> window.print());
    document.getElementById("btnClearReview").addEventListener("click", ()=>{
      appState.reviewLog = [];
      saveState();
      toast("warn","Revis√£o apagada","Hist√≥rico removido (score mantido).");
      go("review");
    });
  }

  function reviewCard(item){
    const d = new Date(item.t);
    const stamp = isNaN(d.getTime()) ? "" : d.toLocaleString("pt-BR");
    let title = "Registro";
    let body = "";
    let icon = "‚ÑπÔ∏è";

    if(item.type === "quiz"){
      icon = item.ok ? "‚úÖ" : "‚ùå";
      title = `Quiz ‚Ä¢ ${item.topic} ‚Ä¢ N√≠vel ${item.level || "-"}`;
      body = item.ok ? "Acerto registrado." : `Erro registrado. Resposta correta: ${String.fromCharCode(65 + (item.answer ?? 0))}.`;
    } else if(item.type === "case"){
      icon = "üìã";
      title = `Caso cl√≠nico ‚Ä¢ ${item.title}`;
      body = `Notas: ${escapeHtml((item.notes||"").slice(0,160))}${(item.notes||"").length>160?"‚Ä¶":""}`;
    } else if(item.type === "triage"){
      icon = item.ok ? "üö¶" : "‚ö†Ô∏è";
      title = `Triagem ‚Ä¢ ${item.scenario}`;
      body = item.ok ? `Decis√£o: ${escapeHtml(item.choice)}` : `Decis√£o: ${escapeHtml(item.choice)} ‚Ä¢ Ajuste: ${escapeHtml(item.why||"")}`;
    } else if(item.type === "jury"){
      icon = "‚öñÔ∏è";
      title = `J√∫ri ‚Ä¢ ${item.title}`;
      body = `Decis√£o final: ${escapeHtml((item.F||"").slice(0,160))}${(item.F||"").length>160?"‚Ä¶":""}`;
    } else if(item.type === "sim_sepse"){
      icon = "üß™";
      title = `Simulador Sepse ‚Ä¢ ${item.pct}%`;
      body = `Itens: ${(item.checked||[]).length} marcados.`;
    } else if(item.type === "sim_vm"){
      icon = "ü´Å";
      title = `Simulador VM ‚Ä¢ risco ${escapeHtml(item.a?.risk||"-")}`;
      body = `FR ${item.v?.fr}, Ti ${item.v?.ti}s, Te ${item.a?.te}s.`;
    } else if(item.type === "sim_infusion"){
      icon = "üíâ";
      title = "Simulador Infus√£o";
      body = `Dose ${item.v?.dose} mg; conc ${item.v?.conc} mg/mL; vol ${Number(item.ml||0).toFixed(2)} mL.`;
    } else if(item.type === "score"){
      icon = item.delta > 0 ? "‚ú®" : "‚Äî";
      title = `Score ${item.delta>0?"+":""}${item.delta}`;
      body = escapeHtml(item.why || "");
    } else if(item.type === "daily_q"){
      icon = item.correct ? "üéØ" : "üéØ";
      title = `Desafio di√°rio ‚Ä¢ ${item.topic}`;
      body = item.correct ? "Acerto." : "Erro.";
    }

    return `
      <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
        <div class="flex items-start gap-3">
          <div class="text-2xl">${icon}</div>
          <div class="flex-1">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="font-extrabold">${escapeHtml(title)}</div>
              <div class="text-xs text-slate-400">${escapeHtml(stamp)}</div>
            </div>
            <div class="text-slate-300 text-sm mt-1">${body}</div>
          </div>
        </div>
      </div>
    `;
  }

  // ---------- References ----------
  function renderReferences(){
    const html = `
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üîé Refer√™ncias sugeridas (conceituais)</div>
          <div class="text-slate-300 mt-2">
            Bases comuns usadas para simula√ß√£o e ensino. Use vers√µes mais recentes e protocolos do seu servi√ßo.
          </div>

          <div class="mt-4 grid gap-3 text-slate-300 text-sm">
            ${miniNote("ACLS/BLS (ressuscita√ß√£o)","Diretrizes de ressuscita√ß√£o cardiopulmonar e cuidados p√≥s-parada (sociedades internacionais).")}
            ${miniNote("ATLS (trauma)","Avalia√ß√£o prim√°ria (ABCDE no trauma), controle de hemorragia e prioridades de suporte.")}
            ${miniNote("Bundles de Sepse","A√ß√µes iniciais tempo-dependentes: lactato, culturas, antibi√≥tico precoce, fluidos/vasopressor conforme indica√ß√£o.")}
            ${miniNote("Ventila√ß√£o protetora (conceitos)","Princ√≠pios de minimizar volutrauma/barotrauma e monitorar auto-PEEP em obstru√ß√£o.")}
            ${miniNote("Seguran√ßa do Paciente","Comunica√ß√£o SBAR, checagem dupla, identifica√ß√£o, preven√ß√£o de eventos adversos.")}
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üìå Como citar no seu material</div>
          <div class="text-slate-300 mt-2">Sugest√£o pr√°tica para slides/apostila:</div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4 text-slate-300 text-sm leading-relaxed">
            <b>Exemplo:</b> ‚ÄúCondutas baseadas em diretrizes internacionais (ACLS/ATLS) e bundles de sepse; adequadas ao protocolo institucional.‚Äù<br><br>
            Se voc√™ quiser, eu posso:
            <ul class="list-disc pl-5 mt-2 space-y-1">
              <li>Transformar esta plataforma em vers√£o com <b>refer√™ncias formais</b> (ABNT/Vancouver) para o seu curso.</li>
              <li>Adicionar <b>protocolos por perfil</b> (enfermeiro, fisio, t√©cnico) com checklists diferentes.</li>
              <li>Adicionar <b>mais 3√ó quest√µes e casos</b> (como voc√™ pediu antes) mantendo rota√ß√£o.</li>
            </ul>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold">‚úÖ Ajuste de escopo (importante)</div>
            <div class="text-slate-300 text-sm mt-1">
              Algumas a√ß√µes variam por servi√ßo (doses, metas, fluxos). O ideal √© voc√™ inserir o protocolo local na aba ‚ÄúModo Professor‚Äù.
            </div>
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üîé Literatura", "Sugest√µes para fundamenta√ß√£o e adapta√ß√£o.", html));
  }

  // ---------- Prof mode ----------
  function renderProf(){
    const html = `
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üßë‚Äçüè´ Modo Professor</div>
          <div class="text-slate-300 mt-2">
            Controle de din√¢mica em sala, impress√£o e personaliza√ß√£o r√°pida.
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">üß© Din√¢mica sugerida (45‚Äì60 min)</div>
              <ol class="mt-2 text-slate-300 text-sm list-decimal pl-5 space-y-1">
                <li>5 min: painel + briefing + pap√©is (l√≠der, via a√©rea, circula√ß√£o, registro).</li>
                <li>10 min: 1 caso cl√≠nico em grupo (registrar 3 prioridades).</li>
                <li>10 min: triagem ABCDE (rodadas r√°pidas).</li>
                <li>10‚Äì15 min: quiz por tema (projetor).</li>
                <li>10 min: j√∫ri cl√≠nico (pro/contra) + decis√£o final.</li>
                <li>Fechamento: revis√£o/feedback e plano de estudo.</li>
              </ol>
            </div>

            <div class="rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
              <div class="font-extrabold">üßæ Protocolo local (anota√ß√µes)</div>
              <div class="text-slate-300 text-sm mt-1">Cole aqui trechos do seu protocolo para lembrar em aula.</div>
              <textarea id="localProtocol" class="mt-2 w-full min-h-[180px] rounded-3xl bg-slate-900/60 border border-slate-700/30 p-4 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-400/30" placeholder="Ex.: Fluxo sepse da institui√ß√£o, metas de SpO‚ÇÇ, doses padr√£o, crit√©rios de UTI..."></textarea>
              <div class="mt-3 flex flex-wrap gap-3">
                <button id="btnSaveProtocol" class="btn-big btn-ok">üíæ Salvar</button>
                <button id="btnLoadProtocol" class="btn-big btn-ghost">‚Ü©Ô∏è Carregar</button>
              </div>
            </div>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold">üß™ Teste r√°pido (funcionamento)</div>
            <div class="text-slate-300 text-sm mt-1">
              Use os bot√µes abaixo para checar se clique/JS est√£o ok no dispositivo do aluno.
            </div>
            <div class="mt-3 flex flex-wrap gap-3">
              <button id="btnTestOk" class="btn-big btn-ok">‚úÖ Bot√£o OK</button>
              <button id="btnTestWarn" class="btn-big btn-warning">‚ö†Ô∏è Bot√£o ALERTA</button>
              <button id="btnTestBad" class="btn-big btn-danger">‚ùå Bot√£o ERRO</button>
            </div>
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4">
            <div class="font-extrabold">üßπ Reset controlado</div>
            <div class="text-slate-300 text-sm mt-1">
              Se voc√™ compartilha o arquivo para turma, o reset apaga somente neste navegador.
            </div>
            <div class="mt-3 flex flex-wrap gap-3">
              <button id="btnResetScoreOnly" class="btn-big btn-warning">‚ôªÔ∏è Reset (score)</button>
              <button id="btnResetAllHard" class="btn-big btn-danger">üß® Reset total</button>
            </div>
          </div>
        </div>

        <div class="rounded-3xl bg-slate-900/60 border border-slate-700/30 p-5">
          <div class="text-2xl font-extrabold">üåê Hospedagem (simples)</div>
          <div class="text-slate-300 mt-2">Op√ß√µes f√°ceis para um arquivo s√≥:</div>

          <div class="mt-4 grid gap-3 text-slate-300 text-sm">
            ${miniNote("1) GitHub Pages","Crie um reposit√≥rio, suba index.html e ative Pages.")}
            ${miniNote("2) Netlify / Vercel","Arraste a pasta com index.html e publique.")}
            ${miniNote("3) Drive/OneDrive (compartilhar)","Funciona como arquivo aberto no navegador, mas prefer√≠vel hospedar para link limpo.")}
          </div>

          <div class="mt-4 rounded-3xl bg-slate-950/40 border border-slate-700/30 p-4 text-slate-300 text-sm leading-relaxed">
            <b>Recomenda√ß√£o:</b> para sala, hospede para gerar um link curto e evitar ‚Äúarquivo local‚Äù.
          </div>

          <div class="mt-4">
            <button id="btnProfPrint" class="btn-big btn-ghost w-full">üñ®Ô∏è Imprimir (revis√£o)</button>
          </div>
        </div>
      </div>
    `;
    viewContainer.appendChild(sectionCard("üßë‚Äçüè´ Professor", "Configura√ß√µes e din√¢mica em sala.", html));

    // protocol save/load
    const PROT_KEY = "emergencia_simulada_local_protocol";
    document.getElementById("btnSaveProtocol").addEventListener("click", ()=>{
      const v = (document.getElementById("localProtocol").value || "").trim();
      localStorage.setItem(PROT_KEY, v);
      toast("ok","Salvo","Protocolo local salvo neste navegador.");
      beep(740, 70);
    });
    document.getElementById("btnLoadProtocol").addEventListener("click", ()=>{
      const v = localStorage.getItem(PROT_KEY) || "";
      document.getElementById("localProtocol").value = v;
      toast("info","Carregado","Protocolo local carregado.");
    });
    document.getElementById("localProtocol").value = localStorage.getItem(PROT_KEY) || "";

    document.getElementById("btnTestOk").addEventListener("click", ()=>{
      popCenter("üò∫","Clique OK","Intera√ß√£o funcionando.", 5000);
      beep(880, 80);
    });
    document.getElementById("btnTestWarn").addEventListener("click", ()=> toast("warn","Teste","Alerta exibido. Bot√µes e JS OK."));
    document.getElementById("btnTestBad").addEventListener("click", ()=> toast("bad","Teste","Erro exibido. Bot√µes e JS OK."));

    document.getElementById("btnResetScoreOnly").addEventListener("click", ()=>{
      appState.score = 0; appState.correct = 0; appState.wrong = 0;
      saveState();
      toast("warn","Reset","Score e contadores zerados (hist√≥rico mantido).");
      go("dashboard");
    });

    document.getElementById("btnResetAllHard").addEventListener("click", ()=>{
      resetProgress();
    });

    document.getElementById("btnProfPrint").addEventListener("click", ()=>{
      go("review");
      setTimeout(()=>window.print(), 350);
    });
  }

  // ---------- Modal ----------
  function openModal(title, subtitle, bodyHtml){
    el("modalTitle").textContent = title;
    el("modalSubtitle").textContent = subtitle || "";
    el("modalBody").innerHTML = bodyHtml || "";
    el("modal").classList.remove("hidden");
    el("modal").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    el("modal").classList.add("hidden");
    el("modal").setAttribute("aria-hidden","true");
  }
  el("modalClose").addEventListener("click", closeModal);
  el("modal").addEventListener("click", (e)=>{
    if(e.target === el("modal").firstElementChild) closeModal();
  });

  // ---------- Sidebar toggles / actions ----------
  el("btnToggleSidebar")?.addEventListener("click", ()=>{
    el("sidebar").classList.toggle("hidden");
  });

  // global reset buttons
  el("btnResetAll")?.addEventListener("click", resetProgress);
  el("btnQuickReset")?.addEventListener("click", resetProgress);

  el("btnChangeName")?.addEventListener("click", ()=>{
    openModal("‚úèÔ∏è Nome do usu√°rio","Digite como aparecer√° no painel.", `
      <div class="space-y-3">
        <input id="nameInput" class="w-full rounded-2xl bg-slate-900/60 border border-slate-700/30 px-4 py-3 font-extrabold" value="${escapeHtml(appState.userName||"Aluno")}"/>
        <button id="btnSaveName" class="btn-big btn-ok w-full">üíæ Salvar</button>
      </div>
    `);
    setTimeout(()=>document.getElementById("nameInput")?.focus(), 50);
    document.getElementById("btnSaveName").addEventListener("click", ()=>{
      const v = (document.getElementById("nameInput").value || "").trim();
      appState.userName = v || "Aluno";
      saveState();
      closeModal();
      toast("ok","Atualizado","Nome salvo.");
    });
  });

  el("btnDailyChallenge")?.addEventListener("click", runDailyChallenge);
  el("btnExportReview")?.addEventListener("click", ()=>{
    go("review");
    toast("info","Revis√£o","Acesse impress√£o ou copie o hist√≥rico para relat√≥rio.");
  });

  el("btnSound")?.addEventListener("click", ()=>{
    appState.sound = !appState.sound;
    saveState();
    toast("info","Som", appState.sound ? "Ativado." : "Desativado.");
    beep(740, 60);
  });

  el("btnTheme")?.addEventListener("click", ()=>{
    appState.focusMode = !appState.focusMode;
    saveState();
    document.body.classList.toggle("bg-slate-950", !appState.focusMode);
    toast("info","Foco", appState.focusMode ? "Modo foco ligado (visual mais limpo)." : "Modo foco desligado.");
  });

  // Nav buttons
  document.querySelectorAll(".navBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> go(btn.dataset.view));
  });

  // Init
  renderScoreWidgets();
  go("dashboard");

})();
</script>
</body>
</html>